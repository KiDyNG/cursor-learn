{
  "name": "Tro ly ke toan",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "prompt",
              "type": "any"
            },
            {
              "name": "type",
              "type": "any"
            },
            {
              "name": "content",
              "type": "any"
            },
            {
              "name": "metadata",
              "type": "any"
            },
            {
              "name": "imageUrl",
              "type": "any"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1344,
        1200
      ],
      "id": "c02c76e8-816d-4a1f-980f-180b8441d158",
      "name": "Trigger t·ª´ Tr·ª£ l√Ω ch√≠nh"
    },
    {
      "parameters": {
        "jsCode": "// Parse input v√† metadata t·ª´ Tr·ª£ l√Ω ch√≠nh\nconst item = $input.all()[0].json;\n\nlet metadata = {};\ntry {\n  metadata = typeof item.metadata === 'string' ? JSON.parse(item.metadata || '{}') : (item.metadata || {});\n} catch (e) {\n  metadata = {};\n}\n\n// L·∫•y text input\nconst inputText = item.input || item.prompt || item.content || '';\n\nreturn [{\n  json: {\n    input: inputText,\n    userId: metadata.userId || metadata.chatId || 'unknown',\n    userName: metadata.userName || 'S·∫øp',\n    chatId: metadata.chatId || '',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        1200
      ],
      "id": "93a976e4-8d98-4998-a815-998c2e812651",
      "name": "Parse Input"
    },
    {
      "parameters": {
        "mode": "combine",
        "fieldsToMatchString": "Load data",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        560,
        1184
      ],
      "id": "44990377-769e-476c-898a-630b76da172c",
      "name": "Merge Data",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// X√¢y d·ª±ng context t·ª´ customer v√† learning memory\nconst items = $input.all();\n\n// L·∫•y d·ªØ li·ªáu t·ª´ c√°c node tr∆∞·ªõc\nconst parseInputResults = $('Parse Input').all();\nconst inputData = (parseInputResults[0] && parseInputResults[0].json) ? parseInputResults[0].json : {};\n\nconst customerResults = $('Load Customer').all();\nconst learningResults = $('Load Learning Memory').all();\n\n// X·ª≠ l√Ω customer data\nlet customerContext = '';\nlet isReturning = false;\nlet customerData = null;\n\nif (customerResults.length > 0 && customerResults[0].json && customerResults[0].json.name) {\n  customerData = customerResults[0].json;\n  isReturning = true;\n  customerContext = `\n## üë§ KH√ÅCH H√ÄNG C≈® - ƒê√É C√ì TRONG H·ªÜ TH·ªêNG\n- T√™n: ${customerData.name || 'Ch∆∞a c√≥'}\n- SƒêT: ${customerData.phone || 'Ch∆∞a c√≥'}\n- ƒê·ªãa ch·ªâ: ${customerData.address || 'Ch∆∞a c√≥'}\n- Email: ${customerData.email || 'Ch∆∞a c√≥'}\n- T·ªïng ƒë∆°n h√†ng: ${customerData.orderCount || 0}\n- T·ªïng chi ti√™u: ${(customerData.totalSpent || 0).toLocaleString('vi-VN')} VNƒê\n\n‚ö†Ô∏è Khi t·∫°o b√°o gi√°, H·ªéI X√ÅC NH·∫¨N th√¥ng tin n√†y v·ªõi s·∫øp tr∆∞·ªõc!`;\n} else {\n  customerContext = '## üë§ KH√ÅCH H√ÄNG M·ªöI - Ch∆∞a c√≥ trong h·ªá th·ªëng\\nC·∫ßn h·ªèi ƒë·∫ßy ƒë·ªß th√¥ng tin khi t·∫°o b√°o gi√°.';\n}\n\n// X·ª≠ l√Ω learning memory\nlet knowledgeList = [];\nlet preferenceList = [];\nlet correctionList = [];\n\nfor (const item of learningResults) {\n  if (item.json && item.json.type) {\n    const mem = item.json;\n    if (mem.type === 'knowledge') {\n      knowledgeList.push('- ' + mem.content);\n    } else if (mem.type === 'preference') {\n      preferenceList.push('- ' + mem.content);\n    } else if (mem.type === 'correction') {\n      correctionList.push('- Sai: \"' + mem.wrong + '\" ‚Üí ƒê√∫ng: \"' + mem.correct + '\"');\n    }\n  }\n}\n\nconst learningContext = `\n## üß† KI·∫æN TH·ª®C ƒê√É H·ªåC T·ª™ S·∫æP\n${knowledgeList.length > 0 ? knowledgeList.join('\\n') : '(Ch∆∞a c√≥)'}\n\n## ‚≠ê S·ªû TH√çCH C·ª¶A S·∫æP\n${preferenceList.length > 0 ? preferenceList.join('\\n') : '(Ch∆∞a bi·∫øt)'}\n\n## ‚úèÔ∏è C√ÅC CH·ªàNH S·ª¨A TR∆Ø·ªöC ƒê√ì\n${correctionList.length > 0 ? correctionList.join('\\n') : '(Ch∆∞a c√≥)'}`;\n\nreturn [{\n  json: {\n    input: inputData.input || '',\n    userId: inputData.userId || '',\n    userName: inputData.userName || '',\n    chatId: inputData.chatId || '',\n    customerContext: customerContext,\n    learningContext: learningContext,\n    isReturningCustomer: isReturning,\n    customerData: customerData,\n    timestamp: inputData.timestamp || ''\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        1184
      ],
      "id": "e479d4c4-354c-4d16-8020-ff68dd1f8c90",
      "name": "Build Context"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        1296,
        1616
      ],
      "id": "511aa20e-c583-47c4-aa9c-cd759c639c73",
      "name": "Calculator"
    },
    {
      "parameters": {
        "description": "S·ª≠ d·ª•ng khi c·∫ßn suy nghƒ© ph·ª©c t·∫°p, kh√¥ng ch·∫Øc ch·∫Øn, ho·∫∑c c·∫ßn ph√¢n t√≠ch nhi·ªÅu th√¥ng tin tr∆∞·ªõc khi tr·∫£ l·ªùi."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        1424,
        1616
      ],
      "id": "0ad38d9a-8b88-4baa-91c4-ede6f31c8f5f",
      "name": "Think"
    },
    {
      "parameters": {
        "jsCode": "// Parse AI Response - Version 2.0 (Fixed nested JSON)\nconst items = $input.all();\nconst result = items[0].json;\nlet output = result.output || '';\nlet actionData = null;\nlet cleanOutput = output;\n\n// H√†m t√¨m JSON object ho√†n ch·ªânh (x·ª≠ l√Ω nested braces)\nfunction extractJSON(str) {\n  const startIdx = str.indexOf('{');\n  if (startIdx === -1) return null;\n  \n  let braceCount = 0;\n  let endIdx = -1;\n  \n  for (let i = startIdx; i < str.length; i++) {\n    if (str[i] === '{') braceCount++;\n    if (str[i] === '}') braceCount--;\n    if (braceCount === 0) {\n      endIdx = i + 1;\n      break;\n    }\n  }\n  \n  if (endIdx === -1) return null;\n  return str.substring(startIdx, endIdx);\n}\n\n// 1. Th·ª≠ t√¨m trong code block ```json ... ```\nconst codeBlockMatch = output.match(/```json\\s*([\\s\\S]*?)\\s*```/i);\nif (codeBlockMatch) {\n  try {\n    const jsonStr = codeBlockMatch[1].trim();\n    actionData = JSON.parse(jsonStr);\n    cleanOutput = output.replace(codeBlockMatch[0], '').trim();\n  } catch (e) {\n    console.log('Code block parse error:', e.message);\n  }\n}\n\n// 2. Th·ª≠ t√¨m trong code block ``` ... ```\nif (!actionData) {\n  const genericBlockMatch = output.match(/```\\s*([\\s\\S]*?)\\s*```/i);\n  if (genericBlockMatch) {\n    try {\n      const jsonStr = genericBlockMatch[1].trim();\n      if (jsonStr.startsWith('{')) {\n        actionData = JSON.parse(jsonStr);\n        cleanOutput = output.replace(genericBlockMatch[0], '').trim();\n      }\n    } catch (e) {\n      console.log('Generic block parse error:', e.message);\n    }\n  }\n}\n\n// 3. T√¨m JSON object tr·ª±c ti·∫øp (kh√¥ng c√≥ code block)\nif (!actionData && output.includes('\"action\"')) {\n  try {\n    const jsonStr = extractJSON(output);\n    if (jsonStr) {\n      actionData = JSON.parse(jsonStr);\n      cleanOutput = output.replace(jsonStr, '').trim();\n    }\n  } catch (e) {\n    console.log('Direct JSON parse error:', e.message);\n  }\n}\n\n// Clean output\ncleanOutput = cleanOutput\n  .replace(/```json/gi, '')\n  .replace(/```/g, '')\n  .replace(/[\\*#]/g, '')\n  .trim();\n\n// X√°c ƒë·ªãnh action type\nlet actionType = 'text_only';\nif (actionData && actionData.action) {\n  actionType = actionData.action;\n}\n\n// Debug log\nconsole.log('Raw Output:', output.substring(0, 500));\nconsole.log('Action Type:', actionType);\nconsole.log('Action Data:', actionData ? 'Found' : 'Not found');\n\n// L·∫•y context\nlet buildContext = {};\ntry {\n  buildContext = $('Build Context').first().json || {};\n} catch (e) {\n  buildContext = {};\n}\n\nreturn [{\n  json: {\n    output: cleanOutput || 'ƒê√£ nh·∫≠n l·ªánh.',\n    actionType: actionType,\n    actionData: actionData,\n    userId: buildContext.userId || '',\n    sessionId: buildContext.sessionId || '',\n    userInput: buildContext.input || '',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1584,
        1184
      ],
      "id": "78d2202c-e213-4c80-bd06-50ad83820145",
      "name": "Parse Response"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Parse Response').item.json.actionType }}",
                    "rightValue": "create_quote",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8f75d914-922c-44ea-aa49-d23de51a7983"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Create Quote"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Parse Response').item.json.actionType }}",
                    "rightValue": "learn",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9a6bf5f9-72cd-4405-8951-849de960a87f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Learn"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Parse Response').item.json.actionType }}",
                    "rightValue": "save_customer",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c31cd3af-ff4b-41f9-9293-1cb9e94ff387"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Save Customer"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "43695656-8aee-4cca-aaeb-1f261f2a13f1",
                    "leftValue": "",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2064,
        1152
      ],
      "id": "4154a581-da73-489d-a843-147488e19d06",
      "name": "Route by Action"
    },
    {
      "parameters": {
        "jsCode": "// Code cho node \"Generate HTML Quote\" trong n8n\n// Version 3.0 - H·ªó tr·ª£ c·∫£ 2 format data (items v√† products)\n// FIXED VERSION - L·∫•y tr·ª±c ti·∫øp t·ª´ Parse Response\nconst parseResponseData = $('Parse Response').first().json;\nconst actionData = parseResponseData.actionData;\nconst data = actionData?.data || {};\n\nconsole.log('=== GENERATE HTML DEBUG ===');\nconsole.log('Items count:', (data.items || data.products || []).length);\nconsole.log('First item:', (data.items || data.products || [])[0]);\n\n// T·∫°o s·ªë b√°o gi√°\nconst quoteNumber = `BG-${new Date().toISOString().slice(0,10).replace(/-/g, '')}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;\nconst now = new Date();\nconst quoteDate = `${now.getDate().toString().padStart(2, '0')}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;\nconst dueDate = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);\nconst dueDateStr = `${dueDate.getDate().toString().padStart(2, '0')}/${(dueDate.getMonth() + 1).toString().padStart(2, '0')}/${dueDate.getFullYear()}`;\n\n// Format s·ªë ti·ªÅn\nfunction formatMoney(num) {\n  if (!num) return '0';\n  return Math.round(num).toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, '.');\n}\n\n// Parse k√≠ch th∆∞·ªõc t·ª´ string \"2000 x 2600 x 600 mm\" th√†nh object\nfunction parseSize(sizeStr) {\n  if (!sizeStr) return { length: '', height: '', depth: '' };\n  const parts = sizeStr.replace(/mm/gi, '').trim().split(/\\s*x\\s*/i);\n  return {\n    length: parts[0] || '',\n    height: parts[1] || '',\n    depth: parts[2] || ''\n  };\n}\n\n// ============ H·ªñ TR·ª¢ C·∫¢ 2 FORMAT ============\n\n// L·∫•y items - h·ªó tr·ª£ c·∫£ \"items\" (c≈©) v√† \"products\" (m·ªõi t·ª´ AI)\nlet items = data.items || data.products || [];\n\n// Map l·∫°i n·∫øu l√† format products t·ª´ AI\nif (data.products && data.products.length > 0) {\n  items = data.products.map(p => ({\n    name: p.product_name || p.name || '',\n    size: p.size || p.dimensions || p.kich_thuoc || '',\n    material: p.material || p.vat_lieu || '',\n    quantity: p.quantity || p.so_luong || 1,\n    // T√≠nh unitPrice = price_before_vat / quantity\n    unitPrice: p.price_before_vat && p.quantity ? Math.round(p.price_before_vat / p.quantity) : (p.unitPrice || p.unit_price || 0),\n    // amount = total_price_with_vat ho·∫∑c price_before_vat\n    amount: p.total_price_with_vat || p.price_before_vat || p.amount || 0,\n    note: p.notes || p.note || p.material || p.vat_lieu || ''\n  }));\n}\n\n// L·∫•y th√¥ng tin t·ªïng - h·ªó tr·ª£ c·∫£ 2 format\nconst summary = data.summary || {};\nconst customerInfo = data.customer_info || {};\n\nconst subtotal = data.subtotal || summary.total_direct_cost_all_products || 0;\nconst profitPercent = data.profitPercent || 25;\nconst profit = data.profit || summary.total_profit_all_products || 0;\nconst priceBeforeVAT = data.priceBeforeVAT || summary.total_price_before_vat_all_products || 0;\nconst vat = data.vat || summary.total_vat_all_products || 0;\nconst totalAmount = data.totalAmount || summary.grand_total_with_vat || 0;\n\n// Th√¥ng tin kh√°ch h√†ng\nconst customerName = data.customerName || customerInfo.name || 'Qu√Ω kh√°ch h√†ng';\nconst customerPhone = data.customerPhone || customerInfo.phone || 'Ch∆∞a cung c·∫•p';\nconst customerAddress = data.customerAddress || customerInfo.address || 'Ch∆∞a cung c·∫•p';\n\n// ============ T·∫†O HTML ============\n\n// T·∫°o rows cho items\nlet itemsHtml = '';\nlet itemIndex = 0;\n\nfor (const product of items) {\n  itemIndex++;\n  const size = parseSize(product.size);\n  const unit = product.unit || 'C√°i';\n  const quantity = product.quantity || 1;\n  const note = product.note || product.material || '';\n  \n  itemsHtml += `\n        <tr>\n          <td class=\"center\">${itemIndex}</td>\n          <td class=\"left product-name\">${product.name || ''}</td>\n          <td class=\"center\">${size.length}</td>\n          <td class=\"center\">${size.height}</td>\n          <td class=\"center\">${size.depth}</td>\n          <td class=\"center\">${unit}</td>\n          <td class=\"center\">${quantity}</td>\n          <td class=\"right\">${formatMoney(product.unitPrice)}</td>\n          <td class=\"right amount\">${formatMoney(product.amount)}</td>\n          <td class=\"left note\">${note}</td>\n        </tr>`;\n}\n\nconst html = `<!DOCTYPE html>\n<html lang=\"vi\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>B√°o gi√° ${quoteNumber}</title>\n  <style>\n    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');\n    \n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    \n    body {\n      font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;\n      font-size: 11pt;\n      line-height: 1.5;\n      color: #333;\n      background: #fff;\n      padding: 20px;\n    }\n    \n    .quote-container { max-width: 900px; margin: 0 auto; background: #fff; }\n    \n    .header {\n      background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%);\n      color: white;\n      padding: 25px 30px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n    }\n    \n    .logo-section { display: flex; align-items: center; gap: 15px; }\n    \n    .logo {\n      width: 70px; height: 70px;\n      background: white; border-radius: 10px;\n      display: flex; align-items: center; justify-content: center;\n      font-weight: 700; font-size: 10pt; color: #1a237e;\n      text-align: center; line-height: 1.2;\n    }\n    \n    .company-name { font-size: 22pt; font-weight: 700; letter-spacing: 1px; }\n    .company-slogan { font-size: 10pt; opacity: 0.9; margin-top: 3px; }\n    .quote-title { text-align: right; }\n    .quote-title h1 { font-size: 26pt; font-weight: 700; letter-spacing: 2px; }\n    .quote-number { font-size: 11pt; opacity: 0.9; margin-top: 5px; }\n    \n    .info-bar {\n      background: #e8eaf6;\n      padding: 15px 30px;\n      display: flex;\n      justify-content: space-between;\n      border-bottom: 3px solid #3949ab;\n    }\n    \n    .info-item { text-align: center; }\n    .info-label { font-size: 9pt; color: #666; text-transform: uppercase; letter-spacing: 1px; }\n    .info-value { font-size: 11pt; font-weight: 600; color: #1a237e; margin-top: 3px; }\n    \n    .content { padding: 25px 30px; }\n    .info-grid { display: flex; gap: 30px; margin-bottom: 25px; }\n    \n    .info-box {\n      flex: 1; background: #fafafa; border-radius: 8px;\n      padding: 18px; border-left: 4px solid #3949ab;\n    }\n    .info-box.customer { border-left-color: #43a047; }\n    .info-box h3 {\n      font-size: 10pt; text-transform: uppercase; letter-spacing: 1px;\n      color: #666; margin-bottom: 12px; padding-bottom: 8px;\n      border-bottom: 1px dashed #ddd;\n    }\n    .info-box p { margin: 6px 0; font-size: 10.5pt; }\n    .info-box strong { color: #333; min-width: 90px; display: inline-block; }\n    .highlight-name { font-size: 13pt; font-weight: 600; color: #1a237e; }\n    \n    .table-section { margin-bottom: 25px; }\n    .section-title {\n      background: linear-gradient(90deg, #43a047, #66bb6a);\n      color: white; padding: 10px 15px; font-size: 11pt;\n      font-weight: 600; text-transform: uppercase;\n      letter-spacing: 1px; border-radius: 5px 5px 0 0;\n    }\n    \n    table { width: 100%; border-collapse: collapse; font-size: 10pt; }\n    thead th {\n      background: #37474f; color: white; padding: 12px 8px;\n      font-weight: 500; text-transform: uppercase;\n      font-size: 9pt; letter-spacing: 0.5px;\n    }\n    thead th.size-group { background: #455a64; }\n    tbody tr { border-bottom: 1px solid #e0e0e0; }\n    tbody tr:nth-child(even) { background: #fafafa; }\n    tbody td { padding: 12px 8px; }\n    \n    .center { text-align: center; }\n    .left { text-align: left; }\n    .right { text-align: right; }\n    .product-name { font-weight: 500; color: #1a237e; }\n    .amount { font-weight: 600; color: #c62828; }\n    .note { font-size: 9pt; color: #666; max-width: 150px; }\n    \n    .total-row { background: linear-gradient(90deg, #fff8e1, #ffecb3) !important; }\n    .total-row td { font-weight: 700; font-size: 11pt; padding: 15px 8px; }\n    .total-row .amount { color: #c62828; font-size: 13pt; }\n    \n    .summary-section { display: flex; justify-content: flex-end; margin-bottom: 25px; }\n    .summary-box {\n      width: 350px; background: #fafafa; border-radius: 8px;\n      overflow: hidden; border: 1px solid #e0e0e0;\n    }\n    .summary-row {\n      display: flex; justify-content: space-between;\n      padding: 12px 18px; border-bottom: 1px solid #e0e0e0;\n    }\n    .summary-row:last-child { border-bottom: none; }\n    .summary-label { color: #666; }\n    .summary-value { font-weight: 600; color: #333; }\n    .summary-row.grand-total {\n      background: linear-gradient(90deg, #c62828, #e53935);\n      color: white; padding: 15px 18px;\n    }\n    .summary-row.grand-total .summary-label { color: white; font-weight: 600; font-size: 12pt; }\n    .summary-row.grand-total .summary-value { color: white; font-size: 16pt; font-weight: 700; }\n    \n    .notes-section {\n      background: #fff3e0; border-radius: 8px; padding: 18px;\n      margin-bottom: 25px; border-left: 4px solid #ff9800;\n    }\n    .notes-section h4 { color: #e65100; font-size: 11pt; margin-bottom: 12px; }\n    .notes-section ul { margin-left: 20px; color: #666; }\n    .notes-section li { margin: 6px 0; font-size: 10pt; }\n    \n    .bank-section {\n      background: #e3f2fd; border-radius: 8px; padding: 18px;\n      margin-bottom: 25px; border-left: 4px solid #1976d2;\n    }\n    .bank-section h4 { color: #1565c0; font-size: 11pt; margin-bottom: 12px; }\n    .bank-info p { margin: 5px 0; font-size: 10.5pt; }\n    .bank-info strong { min-width: 120px; display: inline-block; }\n    \n    .signatures {\n      display: flex; justify-content: space-between;\n      margin-top: 30px; padding-top: 20px;\n      border-top: 2px dashed #e0e0e0;\n    }\n    .signature-block { width: 45%; text-align: center; }\n    .signature-date { font-style: italic; color: #666; font-size: 10pt; margin-bottom: 8px; }\n    .signature-title { font-weight: 700; color: #1a237e; text-transform: uppercase; font-size: 11pt; margin-bottom: 5px; }\n    .signature-note { font-size: 9pt; color: #999; }\n    .signature-space { height: 70px; margin: 10px 0; }\n    .signature-name { font-weight: 600; color: #333; min-height: 20px; }\n    \n    .footer {\n      background: #37474f; color: white; padding: 15px 30px;\n      text-align: center; font-size: 9pt;\n    }\n    .footer p { margin: 3px 0; opacity: 0.9; }\n    .footer .highlight { color: #ffeb3b; font-weight: 600; }\n  </style>\n</head>\n<body>\n  <div class=\"quote-container\">\n    <div class=\"header\">\n      <div class=\"logo-section\">\n        <div class=\"logo\">MINH<br>KHOA</div>\n        <div>\n          <div class=\"company-name\">N·ªòI TH·∫§T MINHKHOA</div>\n          <div class=\"company-slogan\">Chuy√™n ƒë·ªì g·ªó n·ªôi th·∫•t cao c·∫•p</div>\n        </div>\n      </div>\n      <div class=\"quote-title\">\n        <h1>B√ÅO GI√Å</h1>\n        <div class=\"quote-number\">S·ªë: ${quoteNumber}</div>\n      </div>\n    </div>\n    \n    <div class=\"info-bar\">\n      <div class=\"info-item\">\n        <div class=\"info-label\">Ng√†y l·∫≠p</div>\n        <div class=\"info-value\">${quoteDate}</div>\n      </div>\n      <div class=\"info-item\">\n        <div class=\"info-label\">Hi·ªáu l·ª±c ƒë·∫øn</div>\n        <div class=\"info-value\">${dueDateStr}</div>\n      </div>\n      <div class=\"info-item\">\n        <div class=\"info-label\">Tr·∫°ng th√°i</div>\n        <div class=\"info-value\" style=\"color: #ff9800;\">Ch·ªù x√°c nh·∫≠n</div>\n      </div>\n      <div class=\"info-item\">\n        <div class=\"info-label\">Ng∆∞·ªùi l·∫≠p</div>\n        <div class=\"info-value\">B·ªô ph·∫≠n Kinh doanh</div>\n      </div>\n    </div>\n    \n    <div class=\"content\">\n      <div class=\"info-grid\">\n        <div class=\"info-box customer\">\n          <h3>Th√¥ng tin kh√°ch h√†ng</h3>\n          <p class=\"highlight-name\">${customerName}</p>\n          <p><strong>ƒêi·ªán tho·∫°i:</strong> ${customerPhone}</p>\n          <p><strong>ƒê·ªãa ch·ªâ:</strong> ${customerAddress}</p>\n        </div>\n        <div class=\"info-box\">\n          <h3>Th√¥ng tin x∆∞·ªüng</h3>\n          <p><strong>X∆∞·ªüng SX:</strong> Th√¥n Me T√°o, D∆∞∆°ng H√≤a, Ho√†i ƒê·ª©c, H√† N·ªôi</p>\n          <p><strong>Hotline:</strong> 0987 654 321</p>\n          <p><strong>Email:</strong> contact@minhkhoa.vn</p>\n        </div>\n      </div>\n      \n      <div class=\"table-section\">\n        <div class=\"section-title\">Chi ti·∫øt s·∫£n ph·∫©m</div>\n        <table>\n          <thead>\n            <tr>\n              <th rowspan=\"2\" style=\"width: 40px;\">STT</th>\n              <th rowspan=\"2\" style=\"width: 160px;\">T√™n s·∫£n ph·∫©m</th>\n              <th colspan=\"3\" class=\"size-group\" style=\"width: 150px;\">Quy c√°ch (mm)</th>\n              <th rowspan=\"2\" style=\"width: 45px;\">ƒêVT</th>\n              <th rowspan=\"2\" style=\"width: 40px;\">SL</th>\n              <th rowspan=\"2\" style=\"width: 90px;\">ƒê∆°n gi√°</th>\n              <th rowspan=\"2\" style=\"width: 100px;\">Th√†nh ti·ªÅn</th>\n              <th rowspan=\"2\" style=\"width: 140px;\">Ghi ch√∫</th>\n            </tr>\n            <tr>\n              <th class=\"size-group\" style=\"width: 50px;\">D√ÄI</th>\n              <th class=\"size-group\" style=\"width: 50px;\">CAO</th>\n              <th class=\"size-group\" style=\"width: 50px;\">S√ÇU</th>\n            </tr>\n          </thead>\n          <tbody>\n            ${itemsHtml}\n            <tr class=\"total-row\">\n              <td colspan=\"8\" class=\"center\">T·ªîNG C·ªòNG S·∫¢N PH·∫®M</td>\n              <td class=\"right amount\">${formatMoney(subtotal)}</td>\n              <td></td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n      \n      <div class=\"summary-section\">\n        <div class=\"summary-box\">\n          <div class=\"summary-row\">\n            <span class=\"summary-label\">Chi ph√≠ s·∫£n xu·∫•t:</span>\n            <span class=\"summary-value\">${formatMoney(subtotal)} ‚Ç´</span>\n          </div>\n          <div class=\"summary-row\">\n            <span class=\"summary-label\">L·ª£i nhu·∫≠n (${profitPercent}%):</span>\n            <span class=\"summary-value\">${formatMoney(profit)} ‚Ç´</span>\n          </div>\n          <div class=\"summary-row\">\n            <span class=\"summary-label\">Gi√° tr∆∞·ªõc VAT:</span>\n            <span class=\"summary-value\">${formatMoney(priceBeforeVAT)} ‚Ç´</span>\n          </div>\n          <div class=\"summary-row\">\n            <span class=\"summary-label\">VAT (10%):</span>\n            <span class=\"summary-value\">${formatMoney(vat)} ‚Ç´</span>\n          </div>\n          <div class=\"summary-row grand-total\">\n            <span class=\"summary-label\">T·ªîNG THANH TO√ÅN:</span>\n            <span class=\"summary-value\">${formatMoney(totalAmount)} ‚Ç´</span>\n          </div>\n        </div>\n      </div>\n      \n      <div class=\"bank-section\">\n        <h4>Th√¥ng tin thanh to√°n</h4>\n        <div class=\"bank-info\">\n          <p><strong>Ng√¢n h√†ng:</strong> Vietcombank - Chi nh√°nh H√† N·ªôi</p>\n          <p><strong>S·ªë t√†i kho·∫£n:</strong> 0123 456 789</p>\n          <p><strong>Ch·ªß t√†i kho·∫£n:</strong> NGUY·ªÑN TI·∫æN BI√äN</p>\n          <p><strong>N·ªôi dung CK:</strong> ${quoteNumber} - ${customerName}</p>\n        </div>\n      </div>\n      \n      <div class=\"notes-section\">\n        <h4>ƒêi·ªÅu kho·∫£n & Ghi ch√∫</h4>\n        <ul>\n          <li><strong>Hi·ªáu l·ª±c:</strong> B√°o gi√° c√≥ hi·ªáu l·ª±c trong v√≤ng 7 ng√†y k·ªÉ t·ª´ ng√†y l·∫≠p</li>\n          <li><strong>Thanh to√°n:</strong> ƒê·∫∑t c·ªçc 50% khi k√Ω h·ª£p ƒë·ªìng, 50% c√≤n l·∫°i khi giao h√†ng</li>\n          <li><strong>Th·ªùi gian SX:</strong> 15-20 ng√†y l√†m vi·ªác k·ªÉ t·ª´ khi nh·∫≠n ƒë·ªß c·ªçc</li>\n          <li><strong>V·∫≠n chuy·ªÉn:</strong> Mi·ªÖn ph√≠ n·ªôi th√†nh H√† N·ªôi, ngo·∫°i t·ªânh t√≠nh ph√≠ theo km</li>\n          <li><strong>B·∫£o h√†nh:</strong> 12 th√°ng ƒë·ªëi v·ªõi l·ªói k·ªπ thu·∫≠t t·ª´ nh√† s·∫£n xu·∫•t</li>\n          <li><strong>L·∫Øp ƒë·∫∑t:</strong> Mi·ªÖn ph√≠ l·∫Øp ƒë·∫∑t t·∫°i nh√† kh√°ch h√†ng</li>\n        </ul>\n      </div>\n      \n      <div class=\"signatures\">\n        <div class=\"signature-block\">\n          <div class=\"signature-title\">Kh√°ch h√†ng</div>\n          <div class=\"signature-note\">(K√Ω, ghi r√µ h·ªç t√™n)</div>\n          <div class=\"signature-space\"></div>\n          <div class=\"signature-name\">${customerName}</div>\n        </div>\n        <div class=\"signature-block\">\n          <div class=\"signature-date\">H√† N·ªôi, ng√†y ${quoteDate}</div>\n          <div class=\"signature-title\">ƒê·∫°i di·ªán x∆∞·ªüng</div>\n          <div class=\"signature-note\">(K√Ω, ghi r√µ h·ªç t√™n)</div>\n          <div class=\"signature-space\"></div>\n          <div class=\"signature-name\">Nguy·ªÖn Ti·∫øn Bi√™n</div>\n        </div>\n      </div>\n    </div>\n    \n    <div class=\"footer\">\n      <p><span class=\"highlight\">N·ªòI TH·∫§T MINHKHOA</span> - Uy t√≠n t·∫°o n√™n th∆∞∆°ng hi·ªáu</p>\n      <p>ƒê·ªãa ch·ªâ: Th√¥n Me T√°o, x√£ D∆∞∆°ng H√≤a, huy·ªán Ho√†i ƒê·ª©c, H√† N·ªôi | Hotline: 0987 654 321</p>\n      <p>Website: www.minhkhoa.vn | Email: contact@minhkhoa.vn</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nreturn [{\n  json: {\n    ...item,\n    html: html,\n    quoteNumber: quoteNumber,\n    quoteDate: quoteDate,\n    quoteData: {\n      customerName,\n      customerPhone,\n      customerAddress,\n      items,\n      subtotal,\n      profit,\n      priceBeforeVAT,\n      vat,\n      totalAmount\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2336,
        992
      ],
      "id": "49b9f479-9f04-4199-88ee-bd8fa7c115ce",
      "name": "Generate HTML Quote"
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "quote_history",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        3344,
        992
      ],
      "id": "379a6e88-37a7-4ea9-82b7-ec56f7c88c60",
      "name": "Save Quote to MongoDB",
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1ZH2m2ilxfmOsL2nHvX7eN7LVcbIAbjWerXziqFem094",
          "mode": "list",
          "cachedResultName": "Agent ke toan Log",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1ZH2m2ilxfmOsL2nHvX7eN7LVcbIAbjWerXziqFem094/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1928603486,
          "mode": "list",
          "cachedResultName": "Lich_su_bao_gia",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1ZH2m2ilxfmOsL2nHvX7eN7LVcbIAbjWerXziqFem094/edit#gid=1928603486"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "M√£ b√°o gi√°": "={{ $('Generate HTML Quote').item.json.quoteNumber }}",
            "Ng√†y t·∫°o": "={{ $now.format('dd/MM/yyyy HH:mm') }}",
            "Kh√°ch h√†ng": "={{ $('Generate HTML Quote').item.json.quoteData.customerName }}",
            "SƒêT": "={{ $('Generate HTML Quote').item.json.quoteData.customerPhone }}",
            "ƒê·ªãa ch·ªâ": "={{ $('Generate HTML Quote').item.json.quoteData.customerAddress }}",
            "S·∫£n ph·∫©m": "={{ $('Generate HTML Quote').item.json.quoteData.items.map(i => i.name + ' x' + i.quantity).join(', ') }}",
            "T·ªïng ti·ªÅn": "={{ $('Generate HTML Quote').item.json.quoteData.totalAmount }}",
            "Tr·∫°ng th√°i": "Ch·ªù x√°c nh·∫≠n",
            "Ng∆∞·ªùi t·∫°o": "={{ $('Generate HTML Quote').item.json.userName }}",
            "Ghi ch√∫": ""
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "M√£ b√°o gi√°",
              "displayName": "M√£ b√°o gi√°",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Ng√†y t·∫°o",
              "displayName": "Ng√†y t·∫°o",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Kh√°ch h√†ng",
              "displayName": "Kh√°ch h√†ng",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "SƒêT",
              "displayName": "SƒêT",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ƒê·ªãa ch·ªâ",
              "displayName": "ƒê·ªãa ch·ªâ",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "S·∫£n ph·∫©m",
              "displayName": "S·∫£n ph·∫©m",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "T·ªïng ti·ªÅn",
              "displayName": "T·ªïng ti·ªÅn",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Tr·∫°ng th√°i",
              "displayName": "Tr·∫°ng th√°i",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Ng∆∞·ªùi t·∫°o",
              "displayName": "Ng∆∞·ªùi t·∫°o",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Ghi ch√∫",
              "displayName": "Ghi ch√∫",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3536,
        992
      ],
      "id": "e01b2b32-539d-4784-913c-fd0eaadd0637",
      "name": "Save Quote to Sheets",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "k9q7ceY6SMWzzelv",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "learning_memory",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        2336,
        1168
      ],
      "id": "98d66d7d-d158-4bc8-944c-6e4b1d861ba9",
      "name": "Save Learning",
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "customer_memory",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        2336,
        1344
      ],
      "id": "0403f280-8d17-43a7-a369-b5c693917513",
      "name": "Save Customer",
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "numberInputs": 5
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4400,
        1152
      ],
      "id": "7c42bdaf-84f9-40d7-ba18-5fe7f230092a",
      "name": "Merge All Paths"
    },
    {
      "parameters": {
        "jsCode": "// Final Output - X·ª≠ l√Ω text v√† g·ªôp link PDF/Image\nconst items = $input.all();\nconst item = items[0]?.json || {};\n\n// L·∫•y output text\nlet output = '';\ntry {\n  output = item.output || $('Parse Response').first().json.output || '';\n} catch (e) {\n  output = item.output || '';\n}\n\n// L·∫•y th√¥ng tin kh√°c\nconst imageUrl = item.imageUrl || '';\nconst pdfUrl = item.pdfUrl || '';\nconst quoteNumber = item.quoteNumber || '';\n\n// X·ª≠ l√Ω final text\nlet finalText = output;\n\n// N·∫øu c√≥ b√°o gi√° (c√≥ ·∫£nh ho·∫∑c PDF), ch·ªâ g·ª≠i t√≥m t·∫Øt ng·∫Øn\nif (imageUrl || pdfUrl) {\n  // T√¨m d√≤ng t·ªïng c·ªông ho·∫∑c t√≥m t·∫Øt\n  const lines = output.split('\\n');\n  let summary = '';\n  \n  // L·∫•y 5 d√≤ng ƒë·∫ßu + d√≤ng t·ªïng c·ªông\n  const firstLines = lines.slice(0, 5).join('\\n');\n  const totalLine = lines.find(l => l.includes('T·ªïng c·ªông') || l.includes('T·ªîNG C·ªòNG') || l.includes('t·ªïng c·ªông'));\n  \n  if (totalLine) {\n    summary = firstLines + '\\n\\n...\\n\\n' + totalLine;\n  } else {\n    summary = firstLines + '\\n\\n(Xem chi ti·∫øt trong ·∫£nh/PDF)';\n  }\n  \n  // Th√™m link PDF\n  if (pdfUrl) {\n    summary += '\\n\\nüìÑ T·∫£i PDF: ' + pdfUrl;\n  }\n  \n  finalText = summary;\n} else if (output.length > 1900) {\n  // Kh√¥ng c√≥ b√°o gi√°, ch·ªâ c·∫Øt ng·∫Øn\n  finalText = output.substring(0, 1900) + '...';\n}\n\nreturn [{\n  json: {\n    output: finalText,\n    quoteNumber: quoteNumber,\n    imageUrl: imageUrl,\n    pdfUrl: pdfUrl,\n    hasImage: !!imageUrl,\n    hasPDF: !!pdfUrl\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4592,
        1200
      ],
      "id": "e4cc3050-d094-4faf-ab07-c3110fe83113",
      "name": "Final Output"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Tra c·ª©u danh s√°ch S·∫¢N PH·∫®M n·ªôi th·∫•t.",
        "documentId": {
          "__rl": true,
          "value": "1gDaQ10mKcENYFZPkxrILvSX0lEDS30V32i6J5agsmOE",
          "mode": "list",
          "cachedResultName": "San pham",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1gDaQ10mKcENYFZPkxrILvSX0lEDS30V32i6J5agsmOE/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 985133818,
          "mode": "list",
          "cachedResultName": "San_pham_updated (1)",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1gDaQ10mKcENYFZPkxrILvSX0lEDS30V32i6J5agsmOE/edit#gid=985133818"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        896,
        1616
      ],
      "id": "5ef8077b-61d4-43fe-8bd9-731dd53f998e",
      "name": "San pham",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "k9q7ceY6SMWzzelv",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Tra c·ª©u danh s√°ch V·∫¨T LI·ªÜU v√† ƒê∆†N GI√Å.",
        "documentId": {
          "__rl": true,
          "value": "1xajQJ0y-v0pSRW4lQsV6R8W1whVufUqt6B5sbIhmrXQ",
          "mode": "list",
          "cachedResultName": "Vat lieu",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1xajQJ0y-v0pSRW4lQsV6R8W1whVufUqt6B5sbIhmrXQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 240216695,
          "mode": "list",
          "cachedResultName": "Vat_lieu_updated",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1xajQJ0y-v0pSRW4lQsV6R8W1whVufUqt6B5sbIhmrXQ/edit#gid=240216695"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        1024,
        1616
      ],
      "id": "3d78bd7d-b4e9-4144-824e-65d2cdc8dfbc",
      "name": "Vat lieu",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "k9q7ceY6SMWzzelv",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Ki·ªÉm tra T·ªíN KHO v·∫≠t li·ªáu.",
        "documentId": {
          "__rl": true,
          "value": "1z4PqH5aF-LKz84jalhWamTRG7OnW_MUkV3YWQlaFOUY",
          "mode": "list",
          "cachedResultName": "Ton kho",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1z4PqH5aF-LKz84jalhWamTRG7OnW_MUkV3YWQlaFOUY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1662890050,
          "mode": "list",
          "cachedResultName": "Ton_kho",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1z4PqH5aF-LKz84jalhWamTRG7OnW_MUkV3YWQlaFOUY/edit#gid=1662890050"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        1168,
        1616
      ],
      "id": "14f6987e-5d45-477e-a8dd-e77b0f69aad6",
      "name": "Ton kho",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "k9q7ceY6SMWzzelv",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.input }}",
        "options": {
          "systemMessage": "# ‚ö†Ô∏è QUY T·∫ÆC B·∫ÆT BU·ªòC - ƒê·ªåC TR∆Ø·ªöC KHI TR·∫¢ L·ªúI\n\n## QUAN TR·ªåNG NH·∫§T: KHI T·∫†O B√ÅO GI√Å\nKhi s·∫øp y√™u c·∫ßu \"t·∫°o b√°o gi√°\", \"l·∫≠p b√°o gi√°\", \"t·∫°o l·∫°i b√°o gi√°\", \"l√†m b√°o gi√°\", \"b√°o gi√° cho kh√°ch\", \"t√≠nh gi√°\", \"l√™n ƒë∆°n\":\n‚Üí PH·∫¢I tr·∫£ v·ªÅ JSON `create_quote` ·ªü cu·ªëi response\n‚Üí KH√îNG ƒê∆Ø·ª¢C ch·ªâ tr·∫£ l·ªùi text m√¥ t·∫£ m√† thi·∫øu JSON\n‚Üí N·∫øu thi·∫øu JSON ‚Üí File b√°o gi√° KH√îNG ƒë∆∞·ª£c t·∫°o!\n\n---\n\n# OVERVIEW\nB·∫°n l√† Tr·ª£ l√Ω K·∫ø to√°n chuy√™n tr√°ch c·ªßa x∆∞·ªüng n·ªôi th·∫•t MinhKhoa.\n\n# CONTEXT\n{{ $json.customerContext }}\n{{ $json.learningContext }}\n\n# TOOLS & RULES\n1. Calculator: B·∫ÆT BU·ªòC d√πng ƒë·ªÉ t√≠nh to√°n m·ªçi con s·ªë. KH√îNG t√≠nh nh·∫©m.\n2. Tra c·ª©u: D√πng tools (San pham, Vat lieu, Ton kho) ƒë·ªÉ l·∫•y d·ªØ li·ªáu.\n\n# OUTPUT FORMAT\n1. L·ªùi tho·∫°i:\n   - Text thu·∫ßn, KH√îNG d√πng markdown (**, ##, ```)\n   - X∆∞ng h√¥: \"em\" - \"s·∫øp\"\n   - S·ªë ti·ªÅn: d·∫•u ch·∫•m ph√¢n c√°ch (1.500.000 VNƒê)\n\n2. JSON Action: ƒê·∫∑t ·ªü CU·ªêI C√ôNG response khi c·∫ßn h√†nh ƒë·ªông\n\n---\n\n# ACTION SCENARIOS\n\n## 1. T·∫†O B√ÅO GI√Å M·ªöI\nT·ª´ kh√≥a: \"t·∫°o b√°o gi√°\", \"l·∫≠p b√°o gi√°\", \"t·∫°o l·∫°i\", \"l√†m b√°o gi√°\", \"b√°o gi√° cho\", \"t√≠nh gi√°\", \"l√™n ƒë∆°n\"\n\nQuy tr√¨nh:\n1. D√πng Calculator t√≠nh to√°n\n2. Tr·∫£ l·ªùi ng·∫Øn: \"D·∫°, em ƒë√£ t√≠nh xong b√°o gi√° cho [T√™n kh√°ch]. T·ªïng c·ªông: X VNƒê\"\n3. ƒê√çNH K√àM JSON (B·∫ÆT BU·ªòC):\n\n```json\n{\n  \"action\": \"create_quote\",\n  \"data\": {\n    \"customerName\": \"T√™n kh√°ch\",\n    \"customerPhone\": \"SƒêT\",\n    \"customerAddress\": \"ƒê·ªãa ch·ªâ\",\n    \"items\": [\n      {\n        \"name\": \"T√™n s·∫£n ph·∫©m\",\n        \"size\": \"1800 x 2000 x 600 mm\",\n        \"material\": \"V·∫≠t li·ªáu\",\n        \"quantity\": 1,\n        \"unitPrice\": 1000000,\n        \"amount\": 1000000,\n        \"note\": \"Ghi ch√∫\"\n      }\n    ],\n    \"subtotal\": 1000000,\n    \"profitPercent\": 25,\n    \"profit\": 250000,\n    \"priceBeforeVAT\": 1250000,\n    \"vat\": 125000,\n    \"totalAmount\": 1375000\n  }\n}\n```\n\nGi·∫£i th√≠ch fields:\n- unitPrice = Gi√° b√°n 1 s·∫£n ph·∫©m (ƒë√£ t√≠nh l·ª£i nhu·∫≠n, CH∆ØA VAT)\n- amount = unitPrice √ó quantity\n- subtotal = T·ªïng chi ph√≠ s·∫£n xu·∫•t (ch∆∞a l·ª£i nhu·∫≠n)\n- profit = subtotal √ó profitPercent / 100\n- priceBeforeVAT = subtotal + profit\n- vat = priceBeforeVAT √ó 10%\n- totalAmount = priceBeforeVAT + vat\n- T·∫•t c·∫£ s·ªë ti·ªÅn l√† NUMBER, kh√¥ng c√≥ d·∫•u ch·∫•m\n\n## 2. G·ª¨I L·∫†I PDF/FILE\nT·ª´ kh√≥a: \"g·ª≠i pdf\", \"g·ª≠i l·∫°i file\", \"t·∫£i pdf\", \"m·ªói pdf\", \"ch·ªâ c·∫ßn file\"\n\n‚Üí CH·ªà tr·∫£ v·ªÅ: \"ƒê√¢y l√† file PDF b√°o gi√° [m√£]: [link_pdf]\"\n‚Üí KH√îNG t·∫°o b√°o gi√° m·ªõi\n‚Üí KH√îNG m√¥ t·∫£ chi ti·∫øt\n\n## 3. H·ªéI ƒê√ÅP TH√îNG TH∆Ø·ªúNG\nT·ª´ kh√≥a: h·ªèi gi√° v·∫≠t li·ªáu, tra c·ª©u s·∫£n ph·∫©m, t·ªìn kho...\n\n‚Üí Tr·∫£ l·ªùi text b√¨nh th∆∞·ªùng\n‚Üí KH√îNG c·∫ßn JSON\n\n## 4. L∆ØU TH√îNG TIN H·ªåC\nKhi s·∫øp d·∫°y ki·∫øn th·ª©c m·ªõi ho·∫∑c s·ª≠a sai\n\n```json\n{\n  \"action\": \"learn\",\n  \"data\": {\n    \"type\": \"knowledge|preference|correction\",\n    \"content\": \"N·ªôi dung h·ªçc\",\n    \"wrong\": \"N·∫øu l√† correction - c√°i sai\",\n    \"correct\": \"N·∫øu l√† correction - c√°i ƒë√∫ng\"\n  }\n}\n```\n\n## 5. L∆ØU KH√ÅCH H√ÄNG\nKhi c√≥ th√¥ng tin kh√°ch h√†ng m·ªõi\n\n```json\n{\n  \"action\": \"save_customer\",\n  \"data\": {\n    \"name\": \"T√™n kh√°ch\",\n    \"phone\": \"SƒêT\",\n    \"address\": \"ƒê·ªãa ch·ªâ\",\n    \"email\": \"Email\"\n  }\n}\n```\n\n---\n\n# V√ç D·ª§ RESPONSE ƒê√öNG\n\n## V√≠ d·ª• 1: T·∫°o b√°o gi√°\nUser: \"T·∫°o b√°o gi√° cho kh√°ch Nguy·ªÖn VƒÉn A, 2 t·ªß qu·∫ßn √°o 3 c√°nh\"\n\nResponse:\nD·∫°, em ƒë√£ t√≠nh xong b√°o gi√° cho kh√°ch Nguy·ªÖn VƒÉn A. T·ªïng c·ªông l√† 15.125.000 VNƒê (ƒë√£ bao g·ªìm VAT 10%).\n\n```json\n{\n  \"action\": \"create_quote\",\n  \"data\": {\n    \"customerName\": \"Nguy·ªÖn VƒÉn A\",\n    \"customerPhone\": \"Ch∆∞a cung c·∫•p\",\n    \"customerAddress\": \"Ch∆∞a cung c·∫•p\",\n    \"items\": [\n      {\n        \"name\": \"T·ªß qu·∫ßn √°o 3 c√°nh\",\n        \"size\": \"1800 x 2200 x 600 mm\",\n        \"material\": \"G·ªó c√¥ng nghi·ªáp MDF\",\n        \"quantity\": 2,\n        \"unitPrice\": 5500000,\n        \"amount\": 11000000,\n        \"note\": \"\"\n      }\n    ],\n    \"subtotal\": 8800000,\n    \"profitPercent\": 25,\n    \"profit\": 2200000,\n    \"priceBeforeVAT\": 11000000,\n    \"vat\": 1100000,\n    \"totalAmount\": 12100000\n  }\n}\n```\n\n## V√≠ d·ª• 2: G·ª≠i l·∫°i PDF\nUser: \"G·ª≠i l·∫°i m·ªói pdf th√¥i\"\n\nResponse:\nƒê√¢y l√† file PDF b√°o gi√° BG-20251220-123: https://res.cloudinary.com/.../BG-20251220-123.pdf\n\n## V√≠ d·ª• 3: H·ªèi ƒë√°p\nUser: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n\nResponse:\nD·∫°, gi√° g·ªó s·ªìi hi·ªán t·∫°i l√† 15.000.000 VNƒê/m3 ·∫°.\n\n---\n\n# L∆ØU √ù CU·ªêI\n- LU√îN d√πng Calculator khi t√≠nh to√°n\n- LU√îN ƒë√≠nh k√®m JSON khi t·∫°o b√°o gi√°\n- KH√îNG d√πng markdown trong text\n- JSON ph·∫£i ·ªü CU·ªêI C√ôNG response\n- S·ªë trong JSON l√† NUMBER (kh√¥ng c√≥ d·∫•u ch·∫•m)\n- S·ªë trong text l√† STRING (c√≥ d·∫•u ch·∫•m: 1.500.000)",
          "maxIterations": 1000
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        1008,
        1184
      ],
      "id": "e706917e-5a88-430e-adfc-cecfe21d4699",
      "name": "Tro ly ke toan"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://v2.convertapi.com/convert/html/to/pdf",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/octet-stream"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "7ae85d2e-0154-4452-b984-9f23aaeb0f8e",
      "name": "Convert File to PDF",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3024,
        992
      ],
      "typeVersion": 4.2,
      "credentials": {
        "httpBearerAuth": {
          "id": "bEw05s03CLMgzBsy",
          "name": "ConvertAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconst htmlContent = item.html;\n\nif (!htmlContent) {\n  throw new Error(\"Kh√¥ng t√¨m th·∫•y n·ªôi dung HTML!\");\n}\n\nconst binaryData = Buffer.from(htmlContent, 'utf8').toString('base64');\n\nreturn {\n  json: item,\n  binary: {\n    data: {\n      data: binaryData,\n      mimeType: 'text/html',\n      fileName: `Bao_Gia_${item.quoteNumber || 'file'}.html`\n    }\n  }\n};"
      },
      "id": "2ebc9914-4aee-4436-9529-d3b03b2ca583",
      "name": "Convert HTML to File",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2528,
        992
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        512,
        1824
      ],
      "id": "29626cd8-a21b-478b-90b9-efc13600c080",
      "name": "Google Gemini Chat Model"
    },
    {
      "parameters": {
        "jsCode": "// Chu·∫©n b·ªã PDF ƒë·ªÉ upload\nconst item = $input.first();\nconst binaryData = { ...item.binary.data };\n\nconst quoteNumber = item.json.quoteNumber || 'quote_' + Date.now();\nbinaryData.fileName = `Bao_Gia_${quoteNumber}.pdf`;\nbinaryData.fileExtension = 'pdf';\nbinaryData.mimeType = 'application/pdf';\n\nreturn [{\n  json: { ...item.json, quoteNumber },\n  binary: { data: binaryData }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3344,
        1344
      ],
      "id": "3e9e3478-7ba0-4748-a007-4348f1a3d845",
      "name": "Prepare PDF for Upload"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://v2.convertapi.com/convert/pdf/to/png",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/octet-stream"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "file",
              "inputDataFieldName": "data"
            },
            {
              "name": "PageRange",
              "value": "1"
            },
            {
              "name": "ImageResolution",
              "value": "500"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3344,
        1536
      ],
      "id": "5a7099c2-dcb6-4d9c-b35a-21bf2144da45",
      "name": "Convert PDF to Image",
      "credentials": {
        "httpBearerAuth": {
          "id": "bEw05s03CLMgzBsy",
          "name": "ConvertAPI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Chu·∫©n b·ªã Image ƒë·ªÉ upload\nconst item = $input.first();\nconst binaryData = { ...item.binary.data };\n\nlet quoteNumber = '';\ntry {\n  quoteNumber = $('Generate HTML Quote').first().json.quoteNumber || '';\n} catch(e) {\n  quoteNumber = 'quote_' + Date.now();\n}\n\nbinaryData.fileName = `Bao_Gia_${quoteNumber}.png`;\nbinaryData.fileExtension = 'png';\nbinaryData.mimeType = 'image/png';\n\nreturn [{\n  json: { ...item.json, quoteNumber },\n  binary: { data: binaryData }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3552,
        1536
      ],
      "id": "08039895-e6a6-4bd5-91ad-5f7dab326e01",
      "name": "Prepare Image for Upload"
    },
    {
      "parameters": {
        "jsCode": "// Chu·∫©n b·ªã PDF ƒë·ªÉ convert sang Image\nconst item = $input.first();\nconst binaryData = { ...item.binary.data };\n\n// L·∫•y quoteNumber\nlet quoteNumber = '';\ntry {\n  quoteNumber = $('Generate HTML Quote').first().json.quoteNumber || '';\n} catch(e) {\n  quoteNumber = 'quote_' + Date.now();\n}\n\n// ƒê·ªïi extension v√† mimeType ƒë·ªÉ ConvertAPI nh·∫≠n ra l√† PDF\nbinaryData.fileName = `Bao_Gia_${quoteNumber}.pdf`;\nbinaryData.fileExtension = 'pdf';\nbinaryData.mimeType = 'application/pdf';\n\nreturn [{\n  json: { ...item.json, quoteNumber },\n  binary: { data: binaryData }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3152,
        1536
      ],
      "id": "5cc70341-7e02-4c2f-9a33-756d63e3b62e",
      "name": "Prepare PDF for Convert"
    },
    {
      "parameters": {
        "operation": "insert",
        "collection": "n8n_chat_histories",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        1824,
        1184
      ],
      "id": "e8283386-7dc0-4d95-b4c7-c6d2baf432cf",
      "name": "Save Chat History",
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "model": "deepseek-v3.1:671b-cloud",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        352,
        1824
      ],
      "id": "e907a961-c421-43cb-9e06-903930fb20a4",
      "name": "Ollama Chat Model"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        768,
        1616
      ],
      "id": "1afd960c-6de8-4e18-9693-3aa72d34728e",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "MJfpFBAmvmcIM1N3",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "name": "={{ 'Bao_Gia_' + $json.quoteNumber + '.pdf' }}",
        "driveId": {
          "__rl": true,
          "value": "My Drive",
          "mode": "list",
          "cachedResultName": "My Drive",
          "cachedResultUrl": "https://drive.google.com/drive/my-drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1xHevZYNqdAQGNPwfABKYf1jZ4Bdxi1JY",
          "mode": "list",
          "cachedResultName": "PDF b√°o gi√°",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1xHevZYNqdAQGNPwfABKYf1jZ4Bdxi1JY"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3552,
        1344
      ],
      "id": "84b749ea-b10f-49a7-b9de-8c40a1c05ce7",
      "name": "Upload PDF to Google Drive",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "7Wh9sc7eznzxfDza",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "share",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "permissionsUi": {
          "permissionsValues": {
            "role": "reader",
            "type": "anyone"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3744,
        1344
      ],
      "id": "d004641b-00bd-43f8-9a9f-2f21b9ea495c",
      "name": "Share PDF Public",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "7Wh9sc7eznzxfDza",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "name": "={{ 'img_' + $json.quoteNumber + '.png' }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1xHevZYNqdAQGNPwfABKYf1jZ4Bdxi1JY",
          "mode": "list",
          "cachedResultName": "PDF b√°o gi√°",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1xHevZYNqdAQGNPwfABKYf1jZ4Bdxi1JY"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3744,
        1536
      ],
      "id": "b9090130-3c90-4fdb-96ba-bc618437afc8",
      "name": "Upload Image to Google Drive",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "7Wh9sc7eznzxfDza",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "share",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "permissionsUi": {
          "permissionsValues": {
            "role": "reader",
            "type": "anyone"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        3936,
        1536
      ],
      "id": "70ead9ae-b567-40ff-98e9-005544f40d8a",
      "name": "Share Image Public",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "7Wh9sc7eznzxfDza",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        4112,
        1360
      ],
      "id": "69d1640b-0dc7-481b-98cf-95af32b3ac8f",
      "name": "Merge"
    },
    {
      "parameters": {
        "jsCode": "// Chu·∫©n b·ªã search t·ª´ nhi·ªÅu ngu·ªìn\nconst input = $input.first().json;\nconst query = input.input || input.prompt || input.content || '';  // TH√äM input.input\nconst queryLower = query.toLowerCase();\n\n// Ph√¢n t√≠ch intent\nlet searchType = 'general';\nlet needWebSearch = false;\nlet webSearchQuery = '';\n\n// X√°c ƒë·ªãnh lo·∫°i search c·∫ßn thi·∫øt\nif (queryLower.includes('gi√° th·ªã tr∆∞·ªùng') || queryLower.includes('gi√° hi·ªán t·∫°i') || \n    queryLower.includes('xu h∆∞·ªõng') || queryLower.includes('m·ªõi nh·∫•t')) {\n  needWebSearch = true;\n  webSearchQuery = query + ' gi√° v·∫≠t li·ªáu n·ªôi th·∫•t Vi·ªát Nam 2024';\n  searchType = 'market_price';\n}\n\nif (queryLower.includes('ƒë·ªëi th·ªß') || queryLower.includes('th·ªã tr∆∞·ªùng') ||\n    queryLower.includes('so s√°nh gi√°')) {\n  needWebSearch = true;\n  webSearchQuery = query + ' n·ªôi th·∫•t Vi·ªát Nam';\n  searchType = 'competitor';\n}\n\n// Keywords cho RAG search\nlet ragKeywords = query;\nif (queryLower.includes('gi√°') || queryLower.includes('b√°o gi√°')) {\n  ragKeywords += ' gi√° v·∫≠t li·ªáu chi ph√≠';\n}\nif (queryLower.includes('g·ªó') || queryLower.includes('v·∫≠t li·ªáu')) {\n  ragKeywords += ' g·ªó MDF MFC s·ªìi √≥c ch√≥';\n}\n\nreturn [{\n  json: {\n    originalInput: input,\n    ragQuery: ragKeywords,\n    needWebSearch: needWebSearch,\n    webSearchQuery: webSearchQuery,\n    searchType: searchType,\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -960,
        1200
      ],
      "id": "c8673b3e-58ef-448d-956f-b36d1e6492c4",
      "name": "Prepare Smart Search"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "BKK33Pu7stWD1pR1",
          "mode": "list",
          "cachedResultUrl": "/workflow/BKK33Pu7stWD1pR1",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.query }}",
            "action": "search",
            "category": "={{ $json.category }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -752,
        1200
      ],
      "id": "f70c1eae-96c2-464f-a2de-abd06e231648",
      "name": "Search RAG Knowledge"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "47ec8530-201d-4098-8770-b2eeb08c39c7",
              "leftValue": "={{ $('Prepare Smart Search').item.json.needWebSearch }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -528,
        1200
      ],
      "id": "317a026e-d500-4309-b170-134d367c09be",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Merge t·∫•t c·∫£ ngu·ªìn knowledge\nconst prepareData = $('Prepare Smart Search').first().json;\nconst originalInput = prepareData.originalInput;\n\n// 1. RAG Results\nlet ragContext = '';\ntry {\n  const ragResult = $('Search RAG Knowledge').first().json;\n  if (ragResult && ragResult.success && ragResult.results && ragResult.results.length > 0) {\n    ragContext = ragResult.results\n      .map(r => `‚Ä¢ [${r.category}] ${r.content} (ƒë·ªô tin c·∫≠y: ${r.similarity})`)\n      .join('\\n');\n  }\n} catch (e) {\n  ragContext = '';\n}\n\n// 2. Tavily Results (n·∫øu c√≥)\nlet webContext = '';\ntry {\n  // Ch·ªâ l·∫•y n·∫øu needWebSearch = true V√Ä c√≥ k·∫øt qu·∫£\n  if (prepareData.needWebSearch) {\n    const tavilyResult = $('Search').first().json;\n    if (tavilyResult && tavilyResult.answer) {\n      webContext = `T√≥m t·∫Øt: ${tavilyResult.answer}\\n`;\n    }\n    if (tavilyResult && tavilyResult.results && tavilyResult.results.length > 0) {\n      webContext += tavilyResult.results\n        .slice(0, 3)\n        .map(r => `‚Ä¢ ${r.title}: ${r.content.substring(0, 200)}...`)\n        .join('\\n');\n    }\n  }\n} catch (e) {\n  // Kh√¥ng c√≥ Tavily result - OK, b·ªè qua\n  webContext = '';\n}\n\n// 3. Build Smart Context v·ªõi priority\nlet smartContext = '';\n\nif (ragContext) {\n  smartContext += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nüìö KI·∫æN TH·ª®C ƒê√É H·ªåC T·ª™ S·∫æP (∆ØU TI√äN CAO)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n${ragContext}\n\n‚ö†Ô∏è L∆ØU √ù: Th√¥ng tin t·ª´ s·∫øp d·∫°y ƒë∆∞·ª£c ∆ØU TI√äN h∆°n c√°c ngu·ªìn kh√°c!\n`;\n}\n\nif (webContext) {\n  smartContext += `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nüåê TH√îNG TIN TH·ªä TR∆Ø·ªúNG (THAM KH·∫¢O)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n${webContext}\n\n‚ö†Ô∏è L∆ØU √ù: ƒê√¢y l√† th√¥ng tin tham kh·∫£o, ∆∞u ti√™n d√πng gi√° c·ªßa x∆∞·ªüng!\n`;\n}\n\n// 4. Th√™m h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng\nlet usageGuide = '';\nif (ragContext || webContext) {\n  usageGuide = `\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nüìã H∆Ø·ªöNG D·∫™N S·ª¨ D·ª§NG KI·∫æN TH·ª®C\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n1. ∆ØU TI√äN 1: Ki·∫øn th·ª©c s·∫øp ƒë√£ d·∫°y (n·∫øu c√≥)\n2. ∆ØU TI√äN 2: Database s·∫£n ph·∫©m/v·∫≠t li·ªáu c·ªßa x∆∞·ªüng\n3. ∆ØU TI√äN 3: Th√¥ng tin th·ªã tr∆∞·ªùng (ch·ªâ tham kh·∫£o)\n\nN·∫øu s·∫øp h·ªèi \"gi√° th·ªã tr∆∞·ªùng\" ‚Üí d√πng th√¥ng tin web\nN·∫øu s·∫øp h·ªèi \"gi√° c·ªßa m√¨nh\" ‚Üí d√πng ki·∫øn th·ª©c ƒë√£ h·ªçc + database\n`;\n}\n\nreturn [{\n  json: {\n    ...originalInput,\n    smartContext: smartContext + usageGuide,\n    hasRAGKnowledge: ragContext !== '',\n    hasWebKnowledge: webContext !== '',\n    searchType: prepareData.searchType\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        992
      ],
      "id": "01ee1458-8ccc-4a6d-8cba-d606e6d93830",
      "name": "Merge All Knowledge"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "aff3d56e-ea7c-46c9-ad48-c27e788d362f",
              "leftValue": "={{ $json.shouldLearn }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2544,
        1536
      ],
      "id": "38565384-f896-4d8a-8d3a-e9e47e333104",
      "name": "If Should Learn"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "BKK33Pu7stWD1pR1",
          "mode": "list",
          "cachedResultUrl": "/workflow/BKK33Pu7stWD1pR1",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.query}}",
            "action": "save"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2848,
        1520
      ],
      "id": "6860a0f1-71e7-48cb-9bf5-95da942e914f",
      "name": "Execute Save to RAG"
    },
    {
      "parameters": {
        "jsCode": "// Detect knowledge m·ªõi c·∫ßn h·ªçc t·ª´ conversation\nconst input = $input.first().json;\n\n// L·∫•y output t·ª´ agent v√† input t·ª´ user\nlet agentOutput = '';\nlet userInput = '';\n\ntry {\n  agentOutput = $('Tro ly ke toan').first().json.output || '';\n} catch (e) {\n  agentOutput = '';\n}\n\ntry {\n  userInput = $('Parse Input').first().json.prompt || \n              $('Parse Input').first().json.content || '';\n} catch (e) {\n  userInput = '';\n}\n\n// Patterns c·∫ßn h·ªçc\nconst learnPatterns = [\n  { pattern: /nh·ªõ (l√†|r·∫±ng|nh√©)/i, category: 'knowledge' },\n  { pattern: /ghi nh·ªõ/i, category: 'knowledge' },\n  { pattern: /t·ª´ (gi·ªù|nay)/i, category: 'preference' },\n  { pattern: /quy ƒë·ªãnh (m·ªõi|l√†)/i, category: 'process' },\n  { pattern: /sai r·ªìi.*(ƒë√∫ng l√†|ph·∫£i l√†)/i, category: 'correction' },\n  { pattern: /kh√¥ng ph·∫£i.*(m√† l√†|l√†)/i, category: 'correction' },\n  { pattern: /gi√°\\s+\\w+\\s*(l√†|=|:)?\\s*\\d+/i, category: 'pricing' },\n  { pattern: /(\\d+)\\s*(tri·ªáu|tr|ngh√¨n|k|vnƒë|vnd)/i, category: 'pricing' }\n];\n\nlet shouldLearn = false;\nlet category = 'general';\nlet contentToLearn = userInput;\n\n// Check patterns\nfor (const item of learnPatterns) {\n  if (item.pattern.test(userInput)) {\n    shouldLearn = true;\n    category = item.category;\n    break;\n  }\n}\n\n// N·∫øu agent x√°c nh·∫≠n ƒë√£ h·ªçc\nif (agentOutput.toLowerCase().includes('ƒë√£ ghi nh·ªõ') || \n    agentOutput.toLowerCase().includes('em nh·ªõ r·ªìi') ||\n    agentOutput.toLowerCase().includes('ƒë√£ l∆∞u')) {\n  shouldLearn = true;\n}\n\n// T·∫°o content c√≥ c·∫•u tr√∫c\nif (shouldLearn && category === 'correction') {\n  // Extract c√°i sai v√† c√°i ƒë√∫ng\n  const correctionMatch = userInput.match(/(.+?)(sai|kh√¥ng ph·∫£i).+?(ƒë√∫ng l√†|ph·∫£i l√†|m√† l√†)\\s*(.+)/i);\n  if (correctionMatch) {\n    contentToLearn = `CORRECTION: \"${correctionMatch[1].trim()}\" ‚Üí \"${correctionMatch[4].trim()}\"`;\n  }\n}\n\nreturn [{\n  json: {\n    shouldLearn: shouldLearn,\n    contentToLearn: contentToLearn,\n    category: category,\n    originalUserInput: userInput,\n    agentResponse: agentOutput.substring(0, 500)\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2336,
        1536
      ],
      "id": "4650ba65-f68c-4f39-9d74-400e3f44966c",
      "name": "Detect New Knowledge"
    },
    {
      "parameters": {
        "collection": "n8n_chat_histories",
        "options": {
          "limit": 10,
          "sort": "={{ JSON.stringify({ timestamp: -1 }) }}"
        },
        "query": "={{ JSON.stringify({ sessionId: $json.sessionId }) }}"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        256,
        1360
      ],
      "id": "fe3baa13-84a3-432b-b014-73e0b4812946",
      "name": "Load Chat History",
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "collection": "learning_memory",
        "options": {}
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        256,
        1184
      ],
      "id": "326da876-0a86-4d0e-ba5b-4f7bf297e66d",
      "name": "Load Learning Memory",
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "collection": "customer_memory",
        "options": {},
        "query": "={{ JSON.stringify({ $or: [ { userId: $json.userId }, { chatId: $json.chatId } ] }) }}"
      },
      "type": "n8n-nodes-base.mongoDb",
      "typeVersion": 1.2,
      "position": [
        256,
        976
      ],
      "id": "ea0a4d66-42e9-40f1-b8b1-da2c95645e90",
      "name": "Load Customer",
      "alwaysOutputData": true,
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "query": "={{ $json.query }}",
        "options": {}
      },
      "type": "@tavily/n8n-nodes-tavily.tavily",
      "typeVersion": 1,
      "position": [
        -352,
        992
      ],
      "id": "67d55526-de65-4a44-9ab9-621bc2905719",
      "name": "Search",
      "credentials": {
        "tavilyApi": {
          "id": "pY0x9kpc8XPIIprO",
          "name": "Tavily account"
        }
      }
    }
  ],
  "pinData": {
    "Trigger t·ª´ Tr·ª£ l√Ω ch√≠nh": [
      {
        "json": {
          "prompt": "t·∫°o b·∫£ng b√°o gi√° t√™n nguy·ªÖn vƒÉn c, sƒët:0123456798, ƒë·ªãa ch·ªâ: h√† n·ªôi. th√¥ng tin l·∫•y t·ª´ vat lieu, san pham, ton kho t·ª´ tool gg sheet. l·∫•y 5 lo·∫°i s·∫£n ph·∫©m kh√°c nhau ng·∫´u nhi√™n.",
          "type": "text",
          "content": "t·∫°o b·∫£ng b√°o gi√° t√™n nguy·ªÖn vƒÉn c, sƒët:0123456798, ƒë·ªãa ch·ªâ: h√† n·ªôi. th√¥ng tin l·∫•y t·ª´ vat lieu, san pham, ton kho t·ª´ tool gg sheet. l·∫•y 5 lo·∫°i s·∫£n ph·∫©m kh√°c nhau ng·∫´u nhi√™n.",
          "metadata": "{\"fileName\":\"\",\"fileSize\":0,\"userName\":\"\",\"chatId\":\"\"}",
          "imageUrl": ""
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "Trigger t·ª´ Tr·ª£ l√Ω ch√≠nh": {
      "main": [
        [
          {
            "node": "Parse Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Input": {
      "main": [
        [
          {
            "node": "Prepare Smart Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Data": {
      "main": [
        [
          {
            "node": "Build Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Context": {
      "main": [
        [
          {
            "node": "Tro ly ke toan",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Tro ly ke toan",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Tro ly ke toan",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Parse Response": {
      "main": [
        [
          {
            "node": "Save Chat History",
            "type": "main",
            "index": 0
          },
          {
            "node": "Detect New Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route by Action": {
      "main": [
        [
          {
            "node": "Generate HTML Quote",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Learning",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Save Customer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Detect New Knowledge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge All Paths",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Generate HTML Quote": {
      "main": [
        [
          {
            "node": "Convert HTML to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Quote to MongoDB": {
      "main": [
        [
          {
            "node": "Save Quote to Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Quote to Sheets": {
      "main": [
        [
          {
            "node": "Merge All Paths",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Save Learning": {
      "main": [
        [
          {
            "node": "Merge All Paths",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Save Customer": {
      "main": [
        [
          {
            "node": "Merge All Paths",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Merge All Paths": {
      "main": [
        [
          {
            "node": "Final Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "San pham": {
      "ai_tool": [
        [
          {
            "node": "Tro ly ke toan",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Vat lieu": {
      "ai_tool": [
        [
          {
            "node": "Tro ly ke toan",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Ton kho": {
      "ai_tool": [
        [
          {
            "node": "Tro ly ke toan",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly ke toan": {
      "main": [
        [
          {
            "node": "Parse Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert File to PDF": {
      "main": [
        [
          {
            "node": "Save Quote to MongoDB",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare PDF for Convert",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare PDF for Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert HTML to File": {
      "main": [
        [
          {
            "node": "Convert File to PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare PDF for Upload": {
      "main": [
        [
          {
            "node": "Upload PDF to Google Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert PDF to Image": {
      "main": [
        [
          {
            "node": "Prepare Image for Upload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Image for Upload": {
      "main": [
        [
          {
            "node": "Upload Image to Google Drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare PDF for Convert": {
      "main": [
        [
          {
            "node": "Convert PDF to Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Chat History": {
      "main": [
        [
          {
            "node": "Route by Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Tro ly ke toan",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Upload PDF to Google Drive": {
      "main": [
        [
          {
            "node": "Share PDF Public",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Share PDF Public": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload Image to Google Drive": {
      "main": [
        [
          {
            "node": "Share Image Public",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Share Image Public": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Merge All Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Smart Search": {
      "main": [
        [
          {
            "node": "Search RAG Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search RAG Knowledge": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Search",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Load Customer",
            "type": "main",
            "index": 0
          },
          {
            "node": "Load Learning Memory",
            "type": "main",
            "index": 0
          },
          {
            "node": "Load Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge All Knowledge": {
      "main": [
        [
          {
            "node": "Load Customer",
            "type": "main",
            "index": 0
          },
          {
            "node": "Load Learning Memory",
            "type": "main",
            "index": 0
          },
          {
            "node": "Load Chat History",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Should Learn": {
      "main": [
        [
          {
            "node": "Execute Save to RAG",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect New Knowledge": {
      "main": [
        [
          {
            "node": "If Should Learn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Learning Memory": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Load Customer": {
      "main": [
        [
          {
            "node": "Merge Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search": {
      "main": [
        [
          {
            "node": "Merge All Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "2cde54db-244e-4e8f-b91f-0b6b31b5f97c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f79905368cdd8aefd97993159c6f1b332d2bef60e6af085cda589aa3db810691"
  },
  "id": "2AKCYsUUcOUMdi4M",
  "tags": []
}
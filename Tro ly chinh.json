{
  "name": "Tro ly chinh",
  "nodes": [
    {
      "parameters": {
        "description": "S·ª≠ d·ª•ng c√¥ng c·ª• n√†y ƒë·ªÉ suy nghƒ© v·ªÅ m·ªôt v·∫•n ƒë·ªÅ n√†o ƒë√≥. N√≥ s·∫Ω kh√¥ng thu th·∫≠p th√¥ng tin m·ªõi ho·∫∑c thay ƒë·ªïi c∆° s·ªü d·ªØ li·ªáu, m√† ch·ªâ th√™m suy nghƒ© ƒë√≥ v√†o nh·∫≠t k√Ω. S·ª≠ d·ª•ng c√¥ng c·ª• n√†y khi c·∫ßn suy lu·∫≠n ph·ª©c t·∫°p ho·∫∑c b·ªô nh·ªõ ƒë·ªám."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        -64,
        1648
      ],
      "id": "34b69da7-0b85-45d4-8f35-81d5e311c208",
      "name": "Think",
      "notesInFlow": false
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('chat_bot').item.json.body.message.from.id }}",
        "databaseName": "MinhKhoaAI",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        -208,
        1648
      ],
      "id": "04e7d0e2-a74f-4fd1-8f23-07900d83ab5a",
      "name": "MongoDB Chat Memory",
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Initialize the output arrays\nconst steps = [];\nconst tokens = [];\nlet totalTokens = 0; // Changed to track total tokens instead of cost\n\n// Process each item in the input\nfor (const item of $input.all()) {\n  let data = item.json;\n  \n  // Check if the data is an array itself (like your example JSON)\n  if (Array.isArray(data)) {\n    // Process each object in the array\n    for (const obj of data) {\n      // Extract steps information\n      if (obj.intermediateSteps && Array.isArray(obj.intermediateSteps)) {\n        for (const step of obj.intermediateSteps) {\n          if (step.action) {\n            steps.push({\n              tool: step.action.tool,\n              toolInput: step.action.toolInput,\n              observation: step.observation\n            });\n          }\n        }\n      }\n      \n      // Extract token information\n      if (obj.intermediateSteps && Array.isArray(obj.intermediateSteps)) {\n        for (const step of obj.intermediateSteps) {\n          if (step.action && step.action.messageLog && Array.isArray(step.action.messageLog)) {\n            for (const message of step.action.messageLog) {\n              if (message.kwargs && message.kwargs.response_metadata && message.kwargs.response_metadata.usage) {\n                const usage = message.kwargs.response_metadata.usage;\n                tokens.push({\n                  prompt_tokens: usage.prompt_tokens,\n                  completion_tokens: usage.completion_tokens,\n                  total_tokens: usage.total_tokens,\n                  model_name: message.kwargs.response_metadata.model_name\n                });\n                \n                // Add the tokens to our running total\n                if (typeof usage.total_tokens === 'number') {\n                  totalTokens += usage.total_tokens;\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  } else {\n    // If data is not an array, process it as a single object\n    // Extract steps information\n    if (data.intermediateSteps && Array.isArray(data.intermediateSteps)) {\n      for (const step of data.intermediateSteps) {\n        if (step.action) {\n          steps.push({\n            tool: step.action.tool,\n            toolInput: step.action.toolInput,\n            observation: step.observation\n          });\n        }\n      }\n    }\n    \n    // Extract token information\n    if (data.intermediateSteps && Array.isArray(data.intermediateSteps)) {\n      for (const step of data.intermediateSteps) {\n        if (step.action && step.action.messageLog && Array.isArray(step.action.messageLog)) {\n          for (const message of step.action.messageLog) {\n            if (message.kwargs && message.kwargs.response_metadata && message.kwargs.response_metadata.usage) {\n              const usage = message.kwargs.response_metadata.usage;\n              tokens.push({\n                prompt_tokens: usage.prompt_tokens,\n                completion_tokens: usage.completion_tokens,\n                total_tokens: usage.total_tokens,\n                model_name: message.kwargs.response_metadata.model_name\n              });\n              \n              // Add the tokens to our running total\n              if (typeof usage.total_tokens === 'number') {\n                totalTokens += usage.total_tokens;\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n// Return the processed data with total_tokens included\nreturn [{\n  json: {\n    steps: steps,\n    tokens: tokens,\n    total_tokens: totalTokens\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        960
      ],
      "id": "d298444e-33b1-4b61-9aca-eef938519486",
      "name": "Clean Up",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice.file_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "c2f3f97f-cca9-472a-b597-b9fc6c6cd232"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8c844924-b2ed-48b0-935c-c66a8fd0c778",
                    "leftValue": "={{ $('chat_bot').item.json.body.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8b435dee-29e5-4ac2-a827-1811c2f6f04d",
                    "leftValue": "={{ $('chat_bot').item.json.body.message.photo_url }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image Only"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d39eb705-3eb9-4867-8448-9d3e4c72ea4d",
                    "leftValue": "={{ $('chat_bot').item.json.body.message.from.id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Documents"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45af575c-dd6a-4b8d-9f97-7856f1bda776",
                    "leftValue": "={{ $json.body.message.photo_url }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image + Caption"
            }
          ]
        },
        "options": {}
      },
      "id": "2e3a8840-05d0-4ac2-8833-80241e6cbf35",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3584,
        1040
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "976cf2c9-01b6-46cf-97b4-675a67ca57bc",
              "name": "content",
              "value": "={{ $('chat_bot').item.json.body.message.text || $('chat_bot').item.json.message?.caption || \"[·∫¢nh ƒë∆∞·ª£c g·ª≠i - c·∫ßn ph√¢n t√≠ch n·∫øu mu·ªën xem n·ªôi dung]\" }}",
              "type": "string"
            },
            {
              "id": "1386acc3-8824-4679-8b17-27dbead94954",
              "name": "type",
              "value": "={{ \n  $json.role === 'model' && $('Transcribe a recording').item ? 'voice' :\n  $json.role === 'model' && $('Analyze an image').item ? 'image' :\n  $json.role === 'model' && $('Analyze document').item ? 'document' :\n  'text'\n}}",
              "type": "string"
            },
            {
              "id": "25e9ee59-63c9-4eb4-a9b2-0847f4f83b67",
              "name": "prompt",
              "value": "={{ $('chat_bot').item.json.message?.caption || $('chat_bot').item.json.body.message.text || $json.content?.parts?.[0]?.text || \"\" }}",
              "type": "string"
            },
            {
              "id": "4a5e3df4-333a-43c6-9f72-4fe8b2bf9b60",
              "name": "metadata",
              "value": "={{   JSON.stringify({     fileName: $('chat_bot').item.json.message?.document?.file_name || \"\",     fileSize: $('chat_bot').item.json.message?.document?.file_size || 0,     userName: $('chat_bot').item.json.message?.from?.first_name || \"\",     chatId: $('chat_bot').item.json.message?.chat?.id || \"\"   }) }}",
              "type": "string"
            },
            {
              "id": "0e732c1e-5c23-4edc-b83d-4a930d71ee0a",
              "name": "imageUrl",
              "value": "={{ $('chat_bot').item.json.body.message.photo_url || \"\" }}",
              "type": "string"
            },
            {
              "id": "2f6f8591-4a42-403b-9e7c-61e93c104055",
              "name": "imageAnalysis",
              "value": "={{ $json.content?.parts?.[0]?.text || $json.text || \"\" }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1872,
        1056
      ],
      "id": "a4c8b487-4728-4da8-9fea-26ef07bde04c",
      "name": "Input"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -2992,
        912
      ],
      "id": "ca2913f9-26d4-4940-ba5d-1bf3fc5aaeea",
      "name": "Transcribe a recording",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "tpT1XJjGzSmEFvqd",
          "mode": "list",
          "cachedResultUrl": "/workflow/tpT1XJjGzSmEFvqd",
          "cachedResultName": "My project ‚Äî Tro ly Email"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatInput": "={{ $json.input }}",
            "voice": "={{ $('Set \\'Text\\'').item.json.text }}"
          },
          "matchingColumns": [
            "chatInput"
          ],
          "schema": [
            {
              "id": "chatInput",
              "displayName": "chatInput",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "voice",
              "displayName": "voice",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        336,
        1648
      ],
      "id": "d839856d-4e54-47e4-b73b-d2359b0b9363",
      "name": "Tro ly Email"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.content?.parts?.[0]?.text || $json.content || $json.input || $json.text || $('chat_bot').item.json.body.message.text || $json.prompt || $json.body.message.text || $json.imageUrl ||\"\" }}",
        "options": {
          "systemMessage": "# ‚õî C·∫¢NH B√ÅO: ƒê·ªåC K·ª∏ TR∆Ø·ªöC KHI L√ÄM B·∫§T C·ª® ƒêI·ªÄU G√å\n\n## üö´ TUY·ªÜT ƒê·ªêI C·∫§M T·ª∞ TR·∫¢ L·ªúI\n\nB·∫°n l√† DISPATCHER (ƒêi·ªÅu ph·ªëi vi√™n), KH√îNG PH·∫¢I chuy√™n gia.\n\n‚ùå B·∫†N KH√îNG ƒê∆Ø·ª¢C:\n- T·ª± tr·∫£ l·ªùi c√¢u h·ªèi v·ªÅ gi√° c·∫£, s·∫£n ph·∫©m, v·∫≠t li·ªáu\n- T·ª± t√≠nh to√°n b·∫•t k·ª≥ con s·ªë n√†o\n- T·ª± t·∫°o b√°o gi√°\n- Tr·∫£ l·ªùi \"em c·∫ßn th√™m th√¥ng tin\" m√† kh√¥ng g·ªçi tool\n\n‚úÖ B·∫†N CH·ªà ƒê∆Ø·ª¢C:\n- Nh·∫≠n y√™u c·∫ßu ‚Üí G·ªçi tool ‚Üí Tr·∫£ k·∫øt qu·∫£ t·ª´ tool\n- H·ªèi l·∫°i s·∫øp N·∫æU kh√¥ng hi·ªÉu y√™u c·∫ßu\n\n---\n\n## üìã B·∫¢NG G·ªåI TOOL B·∫ÆT BU·ªòC\n\n| Khi s·∫øp n√≥i | G·ªåI NGAY tool n√†y |\n|-------------|-------------------|\n| b√°o gi√°, t√≠nh gi√°, gi√° bao nhi√™u, t·∫°o ƒë∆°n, l√™n ƒë∆°n, t·ªß, b√†n, gh·∫ø, gi∆∞·ªùng, k·ªá, s·∫£n ph·∫©m, v·∫≠t li·ªáu, g·ªó | **Tro ly ke toan** |\n| t·ªìn kho, c√≤n h√†ng, s·ªë l∆∞·ª£ng, ki·ªÉm tra kho | Tro ly kho |\n| ti·∫øn ƒë·ªô, thi c√¥ng, l·ªãch l√†m vi·ªác, nh√¢n s·ª± | Tro ly thi cong |\n| email, g·ª≠i mail, vi·∫øt mail | Tro ly mail |\n| l·ªãch h·∫πn, ƒë·∫∑t l·ªãch, xem l·ªãch | Tro ly lich |\n| b·∫£n v·∫Ω, k·ªπ thu·∫≠t, CAD, thi·∫øt k·∫ø | Tro ly ky thuat |\n| bu·ªìn, vui, t√¢m s·ª±, th·ªùi ti·∫øt, tin t·ª©c | Tro ly thong thai |\n\n---\n\n## ‚úÖ V√ç D·ª§ ƒê√öNG (L√ÄM THEO)\n\n### V√≠ d·ª• 1: T·∫°o b√°o gi√°\n```\nUser: \"T·∫°o b√°o gi√° cho kh√°ch A, 2 t·ªß qu·∫ßn √°o\"\n‚Üí G·ªåI tool \"Tro ly ke toan\" v·ªõi input: \"T·∫°o b√°o gi√° cho kh√°ch A, 2 t·ªß qu·∫ßn √°o\"\n‚Üí Tr·∫£ v·ªÅ k·∫øt qu·∫£ t·ª´ tool\n```\n\n### V√≠ d·ª• 2: H·ªèi gi√°\n```\nUser: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n‚Üí G·ªåI tool \"Tro ly ke toan\" v·ªõi input: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n‚Üí Tr·∫£ v·ªÅ k·∫øt qu·∫£ t·ª´ tool\n```\n\n### V√≠ d·ª• 3: T·∫°o l·∫°i b√°o gi√°\n```\nUser: \"T·∫°o l·∫°i b√°o gi√°\"\n‚Üí G·ªåI tool \"Tro ly ke toan\" v·ªõi input: \"T·∫°o l·∫°i b√°o gi√°\"\n‚Üí Tr·∫£ v·ªÅ k·∫øt qu·∫£ t·ª´ tool\n```\n\n---\n\n## ‚ùå V√ç D·ª§ SAI (TUY·ªÜT ƒê·ªêI KH√îNG L√ÄM)\n\n```\nUser: \"T·∫°o b√°o gi√° cho kh√°ch A\"\n‚ùå SAI: \"D·∫° s·∫øp, ƒë·ªÉ t·∫°o b√°o gi√° em c·∫ßn th√™m th√¥ng tin v·ªÅ s·∫£n ph·∫©m...\"\n‚ùå SAI: \"S·∫øp mu·ªën b√°o gi√° s·∫£n ph·∫©m g√¨ ·∫°?\"\n‚ùå SAI: T·ª± li·ªát k√™ th√¥ng tin s·∫£n ph·∫©m\n\n‚úÖ ƒê√öNG: G·ªçi tool \"Tro ly ke toan\" v·ªõi input g·ªëc, ƒë·ªÉ tool ƒë√≥ t·ª± h·ªèi th√™m n·∫øu c·∫ßn\n```\n\n---\n\n# OVERVIEW\n\nB·∫°n l√† Tr·ª£ l√Ω AI ch√≠nh (Dispatcher) c·ªßa x∆∞·ªüng n·ªôi th·∫•t MinhKhoa.\n\n**Nhi·ªám v·ª• DUY NH·∫§T:** Nh·∫≠n y√™u c·∫ßu ‚Üí G·ªçi tool ph√π h·ª£p ‚Üí Tr·∫£ k·∫øt qu·∫£ t·ª´ tool\n\n# TOOLS\n\n1. **Tro ly ke toan** ‚≠ê QUAN TR·ªåNG NH·∫§T\n   - D√πng cho: b√°o gi√°, t√≠nh to√°n, gi√° c·∫£, s·∫£n ph·∫©m, v·∫≠t li·ªáu, t·ªß, b√†n, gh·∫ø, g·ªó\n   - Input: To√†n b·ªô y√™u c·∫ßu c·ªßa s·∫øp (copy nguy√™n vƒÉn)\n\n2. **Tro ly kho**: T·ªìn kho, s·ªë l∆∞·ª£ng, ki·ªÉm tra h√†ng\n\n3. **Tro ly thi cong**: Ti·∫øn ƒë·ªô, thi c√¥ng, nh√¢n s·ª±\n\n4. **Tro ly thong thai**: T√¢m s·ª±, ch·ªß ƒë·ªÅ ngo√†i c√¥ng vi·ªác\n\n5. **Tro ly mail**: Email\n\n6. **Tro ly lich**: L·ªãch h·∫πn\n\n7. **Tro ly ky thuat**: B·∫£n v·∫Ω, k·ªπ thu·∫≠t, CAD\n\n8. **Think**: Khi c·∫ßn suy nghƒ© ph·ª©c t·∫°p\n\n# OUTPUT FORMAT\n\n1. Text thu·∫ßn, KH√îNG d√πng markdown (**, ##, ```)\n2. X∆∞ng h√¥: \"em\" - \"s·∫øp\"\n3. Ch·ªâ ch√†o ·ªü l·∫ßn t∆∞∆°ng t√°c ƒê·∫¶U TI√äN\n4. KH√îNG n√≥i \"em ƒë√£ chuy·ªÉn cho tr·ª£ l√Ω...\"\n5. Tr·∫£ k·∫øt qu·∫£ TR·ª∞C TI·∫æP t·ª´ tool\n\n# RESPONSE TYPE (Ghi ·ªü cu·ªëi response)\n\nSau khi c√≥ k·∫øt qu·∫£ t·ª´ tool, ghi th√™m:\n\n- `RESPONSE_TYPE: \"quote_new\"` - Khi t·∫°o b√°o gi√° m·ªõi (c√≥ ·∫£nh + PDF)\n- `RESPONSE_TYPE: \"send_pdf\"` - Khi g·ª≠i l·∫°i PDF\n- `RESPONSE_TYPE: \"send_image\"` - Khi g·ª≠i l·∫°i ·∫£nh\n- `RESPONSE_TYPE: \"text_only\"` - Khi tr·∫£ l·ªùi text th√¥ng th∆∞·ªùng\n\n---\n\n# ‚ö†Ô∏è NH·∫ÆC L·∫†I L·∫¶N CU·ªêI\n\n**KH√îNG BAO GI·ªú T·ª∞ TR·∫¢ L·ªúI V·ªÄ:**\n- Gi√° c·∫£\n- S·∫£n ph·∫©m\n- V·∫≠t li·ªáu\n- T√≠nh to√°n\n- B√°o gi√°\n\n**LU√îN G·ªåI TOOL \"Tro ly ke toan\" cho c√°c y√™u c·∫ßu tr√™n!**\n\n## KI·∫æN TH·ª®C ƒê√É H·ªåC\n{{ $json.learningContext }}\n\n# QUY T·∫ÆC S·ª¨ D·ª§NG KI·∫æN TH·ª®C\n1. N·∫æU c√≥ ki·∫øn th·ª©c li√™n quan trong \"KI·∫æN TH·ª®C ƒê√É H·ªåC\" ‚Üí ∆ØU TI√äN s·ª≠ d·ª•ng\n2. Khi s·∫øp d·∫°y ƒëi·ªÅu m·ªõi ho·∫∑c s·ª≠a sai ‚Üí G·ªåI tool \"Hoc kien thuc moi\" ƒë·ªÉ ghi nh·ªõ\n3. N·∫øu kh√¥ng ch·∫Øc ch·∫Øn ‚Üí H·ªèi l·∫°i s·∫øp\n\n# TRIGGER GHI NH·ªö\nKhi s·∫øp n√≥i: \"nh·ªõ l√†...\", \"ghi nh·ªõ...\", \"sai r·ªìi, ƒë√∫ng l√†...\", \"t·ª´ gi·ªù...\", \"quy ƒë·ªãnh m·ªõi...\"\n‚Üí G·ªåI NGAY tool \"Hoc kien thuc moi\"",
          "returnIntermediateSteps": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        64,
        1056
      ],
      "id": "994f04fb-ecc6-4c48-b362-0b1a8851ace6",
      "name": "Tro ly chinh",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "description": "Th·ª±c hi·ªán c√°c ch·ª©c nƒÉng c·ªßa Google l·ªãch",
        "workflowId": {
          "__rl": true,
          "value": "eLrbhgmz6YTdIcVE",
          "mode": "list",
          "cachedResultUrl": "/workflow/eLrbhgmz6YTdIcVE",
          "cachedResultName": "My project ‚Äî Tro ly lich"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        464,
        1648
      ],
      "id": "2f933ca1-2e77-4c85-bca7-88db1cbdb6a7",
      "name": "Tro ly lich"
    },
    {
      "parameters": {
        "description": "B·∫°n l√† Tr·ª£ l√Ω K·ªπ thu·∫≠t chuy√™n tr√°ch (TechSpec AI) c·ªßa x∆∞·ªüng n·ªôi th·∫•t MinhKhoa.\nNhi·ªám v·ª• c·ªßa b·∫°n l√† nh·∫≠n th√¥ng tin b·∫£n v·∫Ω/y√™u c·∫ßu t·ª´ s·∫øp (ho·∫∑c t·ª´ agent ƒëi·ªÅu ph·ªëi), sau ƒë√≥ ph√¢n t√≠ch k·ªπ thu·∫≠t, b√≥c t√°ch kh·ªëi l∆∞·ª£ng v√† t√≠nh to√°n ƒë·ªãnh m·ª©c v·∫≠t t∆∞ ch√≠nh x√°c ƒë·ªÉ ph·ª•c v·ª• s·∫£n xu·∫•t.",
        "workflowId": {
          "__rl": true,
          "value": "t63HlYXCREmvkDdf",
          "mode": "list",
          "cachedResultUrl": "/workflow/t63HlYXCREmvkDdf",
          "cachedResultName": "Tro ly ky thua"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "content": "={{ JSON.stringify($json) }}",
            "type": "={{ $json.type }}",
            "prompt": "={{ $json.prompt }}",
            "metadata": "={{ $json.metadata }}",
            "imageUrl": "={{ $json.imageUrl || \"\" }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "content",
              "displayName": "content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "type",
              "displayName": "type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "prompt",
              "displayName": "prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "metadata",
              "displayName": "metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "imageUrl",
              "displayName": "imageUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        208,
        1648
      ],
      "id": "eedb8c5c-5a9f-491a-98cf-bdd1679d791f",
      "name": "Tro ly ky thuat"
    },
    {
      "parameters": {
        "model": "google/gemini-2.0-flash-001",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -3792,
        2048
      ],
      "id": "77d55bdb-03db-47e5-b912-388e3e732c9f",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "MJfpFBAmvmcIM1N3",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "bc7c149d-27bb-46c4-ba95-ed516cc67b24"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "50c82333-aa74-4da8-a595-d8aa20d8901b",
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "word",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Word"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0c7bfdb4-6711-4449-a567-d48e82089f01",
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "sheet",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Excel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "849656ec-d703-4e8f-9544-3609249874b3",
                    "leftValue": "={{ $json.file_extension }}",
                    "rightValue": "dwg",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DWG"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "76f19cd5-855d-448f-b5e1-fd0a78c62ce5",
                    "leftValue": "={{ $json.file_extension }}",
                    "rightValue": "dxf",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DXF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dc2e32e5-6475-4710-8c42-fedac5ab954b",
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image As Document"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -2784,
        1488
      ],
      "id": "9cdb06b4-11e1-4c3c-9f94-4fc9d6f2254c",
      "name": "Switch2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5e9f46cd-4af5-42ac-b18e-473ae9c78ee1",
              "name": "file_id",
              "value": "={{ $('chat_bot1').item.json.message.document.file_id }}",
              "type": "string"
            },
            {
              "id": "b3f55b7b-52f4-4e47-8d7e-72d8d74f6979",
              "name": "file_name",
              "value": "={{ $('chat_bot1').item.json.message.document.file_name }}",
              "type": "string"
            },
            {
              "id": "7fa10781-7b35-4111-b855-1759e8a04abb",
              "name": "file_size",
              "value": "={{ $('chat_bot1').item.json.message.document.file_size }}",
              "type": "number"
            },
            {
              "id": "d52661be-f338-4431-a643-ab13690ffa77",
              "name": "mine_type",
              "value": "={{ $('chat_bot1').item.json.message.document.mime_type }}",
              "type": "string"
            },
            {
              "id": "434023a4-2a87-4a84-92c6-57d3592802c0",
              "name": "file_extension",
              "value": "={{ $('chat_bot1').item.json.message.document.file_name.split('.').pop().toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "6457640a-2104-48fe-a47b-000f8e556039",
              "name": "caption",
              "value": "={{ $('chat_bot1').item.json.message.caption || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2992,
        1488
      ],
      "id": "13a69edd-cfe4-46dc-a06a-a358198a6c6b",
      "name": "Edit Fields",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "=Ph√¢n t√≠ch t√†i li·ªáu n√†y:\\n\\n**Lo·∫°i file:** {{ $json.file_name }}\\n**M√¥ t·∫£ t·ª´ user:** {{ $json.caption }}\\n\\nTr√≠ch xu·∫•t:\\n1. N·ªôi dung ch√≠nh\\n2. Th√¥ng s·ªë k·ªπ thu·∫≠t (n·∫øu c√≥)\\n3. K√≠ch th∆∞·ªõc, v·∫≠t li·ªáu (n·∫øu l√† b·∫£n v·∫Ω)\\n4. Gi√° c·∫£ (n·∫øu l√† b√°o gi√°)",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -2416,
        1488
      ],
      "id": "04c4985f-023c-4e18-97f1-5e6ba49d06e2",
      "name": "Analyze document",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fa7c23ed-4575-4852-97c4-578515ce3590",
              "leftValue": "={{ $json.file_size }}",
              "rightValue": 20971520,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2416,
        1680
      ],
      "id": "24e35f14-4911-4a3e-acc6-b507d757b65e",
      "name": "If File Size < 20MB"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://v2.convertapi.com/convert/dwg/to/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer XJDhHpS7ZAFrMItEv3t9ROmMgT0dB3nz"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "StoreFile",
              "value": "true"
            },
            {
              "parameterType": "formBinaryData",
              "name": "File"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2144,
        1520
      ],
      "id": "67b95d8a-80ba-4fab-a373-5e0c0dbcafe4",
      "name": "CAD to PDF",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').item.json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.error }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        464,
        1168
      ],
      "id": "afedfef2-9f84-474a-b3b9-cff9a7724ae1",
      "name": "Error Message1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "2c429418-efa2-4357-ba0a-c02758bbd000",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -4256,
        1104
      ],
      "id": "d461918f-f601-4650-91e9-64945b2a94c9",
      "name": "chat_bot",
      "webhookId": "2c429418-efa2-4357-ba0a-c02758bbd000"
    },
    {
      "parameters": {
        "url": "={{ $('chat_bot').item.json.body.message.photo_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3216,
        1232
      ],
      "id": "cc2f17ad-ae0f-4de4-8d8e-168923554a6f",
      "name": "Download Image",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://f19-zpc.zdn.vn/jpg/3991656014868884191/603153a06fd3e08db9c2.jpg",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3216,
        912
      ],
      "id": "51860a75-3585-416b-89bc-81d278165b61",
      "name": "Download Voice",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Z1WZcw2zQ2CvRsskYR5JqlAPW3xfYpUcGIZr31UgM6U",
          "mode": "list",
          "cachedResultName": "Agent Log",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Z1WZcw2zQ2CvRsskYR5JqlAPW3xfYpUcGIZr31UgM6U/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Trang t√≠nh1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Z1WZcw2zQ2CvRsskYR5JqlAPW3xfYpUcGIZr31UgM6U/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $now.format('yyyy-MM-dd hh:m a') }}",
            "Workflow": "={{ $workflow.name }}",
            "Input": "={{ $('Input').item.json.body.message.text }}",
            "Total tokens": "={{ $json.total_tokens }}",
            "Token": "={{ JSON.stringify($json.steps, null, 2) }}",
            "Output": "={{ $('Tro ly chinh').item.json.output }}",
            "Actions": "={{ JSON.stringify($json.steps, null, 2) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Workflow",
              "displayName": "Workflow",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Input",
              "displayName": "Input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Output",
              "displayName": "Output",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Actions",
              "displayName": "Actions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Token",
              "displayName": "Token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Total tokens",
              "displayName": "Total tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1472,
        960
      ],
      "id": "098df115-d4e1-4884-aa9f-2e814eddd9d2",
      "name": "Agent Log",
      "retryOnFail": true,
      "maxTries": 5,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "k9q7ceY6SMWzzelv",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "description": "=# ‚ö†Ô∏è QUY T·∫ÆC B·∫ÆT BU·ªòC - ƒê·ªåC TR∆Ø·ªöC KHI TR·∫¢ L·ªúI\n\n## QUAN TR·ªåNG NH·∫§T: KHI T·∫†O B√ÅO GI√Å\nKhi s·∫øp y√™u c·∫ßu \"t·∫°o b√°o gi√°\", \"l·∫≠p b√°o gi√°\", \"t·∫°o l·∫°i b√°o gi√°\", \"l√†m b√°o gi√°\", \"b√°o gi√° cho kh√°ch\", \"t√≠nh gi√°\", \"l√™n ƒë∆°n\":\n‚Üí PH·∫¢I tr·∫£ v·ªÅ JSON `create_quote` ·ªü cu·ªëi response\n‚Üí KH√îNG ƒê∆Ø·ª¢C ch·ªâ tr·∫£ l·ªùi text m√¥ t·∫£ m√† thi·∫øu JSON\n‚Üí N·∫øu thi·∫øu JSON ‚Üí File b√°o gi√° KH√îNG ƒë∆∞·ª£c t·∫°o!\n\n---\n\n# OVERVIEW\nB·∫°n l√† Tr·ª£ l√Ω K·∫ø to√°n chuy√™n tr√°ch c·ªßa x∆∞·ªüng n·ªôi th·∫•t MinhKhoa.\n\n# CONTEXT\n{{ $json.customerContext }}\n{{ $json.learningContext }}\n\n# TOOLS & RULES\n1. Calculator: B·∫ÆT BU·ªòC d√πng ƒë·ªÉ t√≠nh to√°n m·ªçi con s·ªë. KH√îNG t√≠nh nh·∫©m.\n2. Tra c·ª©u: D√πng tools (San pham, Vat lieu, Ton kho) ƒë·ªÉ l·∫•y d·ªØ li·ªáu.\n\n# OUTPUT FORMAT\n1. L·ªùi tho·∫°i:\n   - Text thu·∫ßn, KH√îNG d√πng markdown (**, ##, ```)\n   - X∆∞ng h√¥: \"em\" - \"s·∫øp\"\n   - S·ªë ti·ªÅn: d·∫•u ch·∫•m ph√¢n c√°ch (1.500.000 VNƒê)\n\n2. JSON Action: ƒê·∫∑t ·ªü CU·ªêI C√ôNG response khi c·∫ßn h√†nh ƒë·ªông\n\n---\n\n# ACTION SCENARIOS\n\n## 1. T·∫†O B√ÅO GI√Å M·ªöI\nT·ª´ kh√≥a: \"t·∫°o b√°o gi√°\", \"l·∫≠p b√°o gi√°\", \"t·∫°o l·∫°i\", \"l√†m b√°o gi√°\", \"b√°o gi√° cho\", \"t√≠nh gi√°\", \"l√™n ƒë∆°n\"\n\nQuy tr√¨nh:\n1. D√πng Calculator t√≠nh to√°n\n2. Tr·∫£ l·ªùi ng·∫Øn: \"D·∫°, em ƒë√£ t√≠nh xong b√°o gi√° cho [T√™n kh√°ch]. T·ªïng c·ªông: X VNƒê\"\n3. ƒê√çNH K√àM JSON (B·∫ÆT BU·ªòC):\n\n```json\n{\n  \"action\": \"create_quote\",\n  \"data\": {\n    \"customerName\": \"T√™n kh√°ch\",\n    \"customerPhone\": \"SƒêT\",\n    \"customerAddress\": \"ƒê·ªãa ch·ªâ\",\n    \"items\": [\n      {\n        \"name\": \"T√™n s·∫£n ph·∫©m\",\n        \"size\": \"1800 x 2000 x 600 mm\",\n        \"material\": \"V·∫≠t li·ªáu\",\n        \"quantity\": 1,\n        \"unitPrice\": 1000000,\n        \"amount\": 1000000,\n        \"note\": \"Ghi ch√∫\"\n      }\n    ],\n    \"subtotal\": 1000000,\n    \"profitPercent\": 25,\n    \"profit\": 250000,\n    \"priceBeforeVAT\": 1250000,\n    \"vat\": 125000,\n    \"totalAmount\": 1375000\n  }\n}\n```\n\nGi·∫£i th√≠ch fields:\n- unitPrice = Gi√° b√°n 1 s·∫£n ph·∫©m (ƒë√£ t√≠nh l·ª£i nhu·∫≠n, CH∆ØA VAT)\n- amount = unitPrice √ó quantity\n- subtotal = T·ªïng chi ph√≠ s·∫£n xu·∫•t (ch∆∞a l·ª£i nhu·∫≠n)\n- profit = subtotal √ó profitPercent / 100\n- priceBeforeVAT = subtotal + profit\n- vat = priceBeforeVAT √ó 10%\n- totalAmount = priceBeforeVAT + vat\n- T·∫•t c·∫£ s·ªë ti·ªÅn l√† NUMBER, kh√¥ng c√≥ d·∫•u ch·∫•m\n\n## 2. G·ª¨I L·∫†I PDF/FILE\nT·ª´ kh√≥a: \"g·ª≠i pdf\", \"g·ª≠i l·∫°i file\", \"t·∫£i pdf\", \"m·ªói pdf\", \"ch·ªâ c·∫ßn file\"\n\n‚Üí CH·ªà tr·∫£ v·ªÅ: \"ƒê√¢y l√† file PDF b√°o gi√° [m√£]: [link_pdf]\"\n‚Üí KH√îNG t·∫°o b√°o gi√° m·ªõi\n‚Üí KH√îNG m√¥ t·∫£ chi ti·∫øt\n\n## 3. H·ªéI ƒê√ÅP TH√îNG TH∆Ø·ªúNG\nT·ª´ kh√≥a: h·ªèi gi√° v·∫≠t li·ªáu, tra c·ª©u s·∫£n ph·∫©m, t·ªìn kho...\n\n‚Üí Tr·∫£ l·ªùi text b√¨nh th∆∞·ªùng\n‚Üí KH√îNG c·∫ßn JSON\n\n## 4. L∆ØU TH√îNG TIN H·ªåC\nKhi s·∫øp d·∫°y ki·∫øn th·ª©c m·ªõi ho·∫∑c s·ª≠a sai\n\n```json\n{\n  \"action\": \"learn\",\n  \"data\": {\n    \"type\": \"knowledge|preference|correction\",\n    \"content\": \"N·ªôi dung h·ªçc\",\n    \"wrong\": \"N·∫øu l√† correction - c√°i sai\",\n    \"correct\": \"N·∫øu l√† correction - c√°i ƒë√∫ng\"\n  }\n}\n```\n\n## 5. L∆ØU KH√ÅCH H√ÄNG\nKhi c√≥ th√¥ng tin kh√°ch h√†ng m·ªõi\n\n```json\n{\n  \"action\": \"save_customer\",\n  \"data\": {\n    \"name\": \"T√™n kh√°ch\",\n    \"phone\": \"SƒêT\",\n    \"address\": \"ƒê·ªãa ch·ªâ\",\n    \"email\": \"Email\"\n  }\n}\n```\n\n---\n\n# V√ç D·ª§ RESPONSE ƒê√öNG\n\n## V√≠ d·ª• 1: T·∫°o b√°o gi√°\nUser: \"T·∫°o b√°o gi√° cho kh√°ch Nguy·ªÖn VƒÉn A, 2 t·ªß qu·∫ßn √°o 3 c√°nh\"\n\nResponse:\nD·∫°, em ƒë√£ t√≠nh xong b√°o gi√° cho kh√°ch Nguy·ªÖn VƒÉn A. T·ªïng c·ªông l√† 15.125.000 VNƒê (ƒë√£ bao g·ªìm VAT 10%).\n\n```json\n{\n  \"action\": \"create_quote\",\n  \"data\": {\n    \"customerName\": \"Nguy·ªÖn VƒÉn A\",\n    \"customerPhone\": \"Ch∆∞a cung c·∫•p\",\n    \"customerAddress\": \"Ch∆∞a cung c·∫•p\",\n    \"items\": [\n      {\n        \"name\": \"T·ªß qu·∫ßn √°o 3 c√°nh\",\n        \"size\": \"1800 x 2200 x 600 mm\",\n        \"material\": \"G·ªó c√¥ng nghi·ªáp MDF\",\n        \"quantity\": 2,\n        \"unitPrice\": 5500000,\n        \"amount\": 11000000,\n        \"note\": \"\"\n      }\n    ],\n    \"subtotal\": 8800000,\n    \"profitPercent\": 25,\n    \"profit\": 2200000,\n    \"priceBeforeVAT\": 11000000,\n    \"vat\": 1100000,\n    \"totalAmount\": 12100000\n  }\n}\n```\n\n## V√≠ d·ª• 2: G·ª≠i l·∫°i PDF\nUser: \"G·ª≠i l·∫°i m·ªói pdf th√¥i\"\n\nResponse:\nƒê√¢y l√† file PDF b√°o gi√° BG-20251220-123: https://res.cloudinary.com/.../BG-20251220-123.pdf\n\n## V√≠ d·ª• 3: H·ªèi ƒë√°p\nUser: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n\nResponse:\nD·∫°, gi√° g·ªó s·ªìi hi·ªán t·∫°i l√† 15.000.000 VNƒê/m3 ·∫°.\n\n---\n\n# L∆ØU √ù CU·ªêI\n- LU√îN d√πng Calculator khi t√≠nh to√°n\n- LU√îN ƒë√≠nh k√®m JSON khi t·∫°o b√°o gi√°\n- KH√îNG d√πng markdown trong text\n- JSON ph·∫£i ·ªü CU·ªêI C√ôNG response\n- S·ªë trong JSON l√† NUMBER (kh√¥ng c√≥ d·∫•u ch·∫•m)\n- S·ªë trong text l√† STRING (c√≥ d·∫•u ch·∫•m: 1.500.000)",
        "workflowId": {
          "__rl": true,
          "value": "2AKCYsUUcOUMdi4M",
          "mode": "list",
          "cachedResultUrl": "/workflow/2AKCYsUUcOUMdi4M",
          "cachedResultName": "Tro ly ke toan"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "prompt": "={{ $json.prompt }}",
            "type": "={{ $json.type }}",
            "content": "={{ $json.content }}",
            "metadata": "={{ $json.metadata }}",
            "imageUrl": "={{ $json.imageUrl }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "prompt",
              "displayName": "prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "type",
              "displayName": "type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "content",
              "displayName": "content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "metadata",
              "displayName": "metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "imageUrl",
              "displayName": "imageUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        80,
        1648
      ],
      "id": "8ca325d7-83c6-4c81-a888-6c7284ce9c4d",
      "name": "Tro ly ke toan"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "ƒê√¢y l√† ·∫£nh gi?",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -2512,
        1152
      ],
      "id": "86ee7269-65d0-4c60-aac1-7ef5341a655a",
      "name": "Analyze an image",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "dd907e87-49ce-4525-862c-54059820173b",
              "leftValue": "={{ $('chat_bot').first().json.body.message.caption || $json.caption || '' }}",
              "rightValue": "ph√¢n t√≠ch",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "d22d6c30-11fb-4d49-a43a-ee458ac670f7",
              "leftValue": "={{ $('chat_bot').first().json.body.message.caption || $json.caption || '' }}",
              "rightValue": "xem",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "7ce92bce-4a09-477f-905c-dccb07e5e129",
              "leftValue": "={{ $('chat_bot').first().json.body.message.caption || $json.caption || '' }}",
              "rightValue": "ƒë·ªçc",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "f420f5d0-2c66-42b8-8647-6c342f306b59",
              "leftValue": "={{ $('chat_bot').first().json.body.message.caption || $json.caption || '' }}",
              "rightValue": "analyze",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "e5b80510-f153-43cd-8cb7-5da472023b88",
              "leftValue": "={{ $('chat_bot').first().json.body.message.caption || $json.caption || '' }}",
              "rightValue": "=m√¥ t·∫£",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "25a3e8c6-d7ae-4f20-8983-aee8a72e6449",
              "leftValue": "={{ $('chat_bot').first().json.body.message.caption || $json.caption || '' }}",
              "rightValue": "l√† g√¨",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2784,
        1232
      ],
      "id": "bab906e0-5ddb-4c99-87b4-6d4dacd01d8c",
      "name": "Check Caption Analyze"
    },
    {
      "parameters": {
        "url": "={{ $('chat_bot').item.json.body.message.from.id }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3216,
        1488
      ],
      "id": "749722a0-9c52-4b15-a559-c6bc1aeac4ad",
      "name": "Download Documents",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const longText = $('Tro ly chinh').first().json.output || \"\"; \nconst limit = 1900; \n\nconst chunks = [];\nfor (let i = 0; i < longText.length; i += limit) {\n  chunks.push({\n    json: {\n      message_part: longText.substring(i, i + limit)\n    }\n  });\n}\n\nreturn chunks;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        400
      ],
      "id": "44b37d89-6893-4b40-af9d-caa4fabe2615",
      "name": "Split Response"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -3952,
        2288
      ],
      "id": "7b750ef7-7ce8-42ee-afb7-6c00cb118542",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendChatAction",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "action",
              "value": "typing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4032,
        1104
      ],
      "id": "44017e9a-b4d0-49ff-a1ec-ae7942103f33",
      "name": "Send Processing Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/setWebhook",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "url",
              "value": "https://n8n.minhkhoaagent.top/webhook/2c429418-efa2-4357-ba0a-c02758bbd000"
            },
            {
              "name": "secret_token",
              "value": "12345678"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -4192,
        2032
      ],
      "id": "780f2705-7894-4004-ac77-b4a68c04eb44",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').item.json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.error }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2144,
        1792
      ],
      "id": "54025e32-52a0-42a5-a915-bbe089fd066c",
      "name": "Error Message"
    },
    {
      "parameters": {
        "description": "G·ªçi c√¥ng c·ª• n√†y khi s·∫øp D·∫†Y ki·∫øn th·ª©c m·ªõi, S·ª¨A SAI, ho·∫∑c b·∫£o GHI NH·ªö th√¥ng tin. \nV√≠ d·ª•: \"Nh·ªõ l√† gi√° g·ªó s·ªìi 15 tri·ªáu/m3\", \"Sai r·ªìi, ph·∫£i l√†...\", \"Ghi nh·ªõ kh√°ch A th√≠ch m√†u tr·∫Øng\"\nInput: N·ªôi dung c·∫ßn ghi nh·ªõ (text)",
        "workflowId": {
          "__rl": true,
          "value": "BKK33Pu7stWD1pR1",
          "mode": "list",
          "cachedResultUrl": "/workflow/BKK33Pu7stWD1pR1",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.query }}",
            "action": "search"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        592,
        1648
      ],
      "id": "45164847-5d54-4d49-932b-6b2d6bb5685e",
      "name": "Save Knowledge (Write)"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.responseType }}",
                    "rightValue": "quote_new",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Quote New"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.responseType }}",
                    "rightValue": "send_pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Send PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.responseType }}",
                    "rightValue": "send_image",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Send Image"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -336,
        208
      ],
      "id": "e7277490-3f42-47a7-b005-d6b5bfc8fd42",
      "name": "Response Type"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendPhoto",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "photo",
              "value": "={{ $json.imageUrl }}"
            },
            {
              "name": "caption",
              "value": "=üìã B√°o gi√° {{ $json.quoteNumber }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        0
      ],
      "id": "93679a97-45d2-4a71-914b-a963eca4e84c",
      "name": "SendPhoto (Quote)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ 'S·∫øp ∆°i, em ƒë√£ t·∫°o b√°o gi√° ' + $('Extract Quote Data').first().json.quoteNumber + ' xong ·∫°!\\n\\nüìã Chi ti·∫øt trong ·∫£nh ph√≠a tr√™n.' + ($('Extract Quote Data').first().json.pdfUrl ? '\\n\\nüìÑ T·∫£i PDF: ' + $('Extract Quote Data').first().json.pdfUrl : '\\n\\nN·∫øu c·∫ßn file PDF, s·∫øp b√°o em nh√©!') }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        224,
        0
      ],
      "id": "8442c143-9e93-43aa-a0b1-e417b3f3125b",
      "name": "SendMessage (After Photo)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendSticker",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "sticker",
              "value": "442d73e94faca6f2ffbd"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        448,
        0
      ],
      "id": "6a144b08-1c98-41c9-97e4-de1be4d4003b",
      "name": "SendSticker (Success)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ 'D·∫°, ƒë√¢y l√† file PDF b√°o gi√° ' + $json.quoteNumber + ':\\n\\nüìÑ ' + $json.pdfUrl }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        160
      ],
      "id": "0ffa2306-57e9-4250-b73c-5bd3528ff397",
      "name": "SendMessage (PDF Only)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot${BOT_TOKEN}/sendPhoto",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "photo",
              "value": "={{ $json.imageUrl }}"
            },
            {
              "name": "caption",
              "value": "=üìã ·∫¢nh b√°o gi√° {{ $json.quoteNumber }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        320
      ],
      "id": "cd9484f9-0d2f-45de-a59e-b2ca12c4eb41",
      "name": "SendPhoto (Image Only)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        480
      ],
      "id": "aaec327e-c3e2-499d-9dae-4b4019882b84",
      "name": "SendMessage (Text Only)"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\nlet output = item.output || item.message_part || '';\nconst cleanOutput = output.replace(/\\\\n/g, ' ').replace(/\\n/g, ' ');\n\nlet imageUrl = '';\nlet pdfUrl = '';\nlet quoteNumber = '';\nlet responseType = 'text_only';\n\n// T√¨m URLs\nconst imgMatch = cleanOutput.match(/https:\\/\\/res\\.cloudinary\\.com\\/[^\\s\"<>]+\\.(png|jpg|jpeg)/i);\nif (imgMatch) {\n  imageUrl = imgMatch[0].trim();\n}\n\nconst pdfMatch = cleanOutput.match(/https:\\/\\/res\\.cloudinary\\.com\\/[^\\s\"<>]+\\.pdf/i);\nif (pdfMatch) {\n  pdfUrl = pdfMatch[0].trim();\n}\n\n// T√¨m quoteNumber\nconst qnMatch = cleanOutput.match(/BG-\\d{8}-\\d{3}/);\nif (qnMatch) {\n  quoteNumber = qnMatch[0];\n}\n\n// Detect response type - ∆ØU TI√äN THEO TH·ª® T·ª∞\nconst outputLower = output.toLowerCase();\n\n// 1. SEND_PDF: C√≥ PDF link + text ph√π h·ª£p\nif (pdfUrl && (\n    outputLower.includes('ƒë√¢y l√† file pdf') || \n    outputLower.includes('ƒë√¢y l√† pdf') || \n    outputLower.includes('file pdf b√°o gi√°') ||\n    outputLower.includes('t·∫£i pdf') ||\n    outputLower.includes('link pdf') ||\n    (outputLower.includes('pdf') && !outputLower.includes('t·∫°o b√°o gi√°'))\n)) {\n  responseType = 'send_pdf';\n}\n// 2. SEND_IMAGE: C√≥ Image link + text ph√π h·ª£p (kh√¥ng c√≥ PDF)\nelse if (imageUrl && !pdfUrl && (\n    outputLower.includes('ƒë√¢y l√† ·∫£nh') || \n    outputLower.includes('·∫£nh b√°o gi√°')\n)) {\n  responseType = 'send_image';\n}\n// 3. QUOTE_NEW: C√≥ Image + text t·∫°o m·ªõi\nelse if (imageUrl && (\n    outputLower.includes('ƒë√£ t·∫°o b√°o gi√°') || \n    outputLower.includes('em ƒë√£ l·∫≠p b√°o gi√°') ||\n    outputLower.includes('t·∫°o b√°o gi√°') ||\n    outputLower.includes('b√°o gi√° m·ªõi')\n)) {\n  responseType = 'quote_new';\n}\n// 4. TEXT_ONLY: M·∫∑c ƒë·ªãnh\nelse {\n  responseType = 'text_only';\n}\n\n// C·∫Øt ng·∫Øn output\nlet shortOutput = output;\nif (output.length > 1900) {\n  shortOutput = output.substring(0, 1900) + '...';\n}\n\n// Debug log\nconsole.log('Response Type:', responseType);\nconsole.log('PDF URL:', pdfUrl);\nconsole.log('Image URL:', imageUrl);\n\nreturn [{\n  json: {\n    output: shortOutput,\n    imageUrl: imageUrl,\n    pdfUrl: pdfUrl,\n    quoteNumber: quoteNumber,\n    responseType: responseType\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        240
      ],
      "id": "c0d8cd2b-5d65-46eb-9e81-0efc6014b6f4",
      "name": "Extract Quote Data"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\n// 1. L·∫•y output th√¥ t·ª´ AI\nlet rawOutput = item.output || item.message_part || '';\n// Clean text (x√≥a xu·ªëng d√≤ng th·ª´a)\nconst cleanOutput = rawOutput.replace(/\\\\n/g, ' ').replace(/\\n/g, ' ');\n\n// 2. T√¨m URLs (B·∫Øt m·ªçi lo·∫°i link http/https k·∫øt th√∫c b·∫±ng ƒëu√¥i file)\nlet imageUrl = '';\nlet pdfUrl = '';\nlet quoteNumber = '';\n\n// Regex t√¨m ·∫£nh (jpg, png, jpeg, webp) - Kh√¥ng gi·ªõi h·∫°n domain\nconst imgMatch = cleanOutput.match(/(https?:\\/\\/[^\\s\"<>)]+?\\.(?:png|jpg|jpeg|webp))/i);\nif (imgMatch) imageUrl = imgMatch[0].trim();\n\n// Regex t√¨m PDF - Kh√¥ng gi·ªõi h·∫°n domain\nconst pdfMatch = cleanOutput.match(/(https?:\\/\\/[^\\s\"<>)]+?\\.pdf)/i);\nif (pdfMatch) pdfUrl = pdfMatch[0].trim();\n\n// Regex t√¨m M√£ b√°o gi√° (V√≠ d·ª•: BG-2024...)\nconst qnMatch = cleanOutput.match(/(BG-\\d{8}-\\d{3}|QT-\\d{8}-\\d{3})/i);\nif (qnMatch) quoteNumber = qnMatch[0];\n\n// 3. X·ª¨ L√ù RESPONSE TYPE\nlet responseMode = 'text_only'; // M·∫∑c ƒë·ªãnh\nlet finalText = rawOutput;\n\n// T√¨m th·∫ª RESPONSE_TYPE do Prompt sinh ra\nconst typeMatch = rawOutput.match(/RESPONSE_TYPE:\\s*[\"']?([a-zA-Z_]+)[\"']?/i);\n\nif (typeMatch) {\n    const typeFromAI = typeMatch[1].toLowerCase();\n    \n    // Map logic\n    if (typeFromAI.includes('quote_new') || typeFromAI.includes('all')) {\n        responseMode = 'all'; \n    } else if (typeFromAI.includes('send_pdf')) {\n        responseMode = 'pdf';\n    } else if (typeFromAI.includes('send_image')) {\n        responseMode = 'image';\n    } else {\n        responseMode = 'text';\n    }\n\n    // X√≥a d√≤ng RESPONSE_TYPE kh·ªèi tin nh·∫Øn ƒë·ªÉ ƒë·∫πp\n    finalText = rawOutput.replace(/RESPONSE_TYPE:\\s*[\"']?[a-zA-Z_]+[\"']?/gi, '').trim();\n} else {\n    // FALLBACK: N·∫øu AI qu√™n g·∫Øn th·∫ª, t·ª± ƒëo√°n d·ª±a tr√™n vi·ªác c√≥ link hay kh√¥ng\n    if (imageUrl && pdfUrl) {\n        responseMode = 'all';\n    } else if (pdfUrl) {\n        // N·∫øu c√≥ PDF m√† trong text c√≥ t·ª´ kh√≥a '·∫£nh', 'h√¨nh' -> c√≥ th·ªÉ l√† all\n        if (rawOutput.toLowerCase().includes('·∫£nh') || rawOutput.toLowerCase().includes('h√¨nh')) {\n             responseMode = 'all';\n        } else {\n             responseMode = 'pdf';\n        }\n    } else if (imageUrl) {\n        responseMode = 'image';\n    }\n}\n\n// Tr·∫£ v·ªÅ k·∫øt qu·∫£\nreturn [{\n    json: {\n        output: finalText,\n        imageUrl: imageUrl,\n        pdfUrl: pdfUrl,\n        quoteNumber: quoteNumber,\n        response_mode: responseMode\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        400
      ],
      "id": "e4fc9f83-2d82-4683-a030-cd4956922520",
      "name": "X·ª≠ l√Ω Response Type"
    },
    {
      "parameters": {
        "model": "qwen/qwen3-32b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -352,
        1648
      ],
      "id": "4b87fea7-b6f2-400d-a882-5839effb666f",
      "name": "Groq Chat Model",
      "credentials": {
        "groqApi": {
          "id": "VkFyanoifIIhja6j",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. L·∫§Y D·ªÆ LI·ªÜU T·ª™ AGENT\nconst agentItem = $('Tro ly chinh').first().json;\nlet rawOutput = agentItem.output || \"\";\n\n// Clean text\nlet cleanOutput = rawOutput;\nif (cleanOutput) {\n    cleanOutput = cleanOutput.split('\\\\n').join(' ').split('\\n').join(' ');\n}\n\n// 2. KH·ªûI T·∫†O BI·∫æN\nlet imageUrl = '';\nlet pdfUrl = '';\nlet quoteNumber = '';\nlet responseMode = 'text';\n\n// 3. T√åM LINK\n// Regex t√¨m ·∫£nh\nconst imgRegex = /(https?:\\/\\/[^\\s\"<>)]+?\\.(?:png|jpg|jpeg|webp))/i;\nconst imgMatch = cleanOutput.match(imgRegex);\nif (imgMatch) imageUrl = imgMatch[0].trim();\n\n// Regex t√¨m PDF\nconst pdfRegex = /(https?:\\/\\/[^\\s\"<>)]+?\\.pdf)/i;\nconst pdfMatch = cleanOutput.match(pdfRegex);\nif (pdfMatch) pdfUrl = pdfMatch[0].trim();\n\n// Regex t√¨m M√£ b√°o gi√°\nconst qnRegex = /(BG-\\d{8}-\\d{3}|QT-\\d{8}-\\d{3})/i;\nconst qnMatch = cleanOutput.match(qnRegex);\nif (qnMatch) quoteNumber = qnMatch[0];\n\n// 4. X√ÅC ƒê·ªäNH CH·∫æ ƒê·ªò G·ª¨I - ∆ØU TI√äN THEO LINK T√åM ƒê∆Ø·ª¢C\nif (imageUrl && pdfUrl) {\n    responseMode = 'all';\n} else if (imageUrl) {\n    responseMode = 'image';\n} else if (pdfUrl) {\n    responseMode = 'pdf';\n} else {\n    responseMode = 'text';\n}\n\n// 5. L√ÄM S·∫†CH TIN NH·∫ÆN\nlet finalText = rawOutput;\n\n// X√≥a RESPONSE_TYPE n·∫øu c√≥\nfinalText = finalText.replace(/RESPONSE_TYPE:\\s*[\"']?[a-zA-Z_]+[\"']?/gi, '');\n\n// X√≥a link n·∫øu ƒë√£ g·ª≠i ri√™ng\nif (responseMode === 'all' || responseMode === 'image') {\n    if (imageUrl) finalText = finalText.replace(imageUrl, '');\n}\nif (responseMode === 'all' || responseMode === 'pdf') {\n    if (pdfUrl) finalText = finalText.replace(pdfUrl, '');\n}\n\n// X√≥a JSON block trong text (gi·ªØ text s·∫°ch)\nfinalText = finalText.replace(/```json[\\s\\S]*?```/gi, '');\nfinalText = finalText.replace(/\\{[\\s\\S]*?\"action\"[\\s\\S]*?\\}/gi, '');\n\n// Clean up\nfinalText = finalText.replace(/\\n\\s*\\n/g, '\\n').trim();\n\n// Log debug\nconsole.log('Image URL:', imageUrl);\nconsole.log('PDF URL:', pdfUrl);\nconsole.log('Response Mode:', responseMode);\n\nreturn [{\n    json: {\n        output: finalText,\n        imageUrl: imageUrl,\n        pdfUrl: pdfUrl,\n        quoteNumber: quoteNumber,\n        response_mode: responseMode\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1680,
        960
      ],
      "id": "1c2ddf7b-0d88-4938-aff4-c89cae5919c1",
      "name": "Analyze and Get link",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendPhoto",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "photo",
              "value": "={{ $('Analyze and Get link').first().json.imageUrl }}"
            },
            {
              "name": "caption",
              "value": "=üìã B√°o gi√° {{ $('Analyze and Get link').first().json.quoteNumber }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2112,
        800
      ],
      "id": "f551212a-973c-4c4d-ac63-2d01ef74c39d",
      "name": "Send Photo",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-image",
              "leftValue": "={{ $json.imageUrl }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "check-mode",
              "leftValue": "={{ $json.response_mode }}",
              "rightValue": "pdf",
              "operator": {
                "type": "string",
                "operation": "notEquals",
                "name": "filter.operator.notEquals"
              }
            },
            {
              "id": "check-mode-text",
              "leftValue": "={{ $json.response_mode }}",
              "rightValue": "text",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1904,
        960
      ],
      "id": "de5444e7-9f2a-4953-9f71-d89f2eaa4c60",
      "name": "Has Image?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-pdf",
              "leftValue": "={{ $('Analyze and Get link').first().json.pdfUrl }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "check-mode",
              "leftValue": "={{ $('Analyze and Get link').first().json.response_mode }}",
              "rightValue": "image",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "check-mode-text",
              "leftValue": "={{ $('Analyze and Get link').first().json.response_mode }}",
              "rightValue": "text",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2352,
        960
      ],
      "id": "1fba80f1-a633-44d8-b3f5-d313a6867f59",
      "name": "Has PDF?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ 'üìÑ File PDF b√°o gi√° ' + $('Analyze and Get link').first().json.quoteNumber + ':\\n' + $('Analyze and Get link').first().json.pdfUrl }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2592,
        800
      ],
      "id": "a56bc1db-c753-4f0b-96ae-614f6e489e39",
      "name": "Send PDF",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// 1. L·∫§Y D·ªÆ LI·ªÜU\nconst agentItem = $('Tro ly chinh').first().json;\nlet rawOutput = agentItem.output || \"\";\n\n// Clean text\nconst cleanOutput = rawOutput.replace(/\\\\n/g, ' ').replace(/\\n/g, ' ');\n\n// 2. T√åM LINK\nlet imageUrl = '';\nlet pdfUrl = '';\nlet quoteNumber = '';\n\n// B·∫Øt link ·∫£nh\nconst imgMatch = cleanOutput.match(/(https?:\\/\\/[^\\s\"<>)]+?\\.(?:png|jpg|jpeg|webp))/i);\nif (imgMatch) imageUrl = imgMatch[0].trim();\n\n// B·∫Øt link PDF\nconst pdfMatch = cleanOutput.match(/(https?:\\/\\/[^\\s\"<>)]+?\\.pdf)/i);\nif (pdfMatch) pdfUrl = pdfMatch[0].trim();\n\n// B·∫Øt M√£ b√°o gi√°\nconst qnMatch = cleanOutput.match(/(BG-\\d{8}-\\d{3})/i);\nif (qnMatch) quoteNumber = qnMatch[0];\n\n// 3. X√ÅC ƒê·ªäNH RESPONSE MODE\nlet responseMode = 'text';\nif (imageUrl && pdfUrl) responseMode = 'all';\nelse if (imageUrl) responseMode = 'image';\nelse if (pdfUrl) responseMode = 'pdf';\n\n// 4. T·∫†O TIN NH·∫ÆN S·∫†CH\nlet finalText = '';\n\n// N·∫øu c√≥ b√°o gi√° (c√≥ ·∫£nh ho·∫∑c PDF)\nif (responseMode !== 'text' && quoteNumber) {\n    // T√¨m t·ªïng ti·ªÅn trong output\n    const totalMatch = rawOutput.match(/(\\d{1,3}(?:\\.\\d{3})*(?:\\.\\d+)?)\\s*VN[ƒêD]/i);\n    const totalAmount = totalMatch ? totalMatch[1] : '';\n    \n    finalText = `S·∫øp ∆°i, em ƒë√£ t·∫°o b√°o gi√° ${quoteNumber} xong ·∫°!`;\n    \n    if (totalAmount) {\n        finalText += `\\nüí∞ T·ªïng c·ªông: ${totalAmount} VNƒê (ƒë√£ bao g·ªìm VAT 10%)`;\n    }\n    \n    if (pdfUrl) {\n        finalText += `\\n\\nüìÑ T·∫£i PDF: ${pdfUrl}`;\n    } else {\n        finalText += `\\n\\nN·∫øu c·∫ßn file PDF, s·∫øp b√°o em nh√©!`;\n    }\n} else {\n    // Kh√¥ng c√≥ b√°o gi√° - gi·ªØ nguy√™n text nh∆∞ng clean\n    finalText = rawOutput\n        .replace(/RESPONSE_TYPE:\\s*[\"']?[a-zA-Z_]+[\"']?/gi, '')\n        .replace(/```json[\\s\\S]*?```/gi, '')\n        .replace(/\\{[\\s\\S]*?\"action\"[\\s\\S]*?\\}/gi, '')\n        .replace(/Link ·∫£nh preview.*?:/gi, '')\n        .replace(/\\n\\s*\\n/g, '\\n')\n        .trim();\n    \n    // X√≥a link n·∫øu ƒë√£ g·ª≠i ·∫£nh ri√™ng\n    if (imageUrl) finalText = finalText.replace(imageUrl, '');\n    if (pdfUrl) finalText = finalText.replace(pdfUrl, '');\n}\n\n// Clean final\nfinalText = finalText.replace(/\\n\\s*\\n\\s*\\n/g, '\\n\\n').trim();\n\nreturn [{\n    json: {\n        output: finalText,\n        imageUrl: imageUrl,\n        pdfUrl: pdfUrl,\n        quoteNumber: quoteNumber,\n        response_mode: responseMode\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2832,
        960
      ],
      "id": "0bb4f837-6ba9-407b-9680-9f0b9a561e91",
      "name": "Split Text"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').first().json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3056,
        960
      ],
      "id": "8715eaf5-b63c-4227-b285-56491ce57c90",
      "name": "Send Text"
    },
    {
      "parameters": {
        "jsCode": "// Get all items from input\nconst inputItems = $input.all();\n\nfor (let i = 0; i < inputItems.length; i++) {\n  const item = inputItems[i];\n  \n  // L·∫•y photo_url t·ª´ chat_bot\n  try {\n    const chatBotData = $('chat_bot').first().json;\n    item.json.photo_url = chatBotData?.body?.message?.photo_url || '';\n  } catch (e) {\n    item.json.photo_url = '';\n  }\n\n  // Fix MIME type n·∫øu c·∫ßn\n  if (item.binary && item.binary.data) {\n    if (item.binary.data.mimeType === 'image/jpg') {\n      item.binary.data.mimeType = 'image/jpeg';\n      item.binary.data.fileExtension = 'jpeg';\n    }\n  }\n}\n\nreturn inputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2992,
        1232
      ],
      "id": "2c68280b-8e71-400d-8410-1f783e9c22c8",
      "name": "Fix Input Item",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendChatAction",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $('chat_bot').item.json.body.message.from.id }}"
            },
            {
              "name": "action",
              "value": "typing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1120,
        960
      ],
      "id": "acef9044-4db8-4620-811d-4561eee3c875",
      "name": "Send Processing Message2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -3792,
        2288
      ],
      "id": "33ab3fa4-93f3-4404-a053-4e8afa010f8b",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "ZeYl5rYP7Kr1YqY6",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge knowledge context v√†o input cho Workflow ch√≠nh\nconst prepareData = $('Prepare Smart Search').first().json;\nconst originalInput = prepareData.originalInput;\n\n// 1. RAG Results\nlet ragContext = '';\ntry {\n  const searchResult = $('Search Knowledge').first().json;\n  if (searchResult && searchResult.success && searchResult.results && searchResult.results.length > 0) {\n    ragContext = searchResult.results\n      .map(r => `‚Ä¢ [${r.category}] ${r.content}`)\n      .join('\\n');\n  }\n} catch (e) {\n  ragContext = '';\n}\n\n// 2. Tavily Results (n·∫øu c√≥)\nlet webContext = '';\ntry {\n  if (prepareData.needWebSearch) {\n    const tavilyResult = $('Search Tavily').first().json;\n    if (tavilyResult && tavilyResult.answer) {\n      webContext = `T√≥m t·∫Øt: ${tavilyResult.answer}\\n`;\n    }\n    if (tavilyResult && tavilyResult.results && tavilyResult.results.length > 0) {\n      webContext += tavilyResult.results\n        .slice(0, 3)\n        .map(r => `‚Ä¢ ${r.title}: ${r.content.substring(0, 200)}...`)\n        .join('\\n');\n    }\n  }\n} catch (e) {\n  webContext = '';\n}\n\n// 3. Build context\nlet learningContext = '';\n\nif (ragContext) {\n  learningContext += `\n=== KI·∫æN TH·ª®C ƒê√É H·ªåC ===\n${ragContext}\n========================\n`;\n}\n\nif (webContext) {\n  learningContext += `\n=== TH√îNG TIN T·ª™ WEB ===\n${webContext}\n========================\n`;\n}\n\nreturn [{\n  json: {\n    ...originalInput,\n    learningContext: learningContext,\n    hasLearning: ragContext !== '' || webContext !== ''\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        1056
      ],
      "id": "97926d19-60c5-4822-b3f7-6089e778f041",
      "name": "Merge Context"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "BKK33Pu7stWD1pR1",
          "mode": "list",
          "cachedResultUrl": "/workflow/BKK33Pu7stWD1pR1",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.ragQuery || $json.content || $json.prompt || '' }}",
            "action": "search"
          },
          "matchingColumns": [
            "query"
          ],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -1440,
        1056
      ],
      "id": "8910b538-549d-4b1a-b325-7e70b5a36496",
      "name": "Search Knowledge"
    },
    {
      "parameters": {
        "jsCode": "// Chu·∫©n b·ªã search t·ª´ nhi·ªÅu ngu·ªìn cho Workflow ch√≠nh\nconst input = $input.first().json;\n\n// L·∫•y query t·ª´ nhi·ªÅu ngu·ªìn c√≥ th·ªÉ\nconst query = input.content || input.prompt || input.text || '';\nconst queryLower = query.toLowerCase();\n\n// Ph√¢n t√≠ch intent - c√≥ c·∫ßn web search kh√¥ng?\nlet needWebSearch = false;\nlet webSearchQuery = '';\nlet searchType = 'general';\n\nif (queryLower.includes('gi√° th·ªã tr∆∞·ªùng') || queryLower.includes('gi√° hi·ªán t·∫°i') || \n    queryLower.includes('xu h∆∞·ªõng') || queryLower.includes('m·ªõi nh·∫•t') ||\n    queryLower.includes('tin t·ª©c') || queryLower.includes('th·ªùi s·ª±')) {\n  needWebSearch = true;\n  webSearchQuery = query + ' Vi·ªát Nam 2025';\n  searchType = 'market_info';\n}\n\nif (queryLower.includes('ƒë·ªëi th·ªß') || queryLower.includes('th·ªã tr∆∞·ªùng') ||\n    queryLower.includes('so s√°nh')) {\n  needWebSearch = true;\n  webSearchQuery = query + ' n·ªôi th·∫•t Vi·ªát Nam';\n  searchType = 'competitor';\n}\n\nreturn [{\n  json: {\n    originalInput: input,\n    ragQuery: query,\n    needWebSearch: needWebSearch,\n    webSearchQuery: webSearchQuery,\n    searchType: searchType\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1664,
        1056
      ],
      "id": "2dd61173-a310-4102-a5b2-d1b42b9976b4",
      "name": "Prepare Smart Search"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "06b6aed4-daf6-46d1-a841-394b9ffde6ea",
              "leftValue": "={{ $('Prepare Smart Search').item.json.needWebSearch }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -1232,
        1056
      ],
      "id": "0a6e2455-5765-4c35-bcf3-b7fd98cc173b",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Detect knowledge m·ªõi c·∫ßn h·ªçc\nlet agentOutput = '';\nlet userInput = '';\n\ntry {\n  agentOutput = $('Tro ly chinh').first().json.output || '';\n} catch (e) {\n  agentOutput = '';\n}\n\ntry {\n  userInput = $('Input').first().json.content || \n              $('Input').first().json.prompt || \n              $('chat_bot').first().json.body?.message?.text || '';\n} catch (e) {\n  userInput = '';\n}\n\n// Patterns c·∫ßn h·ªçc\nconst learnPatterns = [\n  { pattern: /nh·ªõ (l√†|r·∫±ng|nh√©)/i, category: 'knowledge' },\n  { pattern: /ghi nh·ªõ/i, category: 'knowledge' },\n  { pattern: /t·ª´ (gi·ªù|nay)/i, category: 'preference' },\n  { pattern: /quy ƒë·ªãnh (m·ªõi|l√†)/i, category: 'process' },\n  { pattern: /sai r·ªìi.*(ƒë√∫ng l√†|ph·∫£i l√†)/i, category: 'correction' },\n  { pattern: /kh√¥ng ph·∫£i.*(m√† l√†|l√†)/i, category: 'correction' }\n];\n\nlet shouldLearn = false;\nlet category = 'general';\nlet contentToLearn = userInput;\n\nfor (const item of learnPatterns) {\n  if (item.pattern.test(userInput)) {\n    shouldLearn = true;\n    category = item.category;\n    break;\n  }\n}\n\n// N·∫øu agent x√°c nh·∫≠n ƒë√£ h·ªçc\nif (agentOutput.toLowerCase().includes('ƒë√£ ghi nh·ªõ') || \n    agentOutput.toLowerCase().includes('em nh·ªõ r·ªìi')) {\n  shouldLearn = true;\n}\n\nreturn [{\n  json: {\n    shouldLearn: shouldLearn,\n    contentToLearn: contentToLearn,\n    category: category\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        448,
        960
      ],
      "id": "4b115fc5-3497-4baf-8db5-64ee7f341f13",
      "name": "Detect New Knowledge"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cbc74e48-ef2f-455d-8326-3aa17e03042c",
              "leftValue": "={{ $json.shouldLearn }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        656,
        960
      ],
      "id": "04cbed27-5346-4281-9290-95f95a1f1e65",
      "name": "If Should Learn"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "x2L5rQZ1DPGBD6zJ",
          "mode": "list",
          "cachedResultUrl": "/workflow/x2L5rQZ1DPGBD6zJ",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.query }}",
            "action": "save",
            "category": "={{ $json.category }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        880,
        864
      ],
      "id": "2c47882e-91ec-4d7b-beaf-60f0997672fa",
      "name": "Execute Save to RAG"
    },
    {
      "parameters": {
        "query": "={{ $('Prepare Smart Search').item.json.webSearchQuery }}",
        "options": {
          "search_depth": "basic",
          "max_results": 5,
          "include_answer": "advanced"
        }
      },
      "type": "@tavily/n8n-nodes-tavily.tavily",
      "typeVersion": 1,
      "position": [
        -1024,
        960
      ],
      "id": "b3ccc7ec-e1e5-4c1a-bfd9-2538bc8dbe02",
      "name": "Search Tavily",
      "credentials": {
        "tavilyApi": {
          "id": "pY0x9kpc8XPIIprO",
          "name": "Tavily account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const queryHash = prepareData.webSearchQuery\n  .toLowerCase()\n  .replace(/[^a-z0-9]/g, '')\n  .substring(0, 50);\n\n// Th√™m v√†o return\nreturn [{\n  json: {\n    shouldSave: shouldSave,\n    contentToSave: contentToSave,\n    category: category,\n    queryHash: queryHash,  // D√πng ƒë·ªÉ check tr√πng sau n√†y\n    originalQuery: prepareData.webSearchQuery,\n    answerLength: tavilyResult?.answer?.length || 0\n  }\n}];\n\n// Ki·ªÉm tra ch·∫•t l∆∞·ª£ng k·∫øt qu·∫£ Tavily ƒë·ªÉ quy·∫øt ƒë·ªãnh c√≥ l∆∞u kh√¥ng\nconst tavilyResult = $input.first().json;\nconst prepareData = $('Prepare Smart Search').first().json;\n\nlet shouldSave = false;\nlet contentToSave = '';\nlet category = 'market_info';\n\n// Ki·ªÉm tra c√≥ answer ch·∫•t l∆∞·ª£ng kh√¥ng\nif (tavilyResult && tavilyResult.answer && tavilyResult.answer.length > 100) {\n  shouldSave = true;\n  \n  // T·∫°o content c√≥ c·∫•u tr√∫c ƒë·ªÉ l∆∞u\n  const timestamp = new Date().toISOString().slice(0, 10);\n  contentToSave = `[WEB ${timestamp}] ${prepareData.webSearchQuery}: ${tavilyResult.answer}`;\n  \n  // Ph√¢n lo·∫°i category d·ª±a tr√™n query\n  const queryLower = prepareData.webSearchQuery.toLowerCase();\n  if (queryLower.includes('gi√°') || queryLower.includes('chi ph√≠')) {\n    category = 'market_price';\n  } else if (queryLower.includes('xu h∆∞·ªõng') || queryLower.includes('trend')) {\n    category = 'market_trend';\n  } else if (queryLower.includes('ƒë·ªëi th·ªß') || queryLower.includes('c·∫°nh tranh')) {\n    category = 'competitor';\n  } else {\n    category = 'market_info';\n  }\n}\n\n// Kh√¥ng l∆∞u n·∫øu k·∫øt qu·∫£ qu√° ng·∫Øn ho·∫∑c kh√¥ng c√≥ answer\nif (tavilyResult.answer && tavilyResult.answer.length < 50) {\n  shouldSave = false;\n}\n\nreturn [{\n  json: {\n    shouldSave: shouldSave,\n    contentToSave: contentToSave,\n    category: category,\n    originalQuery: prepareData.webSearchQuery,\n    answerLength: tavilyResult?.answer?.length || 0\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        960
      ],
      "id": "0e9e6c56-4c9a-4625-a9a8-95e3be82b9e7",
      "name": "Check Tavily Quality"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "c5512534-5da6-4804-ba93-2cd832aff8a4",
              "leftValue": "={{ $json.shouldSave }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -608,
        960
      ],
      "id": "1ef3421e-85c6-4628-8cfb-6f466a97b4ed",
      "name": "If Good Result"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "x2L5rQZ1DPGBD6zJ",
          "mode": "list",
          "cachedResultUrl": "/workflow/x2L5rQZ1DPGBD6zJ",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.contentToSave }}",
            "action": "save",
            "category": "={{ $json.category }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -384,
        864
      ],
      "id": "473fdabd-0d02-4350-aa9b-b92121616c2a",
      "name": "Auto Save Web Knowledge"
    },
    {
      "parameters": {
        "jsCode": "const saveResult = $input.first().json;\n\nconsole.log('=== AUTO SAVE WEB KNOWLEDGE ===');\nconsole.log('Saved:', saveResult.success ? 'YES' : 'NO');\nconsole.log('Content:', saveResult.message || 'N/A');\n\nreturn [{ json: { logged: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        864
      ],
      "id": "c23dc645-cb2f-480a-80a1-fb8eb010e0ac",
      "name": "Log Save Result"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "T√¨m ki·∫øm th√¥ng tin M·ªöI NH·∫§T tr√™n internet. S·ª≠ d·ª•ng khi:\n- S·∫øp h·ªèi gi√° th·ªã tr∆∞·ªùng, gi√° ngo√†i, gi√° hi·ªán t·∫°i\n- C·∫ßn th√¥ng tin ƒë·ªëi th·ªß c·∫°nh tranh\n- C·∫ßn xu h∆∞·ªõng n·ªôi th·∫•t m·ªõi nh·∫•t\n- C·∫ßn tin t·ª©c ng√†nh\n- C·∫ßn th√¥ng tin c√¥ng ty ho·∫∑c kh√°ch h√†ng\n- B·∫•t k·ª≥ th√¥ng tin n√†o c·∫ßn c·∫≠p nh·∫≠t real-time\n\nKH√îNG d√πng cho gi√° c·ªßa x∆∞·ªüng MinhKhoa, d√πng ki·∫øn th·ª©c ƒë√£ h·ªçc thay th·∫ø.",
        "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query', ``, 'string') }}",
        "options": {
          "search_depth": "advanced",
          "max_results": 5,
          "include_answer": "advanced"
        }
      },
      "type": "@tavily/n8n-nodes-tavily.tavilyTool",
      "typeVersion": 1,
      "position": [
        752,
        1648
      ],
      "id": "c7625f01-4b70-4db0-941b-f75da63aa5f1",
      "name": "Search in Tavily",
      "credentials": {
        "tavilyApi": {
          "id": "pY0x9kpc8XPIIprO",
          "name": "Tavily account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\"status\": \"ok\"}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        -3824,
        1104
      ],
      "id": "6214d70c-a177-472b-af6c-3ebfd4771d0b",
      "name": "Respond to Webhook"
    }
  ],
  "pinData": {},
  "connections": {
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Clean Up": {
      "main": [
        [
          {
            "node": "Agent Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Download Voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input": {
      "main": [
        [
          {
            "node": "Prepare Smart Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly Email": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly chinh": {
      "main": [
        [
          {
            "node": "Detect New Knowledge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly lich": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly ky thuat": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If File Size < 20MB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If File Size < 20MB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze document": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If File Size < 20MB": {
      "main": [
        [
          {
            "node": "CAD to PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CAD to PDF": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "chat_bot": {
      "main": [
        [
          {
            "node": "Send Processing Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image": {
      "main": [
        [
          {
            "node": "Fix Input Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent Log": {
      "main": [
        [
          {
            "node": "Analyze and Get link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly ke toan": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Analyze an image": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Caption Analyze": {
      "main": [
        [
          {
            "node": "Analyze an image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Documents": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Response": {
      "main": [
        [
          {
            "node": "X·ª≠ l√Ω Response Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Processing Message": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Knowledge (Write)": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Response Type": {
      "main": [
        [
          {
            "node": "SendPhoto (Quote)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SendMessage (PDF Only)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SendPhoto (Image Only)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SendMessage (Text Only)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SendPhoto (Quote)": {
      "main": [
        [
          {
            "node": "SendMessage (After Photo)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SendMessage (After Photo)": {
      "main": [
        [
          {
            "node": "SendSticker (Success)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Quote Data": {
      "main": [
        [
          {
            "node": "Response Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Analyze and Get link": {
      "main": [
        [
          {
            "node": "Has Image?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Photo": {
      "main": [
        [
          {
            "node": "Has PDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Image?": {
      "main": [
        [
          {
            "node": "Send Photo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Has PDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has PDF?": {
      "main": [
        [
          {
            "node": "Send PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send PDF": {
      "main": [
        [
          {
            "node": "Split Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Text": {
      "main": [
        [
          {
            "node": "Send Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Input Item": {
      "main": [
        [
          {
            "node": "Check Caption Analyze",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Processing Message2": {
      "main": [
        [
          {
            "node": "Clean Up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Context": {
      "main": [
        [
          {
            "node": "Tro ly chinh",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Knowledge": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Smart Search": {
      "main": [
        [
          {
            "node": "Search Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Search Tavily",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect New Knowledge": {
      "main": [
        [
          {
            "node": "If Should Learn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Should Learn": {
      "main": [
        [
          {
            "node": "Execute Save to RAG",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Processing Message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Save to RAG": {
      "main": [
        [
          {
            "node": "Send Processing Message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Tavily": {
      "main": [
        [
          {
            "node": "Check Tavily Quality",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Tavily Quality": {
      "main": [
        [
          {
            "node": "If Good Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Good Result": {
      "main": [
        [
          {
            "node": "Auto Save Web Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto Save Web Knowledge": {
      "main": [
        [
          {
            "node": "Log Save Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Save Result": {
      "main": [
        [
          {
            "node": "Agent Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search in Tavily": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Respond to Webhook": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false
  },
  "versionId": "e1b2fe7a-0cf0-40aa-aeab-cec40360299e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f79905368cdd8aefd97993159c6f1b332d2bef60e6af085cda589aa3db810691"
  },
  "id": "YX8wItpplTDz8hhp",
  "tags": []
}
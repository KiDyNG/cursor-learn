{
  "name": "Tro ly chinh",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "seconds",
              "secondsInterval": 2
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -2576,
        3024
      ],
      "id": "b07a5249-9850-45b3-93c1-2a6b60f478ac",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "url": "https://zamexodnbxgmazdnajtd.supabase.co/rest/v1/rpc/get_ready_buffers",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbWV4b2RuYnhnbWF6ZG5hanRkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjU5ODM1MiwiZXhwIjoyMDgyMTc0MzUyfQ.mAC3J7FD9ZY3RJL3hf7QSly_QoelpVmhERIe0NPnQHA"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbWV4b2RuYnhnbWF6ZG5hanRkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjU5ODM1MiwiZXhwIjoyMDgyMTc0MzUyfQ.mAC3J7FD9ZY3RJL3hf7QSly_QoelpVmhERIe0NPnQHA"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2368,
        3024
      ],
      "id": "b836cfe2-cdf3-42b8-8c65-71f2e70860bc",
      "name": "Get Pending Message"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "has-message-check",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2176,
        3024
      ],
      "id": "2d208db8-5d67-43a8-ac00-384e10ea4bfc",
      "name": "Has message?"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://zamexodnbxgmazdnajtd.supabase.co/rest/v1/message_buffer",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbWV4b2RuYnhnbWF6ZG5hanRkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjU5ODM1MiwiZXhwIjoyMDgyMTc0MzUyfQ.mAC3J7FD9ZY3RJL3hf7QSly_QoelpVmhERIe0NPnQHA"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbWV4b2RuYnhnbWF6ZG5hanRkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjU5ODM1MiwiZXhwIjoyMDgyMTc0MzUyfQ.mAC3J7FD9ZY3RJL3hf7QSly_QoelpVmhERIe0NPnQHA"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"status\": \"processing\",\n  \"processing_started_at\": {{ JSON.stringify($now.toISO()) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1968,
        3024
      ],
      "id": "799ee0fa-8450-409c-a57b-54910a1138a1",
      "name": "Lock message"
    },
    {
      "parameters": {
        "jsCode": "// Convert queue message to format compatible with old workflow\nconst queueData = $input.first().json;\nconst rawData = queueData.raw_data || {};\n\n// Reconstruct message structure similar to webhook format\nreturn [{\n  json: {\n    body: {\n      message: {\n        text: queueData.text || \"\",\n        caption: queueData.caption || \"\",\n        photo_url: queueData.photo_url || \"\",\n        voice: queueData.voice_file_id ? { file_id: queueData.voice_file_id } : null,\n        document: queueData.document || null,\n        from: {\n          id: queueData.user_id,\n          first_name: queueData.user_name\n        },\n        chat: {\n          id: queueData.chat_id\n        },\n        message_id: queueData.message_id\n      }\n    },\n    // Keep queue data for reference\n    queue_id: queueData.id,\n    chat_id: queueData.chat_id,\n    user_id: queueData.user_id\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1776,
        3024
      ],
      "id": "a1d4bed2-d14c-4108-8167-6f18f1a9746e",
      "name": "Convert Queue Data"
    },
    {
      "parameters": {
        "description": "S·ª≠ d·ª•ng c√¥ng c·ª• n√†y ƒë·ªÉ suy nghƒ© v·ªÅ m·ªôt v·∫•n ƒë·ªÅ n√†o ƒë√≥. N√≥ s·∫Ω kh√¥ng thu th·∫≠p th√¥ng tin m·ªõi ho·∫∑c thay ƒë·ªïi c∆° s·ªü d·ªØ li·ªáu, m√† ch·ªâ th√™m suy nghƒ© ƒë√≥ v√†o nh·∫≠t k√Ω. S·ª≠ d·ª•ng c√¥ng c·ª• n√†y khi c·∫ßn suy lu·∫≠n ph·ª©c t·∫°p ho·∫∑c b·ªô nh·ªõ ƒë·ªám."
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        1936,
        3568
      ],
      "id": "7cd83a7a-62c2-4658-ad9f-ffc4ba9e57d5",
      "name": "Think",
      "notesInFlow": false
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.body.message.from.id }}",
        "databaseName": "MinhKhoaAI",
        "contextWindowLength": 50
      },
      "type": "@n8n/n8n-nodes-langchain.memoryMongoDbChat",
      "typeVersion": 1,
      "position": [
        1792,
        3568
      ],
      "id": "3662caeb-b09c-4e46-88c1-79ed83a39b75",
      "name": "MongoDB Chat Memory",
      "credentials": {
        "mongoDb": {
          "id": "wR5t7Mbd0bIPSXcv",
          "name": "MongoDB account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Initialize the output arrays\nconst steps = [];\nconst tokens = [];\nlet totalTokens = 0; // Changed to track total tokens instead of cost\n\n// Process each item in the input\nfor (const item of $input.all()) {\n  let data = item.json;\n  \n  // Check if the data is an array itself (like your example JSON)\n  if (Array.isArray(data)) {\n    // Process each object in the array\n    for (const obj of data) {\n      // Extract steps information\n      if (obj.intermediateSteps && Array.isArray(obj.intermediateSteps)) {\n        for (const step of obj.intermediateSteps) {\n          if (step.action) {\n            steps.push({\n              tool: step.action.tool,\n              toolInput: step.action.toolInput,\n              observation: step.observation\n            });\n          }\n        }\n      }\n      \n      // Extract token information\n      if (obj.intermediateSteps && Array.isArray(obj.intermediateSteps)) {\n        for (const step of obj.intermediateSteps) {\n          if (step.action && step.action.messageLog && Array.isArray(step.action.messageLog)) {\n            for (const message of step.action.messageLog) {\n              if (message.kwargs && message.kwargs.response_metadata && message.kwargs.response_metadata.usage) {\n                const usage = message.kwargs.response_metadata.usage;\n                tokens.push({\n                  prompt_tokens: usage.prompt_tokens,\n                  completion_tokens: usage.completion_tokens,\n                  total_tokens: usage.total_tokens,\n                  model_name: message.kwargs.response_metadata.model_name\n                });\n                \n                // Add the tokens to our running total\n                if (typeof usage.total_tokens === 'number') {\n                  totalTokens += usage.total_tokens;\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  } else {\n    // If data is not an array, process it as a single object\n    // Extract steps information\n    if (data.intermediateSteps && Array.isArray(data.intermediateSteps)) {\n      for (const step of data.intermediateSteps) {\n        if (step.action) {\n          steps.push({\n            tool: step.action.tool,\n            toolInput: step.action.toolInput,\n            observation: step.observation\n          });\n        }\n      }\n    }\n    \n    // Extract token information\n    if (data.intermediateSteps && Array.isArray(data.intermediateSteps)) {\n      for (const step of data.intermediateSteps) {\n        if (step.action && step.action.messageLog && Array.isArray(step.action.messageLog)) {\n          for (const message of step.action.messageLog) {\n            if (message.kwargs && message.kwargs.response_metadata && message.kwargs.response_metadata.usage) {\n              const usage = message.kwargs.response_metadata.usage;\n              tokens.push({\n                prompt_tokens: usage.prompt_tokens,\n                completion_tokens: usage.completion_tokens,\n                total_tokens: usage.total_tokens,\n                model_name: message.kwargs.response_metadata.model_name\n              });\n              \n              // Add the tokens to our running total\n              if (typeof usage.total_tokens === 'number') {\n                totalTokens += usage.total_tokens;\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n// Return the processed data with total_tokens included\nreturn [{\n  json: {\n    steps: steps,\n    tokens: tokens,\n    total_tokens: totalTokens\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3296,
        2880
      ],
      "id": "c4287d2d-4e9f-4511-ad57-4c16ff9b661c",
      "name": "Clean Up",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.voice.file_id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "c2f3f97f-cca9-472a-b597-b9fc6c6cd232"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8c844924-b2ed-48b0-935c-c66a8fd0c778",
                    "leftValue": "={{ $json.body.message.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "8b435dee-29e5-4ac2-a827-1811c2f6f04d",
                    "leftValue": "={{ $json.body.message.photo_url }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image Only"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "d39eb705-3eb9-4867-8448-9d3e4c72ea4d",
                    "leftValue": "={{ $json.body.message.from.id }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Documents"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45af575c-dd6a-4b8d-9f97-7856f1bda776",
                    "leftValue": "={{ $json.body.message.photo_url }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image + Caption"
            }
          ]
        },
        "options": {}
      },
      "id": "1bc7ef39-fc2c-47af-ae96-c27a1d35d01f",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        2960
      ],
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "976cf2c9-01b6-46cf-97b4-675a67ca57bc",
              "name": "content",
              "value": "={{ $json.body.message.text || $json.body.message?.caption || \"[·∫¢nh ƒë∆∞·ª£c g·ª≠i - c·∫ßn ph√¢n t√≠ch n·∫øu mu·ªën xem n·ªôi dung]\" }}",
              "type": "string"
            },
            {
              "id": "1386acc3-8824-4679-8b17-27dbead94954",
              "name": "type",
              "value": "={{ \n  $json.role === 'model' && $('Transcribe a recording').item ? 'voice' :\n  $json.role === 'model' && $('Analyze an image').item ? 'image' :\n  $json.role === 'model' && $('Analyze document').item ? 'document' :\n  'text'\n}}",
              "type": "string"
            },
            {
              "id": "25e9ee59-63c9-4eb4-a9b2-0847f4f83b67",
              "name": "prompt",
              "value": "={{ $json.body.message?.caption || $json.body.message.text || $json.content?.parts?.[0]?.text || \"\" }}",
              "type": "string"
            },
            {
              "id": "4a5e3df4-333a-43c6-9f72-4fe8b2bf9b60",
              "name": "metadata",
              "value": "={{   JSON.stringify({     fileName: $json.body.message?.document?.file_name || \"\",     fileSize: $json.body.message?.document?.file_size || 0,     userName: $json.body.message?.from?.first_name || \"\",     chatId: $json.body.message?.chat?.id || \"\"   }) }}",
              "type": "string"
            },
            {
              "id": "0e732c1e-5c23-4edc-b83d-4a930d71ee0a",
              "name": "imageUrl",
              "value": "={{ $json.body.message.photo_url || \"\" }}",
              "type": "string"
            },
            {
              "id": "2f6f8591-4a42-403b-9e7c-61e93c104055",
              "name": "imageAnalysis",
              "value": "={{ $json.content?.parts?.[0]?.text || $json.text || \"\" }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        128,
        2976
      ],
      "id": "25f3b769-11aa-470d-ad9e-0dac9e4f4c6b",
      "name": "Input"
    },
    {
      "parameters": {
        "resource": "audio",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -992,
        2832
      ],
      "id": "2a9cb7da-78a0-4d77-8814-d71b56241c5e",
      "name": "Transcribe a recording",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "tpT1XJjGzSmEFvqd",
          "mode": "list",
          "cachedResultUrl": "/workflow/tpT1XJjGzSmEFvqd",
          "cachedResultName": "My project ‚Äî Tro ly Email"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "chatInput": "={{ $json.input }}",
            "voice": "={{ $('Set \\'Text\\'').item.json.text }}"
          },
          "matchingColumns": [
            "chatInput"
          ],
          "schema": [
            {
              "id": "chatInput",
              "displayName": "chatInput",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "voice",
              "displayName": "voice",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2336,
        3568
      ],
      "id": "d8e6ba37-2fd3-4d1d-92aa-da212dda29ad",
      "name": "Tro ly Email"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.content?.parts?.[0]?.text || $json.content || $json.input || $json.text || $json.body.message.text || $json.prompt || $json.body.message.text || $json.imageUrl ||\"\" }}",
        "options": {
          "systemMessage": "# ‚õî C·∫¢NH B√ÅO: ƒê·ªåC K·ª∏ TR∆Ø·ªöC KHI L√ÄM B·∫§T C·ª® ƒêI·ªÄU G√å\n\n## üö´ TUY·ªÜT ƒê·ªêI C·∫§M T·ª∞ TR·∫¢ L·ªúI\n\nB·∫°n l√† DISPATCHER (ƒêi·ªÅu ph·ªëi vi√™n), KH√îNG PH·∫¢I chuy√™n gia.\n\n‚ùå B·∫†N KH√îNG ƒê∆Ø·ª¢C:\n- T·ª± tr·∫£ l·ªùi c√¢u h·ªèi v·ªÅ gi√° c·∫£, s·∫£n ph·∫©m, v·∫≠t li·ªáu\n- T·ª± t√≠nh to√°n b·∫•t k·ª≥ con s·ªë n√†o\n- T·ª± t·∫°o b√°o gi√°\n- Tr·∫£ l·ªùi \"em c·∫ßn th√™m th√¥ng tin\" m√† kh√¥ng g·ªçi tool\n\n‚úÖ B·∫†N CH·ªà ƒê∆Ø·ª¢C:\n- Nh·∫≠n y√™u c·∫ßu ‚Üí G·ªçi tool ‚Üí Tr·∫£ k·∫øt qu·∫£ t·ª´ tool\n- H·ªèi l·∫°i s·∫øp N·∫æU kh√¥ng hi·ªÉu y√™u c·∫ßu\n\n---\n\n## üìã B·∫¢NG G·ªåI TOOL B·∫ÆT BU·ªòC\n\n| Khi s·∫øp n√≥i | G·ªåI NGAY tool n√†y |\n|-------------|-------------------|\n| b√°o gi√°, t√≠nh gi√°, gi√° bao nhi√™u, t·∫°o ƒë∆°n, l√™n ƒë∆°n, t·ªß, b√†n, gh·∫ø, gi∆∞·ªùng, k·ªá, s·∫£n ph·∫©m, v·∫≠t li·ªáu, g·ªó | **Tro ly ke toan** |\n| t·ªìn kho, c√≤n h√†ng, s·ªë l∆∞·ª£ng, ki·ªÉm tra kho | Tro ly kho |\n| ti·∫øn ƒë·ªô, thi c√¥ng, l·ªãch l√†m vi·ªác, nh√¢n s·ª± | Tro ly thi cong |\n| email, g·ª≠i mail, vi·∫øt mail | Tro ly mail |\n| l·ªãch h·∫πn, ƒë·∫∑t l·ªãch, xem l·ªãch | Tro ly lich |\n| b·∫£n v·∫Ω, k·ªπ thu·∫≠t, CAD, thi·∫øt k·∫ø | Tro ly ky thuat |\n| bu·ªìn, vui, t√¢m s·ª±, th·ªùi ti·∫øt, tin t·ª©c | Tro ly thong thai |\n\n---\n\n## ‚úÖ V√ç D·ª§ ƒê√öNG (L√ÄM THEO)\n\n### V√≠ d·ª• 1: T·∫°o b√°o gi√°\nUser: \"T·∫°o b√°o gi√° cho kh√°ch A, 2 t·ªß qu·∫ßn √°o\"\n‚Üí G·ªåI tool \"Tro ly ke toan\" v·ªõi input: \"T·∫°o b√°o gi√° cho kh√°ch A, 2 t·ªß qu·∫ßn √°o\"\n‚Üí Tr·∫£ v·ªÅ k·∫øt qu·∫£ t·ª´ tool\n\n### V√≠ d·ª• 2: H·ªèi gi√°\nUser: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n‚Üí G·ªåI tool \"Tro ly ke toan\" v·ªõi input: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n‚Üí Tr·∫£ v·ªÅ k·∫øt qu·∫£ t·ª´ tool\n\n### V√≠ d·ª• 3: T·∫°o l·∫°i b√°o gi√°\nUser: \"T·∫°o l·∫°i b√°o gi√°\"\n‚Üí G·ªåI tool \"Tro ly ke toan\" v·ªõi input: \"T·∫°o l·∫°i b√°o gi√°\"\n‚Üí Tr·∫£ v·ªÅ k·∫øt qu·∫£ t·ª´ tool\n\n---\n\n## ‚ùå V√ç D·ª§ SAI (TUY·ªÜT ƒê·ªêI KH√îNG L√ÄM)\n\nUser: \"T·∫°o b√°o gi√° cho kh√°ch A\"\n‚ùå SAI: \"D·∫° s·∫øp, ƒë·ªÉ t·∫°o b√°o gi√° em c·∫ßn th√™m th√¥ng tin v·ªÅ s·∫£n ph·∫©m...\"\n‚ùå SAI: \"S·∫øp mu·ªën b√°o gi√° s·∫£n ph·∫©m g√¨ ·∫°?\"\n‚ùå SAI: T·ª± li·ªát k√™ th√¥ng tin s·∫£n ph·∫©m\n\n‚úÖ ƒê√öNG: G·ªçi tool \"Tro ly ke toan\" v·ªõi input g·ªëc, ƒë·ªÉ tool ƒë√≥ t·ª± h·ªèi th√™m n·∫øu c·∫ßn\n\n---\n\n# OVERVIEW\n\nB·∫°n l√† Tr·ª£ l√Ω AI ch√≠nh (Dispatcher) c·ªßa x∆∞·ªüng n·ªôi th·∫•t MinhKhoa.\n\n**Nhi·ªám v·ª• DUY NH·∫§T:** Nh·∫≠n y√™u c·∫ßu ‚Üí G·ªçi tool ph√π h·ª£p ‚Üí Tr·∫£ k·∫øt qu·∫£ t·ª´ tool\n\n# TOOLS\n\n1. **Tro ly ke toan** ‚≠ê QUAN TR·ªåNG NH·∫§T\n   - D√πng cho: b√°o gi√°, t√≠nh to√°n, gi√° c·∫£, s·∫£n ph·∫©m, v·∫≠t li·ªáu, t·ªß, b√†n, gh·∫ø, g·ªó\n   - Input: To√†n b·ªô y√™u c·∫ßu c·ªßa s·∫øp (copy nguy√™n vƒÉn)\n\n2. **Tro ly kho**: T·ªìn kho, s·ªë l∆∞·ª£ng, ki·ªÉm tra h√†ng\n\n3. **Tro ly thi cong**: Ti·∫øn ƒë·ªô, thi c√¥ng, nh√¢n s·ª±\n\n4. **Tro ly thong thai**: T√¢m s·ª±, ch·ªß ƒë·ªÅ ngo√†i c√¥ng vi·ªác\n\n5. **Tro ly mail**: Email\n\n6. **Tro ly lich**: L·ªãch h·∫πn\n\n7. **Tro ly ky thuat**: B·∫£n v·∫Ω, k·ªπ thu·∫≠t, CAD\n\n8. **Search in Tavily**: T√¨m ki·∫øm th√¥ng tin M·ªöI NH·∫§T tr√™n internet\n   - CH·ªà d√πng khi: gi√° th·ªã tr∆∞·ªùng, tin t·ª©c th·ªùi s·ª±, ƒë·ªëi th·ªß c·∫°nh tranh, xu h∆∞·ªõng m·ªõi\n   - KH√îNG d√πng cho: gi√° s·∫£n ph·∫©m c·ªßa c√¥ng ty, quy ƒë·ªãnh n·ªôi b·ªô\n\n9. **Save Knowledge (Write)**: Ghi nh·ªõ ki·∫øn th·ª©c m·ªõi\n   - D√πng khi: s·∫øp d·∫°y ƒëi·ªÅu m·ªõi, s·ª≠a sai, ho·∫∑c t√¨m ƒë∆∞·ª£c th√¥ng tin h·ªØu √≠ch t·ª´ Tavily\n\n10. **Think**: Khi c·∫ßn suy nghƒ© ph·ª©c t·∫°p\n\n---\n\n# üîç QUY T·∫ÆC T√åM KI·∫æM (TAVILY)\n\n## ‚úÖ KHI N√ÄO D√ôNG \"Search in Tavily\"\n\n**CH·ªà d√πng khi s·∫øp h·ªèi v·ªÅ:**\n- ‚úÖ **Gi√° th·ªã tr∆∞·ªùng**: \"Gi√° g·ªó s·ªìi tr√™n th·ªã tr∆∞·ªùng hi·ªán t·∫°i?\", \"Gi√° ngo√†i bao nhi√™u?\"\n- ‚úÖ **Tin t·ª©c th·ªùi s·ª±**: \"Tin t·ª©c m·ªõi nh·∫•t v·ªÅ n·ªôi th·∫•t\", \"Xu h∆∞·ªõng n·ªôi th·∫•t 2025\"\n- ‚úÖ **ƒê·ªëi th·ªß c·∫°nh tranh**: \"ƒê·ªëi th·ªß c·ªßa ch√∫ng ta l√† ai?\", \"So s√°nh v·ªõi c√¥ng ty X\"\n- ‚úÖ **Xu h∆∞·ªõng m·ªõi**: \"Xu h∆∞·ªõng thi·∫øt k·∫ø m·ªõi nh·∫•t\", \"M·∫´u t·ªß qu·∫ßn √°o hot hi·ªán t·∫°i\"\n\n## ‚ùå KHI N√ÄO KH√îNG D√ôNG TAVILY\n\n**TUY·ªÜT ƒê·ªêI KH√îNG d√πng khi:**\n- ‚ùå H·ªèi v·ªÅ **gi√° s·∫£n ph·∫©m c·ªßa x∆∞·ªüng MinhKhoa** ‚Üí D√πng \"Tro ly ke toan\"\n- ‚ùå H·ªèi v·ªÅ **quy ƒë·ªãnh n·ªôi b·ªô** ‚Üí Ki·ªÉm tra \"KI·∫æN TH·ª®C ƒê√É H·ªåC\" tr∆∞·ªõc\n- ‚ùå H·ªèi v·ªÅ **quy tr√¨nh l√†m vi·ªác** ‚Üí Ki·ªÉm tra \"KI·∫æN TH·ª®C ƒê√É H·ªåC\" tr∆∞·ªõc\n- ‚ùå H·ªèi v·ªÅ **th√¥ng tin kh√°ch h√†ng** ‚Üí Ki·ªÉm tra \"KI·∫æN TH·ª®C ƒê√É H·ªåC\" tr∆∞·ªõc\n\n### V√≠ d·ª•:\nUser: \"Gi√° g·ªó s·ªìi c·ªßa x∆∞·ªüng m√¨nh bao nhi√™u?\"\n‚Üí ‚ùå SAI: G·ªçi \"Search in Tavily\"\n‚Üí ‚úÖ ƒê√öNG: G·ªçi \"Tro ly ke toan\"\n\nUser: \"Gi√° g·ªó s·ªìi tr√™n th·ªã tr∆∞·ªùng hi·ªán t·∫°i?\"\n‚Üí ‚úÖ ƒê√öNG: G·ªçi \"Search in Tavily\"\n\n---\n\n# üíæ QUY T·∫ÆC GHI NH·ªö (ACTIVE LEARNING)\n\n## üéØ T·ª∞ ƒê·ªòNG GHI NH·ªö - LU√îN TH·ª∞C HI·ªÜN\n\nSau khi c√≥ k·∫øt qu·∫£ t·ª´ b·∫•t k·ª≥ tool n√†o, **T·ª∞ ƒê·ªòNG ƒë√°nh gi√° v√† ghi nh·ªõ** n·∫øu th√¥ng tin h·ªØu √≠ch:\n\n### 1. Sau khi t√¨m ƒë∆∞·ª£c th√¥ng tin t·ª´ Tavily:\nB∆∞·ªõc 1: G·ªçi \"Search in Tavily\" ‚Üí Nh·∫≠n k·∫øt qu·∫£\nB∆∞·ªõc 2: ƒê√°nh gi√°: K·∫øt qu·∫£ c√≥ h·ªØu √≠ch kh√¥ng? (c√≥ answer d√†i >100 k√Ω t·ª±, c√≥ th√¥ng tin c·ª• th·ªÉ)\nB∆∞·ªõc 3: N·∫æU h·ªØu √≠ch ‚Üí T·ª∞ ƒê·ªòNG g·ªçi \"Save Knowledge (Write)\" v·ªõi format:\n  - query: \"[WEB] T√≥m t·∫Øt n·ªôi dung ch√≠nh t·ª´ k·∫øt qu·∫£ Tavily\"\n  - action: \"save\"\n  - category: \"market_info\" ho·∫∑c \"trend\" ho·∫∑c \"competitor\" (t√πy lo·∫°i)\n\n### 2. Sau khi ƒë∆∞·ª£c s·∫øp s·ª≠a sai:\nUser: \"Sai r·ªìi, gi√° g·ªó s·ªìi ph·∫£i l√† 15 tri·ªáu/m3\"\n‚Üí B∆∞·ªõc 1: G·ªçi \"Save Knowledge (Write)\" ngay l·∫≠p t·ª©c\n‚Üí B∆∞·ªõc 2: query: \"Gi√° g·ªó s·ªìi l√† 15 tri·ªáu/m3\"\n‚Üí B∆∞·ªõc 3: action: \"save\"\n‚Üí B∆∞·ªõc 4: category: \"correction\" ho·∫∑c \"pricing\"\n\n### 3. Sau khi s·∫øp d·∫°y ƒëi·ªÅu m·ªõi:\nUser: \"Nh·ªõ l√† kh√°ch A th√≠ch m√†u tr·∫Øng\"\n‚Üí G·ªåI NGAY \"Save Knowledge (Write)\" v·ªõi:\n  - query: \"Kh√°ch A th√≠ch m√†u tr·∫Øng\"\n  - action: \"save\"\n  - category: \"customer_preference\"\n\n### 4. ƒê·ªãnh d·∫°ng l∆∞u tr·ªØ:\nFormat: [NGU·ªíN] N·ªôi dung ch√≠nh\n\nV√≠ d·ª•:\n- \"[WEB] Gi√° g·ªó s·ªìi th·ªã tr∆∞·ªùng hi·ªán t·∫°i: 12-15 tri·ªáu/m3 (2025)\"\n- \"[USER] Gi√° g·ªó s·ªìi c·ªßa x∆∞·ªüng: 15 tri·ªáu/m3\"\n- \"[CORRECTION] Kh√°ch A th√≠ch m√†u tr·∫Øng, kh√¥ng ph·∫£i ƒëen\"\n\n---\n\n# üìñ QUY T·∫ÆC PH·∫¢N H·ªíI\n\n## B∆Ø·ªöC 1: KI·ªÇM TRA KI·∫æN TH·ª®C ƒê√É H·ªåC TR∆Ø·ªöC\n\n**LU√îN ki·ªÉm tra ph·∫ßn \"KI·∫æN TH·ª®C ƒê√É H·ªåC\" trong context tr∆∞·ªõc khi tr·∫£ l·ªùi:**\n\n1. ƒê·ªçc k·ªπ ph·∫ßn \"KI·∫æN TH·ª®C ƒê√É H·ªåC\" (n·∫øu c√≥)\n2. T√¨m ki·∫øn th·ª©c li√™n quan ƒë·∫øn c√¢u h·ªèi\n3. N·∫æU c√≥ ki·∫øn th·ª©c ph√π h·ª£p ‚Üí ∆ØU TI√äN s·ª≠ d·ª•ng\n4. N·∫æU kh√¥ng c√≥ ‚Üí M·ªõi g·ªçi tool t√¨m ki·∫øm\n\n### V√≠ d·ª•:\nContext c√≥: \"‚Ä¢ [pricing] Gi√° g·ªó s·ªìi: 15 tri·ªáu/m3\"\nUser h·ªèi: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n‚Üí ‚úÖ ƒê√öNG: Tr·∫£ l·ªùi d·ª±a tr√™n ki·∫øn th·ª©c ƒë√£ h·ªçc\n‚Üí ‚ùå SAI: G·ªçi \"Tro ly ke toan\" ho·∫∑c \"Search in Tavily\"\n\n## B∆Ø·ªöC 2: X·ª¨ L√ù M√ÇU THU·∫™N\n\n**N·∫øu ki·∫øn th·ª©c trong b·ªô nh·ªõ m√¢u thu·∫´n v·ªõi k·∫øt qu·∫£ search m·ªõi:**\n\n1. Ph√°t hi·ªán m√¢u thu·∫´n: Ki·∫øn th·ª©c c≈© vs K·∫øt qu·∫£ m·ªõi\n2. ∆ØU TI√äN k·∫øt qu·∫£ m·ªõi nh·∫•t (t·ª´ Tavily ho·∫∑c t·ª´ s·∫øp)\n3. T·ª∞ ƒê·ªòNG update b·ªô nh·ªõ:\n   - G·ªçi \"Save Knowledge (Write)\" v·ªõi th√¥ng tin m·ªõi\n   - Format: \"[CORRECTION] Th√¥ng tin m·ªõi (thay th·∫ø th√¥ng tin c≈©)\"\n4. Tr·∫£ l·ªùi: \"Em ƒë√£ c·∫≠p nh·∫≠t th√¥ng tin m·ªõi nh·∫•t...\"\n\n### V√≠ d·ª•:\nKi·∫øn th·ª©c c≈©: \"Gi√° g·ªó s·ªìi: 12 tri·ªáu/m3\"\nTavily tr·∫£ v·ªÅ: \"Gi√° g·ªó s·ªìi th·ªã tr∆∞·ªùng 2025: 15 tri·ªáu/m3\"\n‚Üí B∆∞·ªõc 1: Ph√°t hi·ªán m√¢u thu·∫´n\n‚Üí B∆∞·ªõc 2: ∆Øu ti√™n k·∫øt qu·∫£ m·ªõi (15 tri·ªáu)\n‚Üí B∆∞·ªõc 3: T·ª∞ ƒê·ªòNG g·ªçi \"Save Knowledge (Write)\":\n  - query: \"[CORRECTION] Gi√° g·ªó s·ªìi th·ªã tr∆∞·ªùng 2025: 15 tri·ªáu/m3 (thay th·∫ø 12 tri·ªáu)\"\n  - action: \"save\"\n‚Üí B∆∞·ªõc 4: Tr·∫£ l·ªùi: \"D·∫° s·∫øp, theo th√¥ng tin m·ªõi nh·∫•t, gi√° g·ªó s·ªìi th·ªã tr∆∞·ªùng hi·ªán t·∫°i l√† 15 tri·ªáu/m3. Em ƒë√£ c·∫≠p nh·∫≠t v√†o b·ªô nh·ªõ.\"\n\n## B∆Ø·ªöC 3: T·ªîNG H·ª¢P TH√îNG TIN\n\n**Khi c√≥ nhi·ªÅu ngu·ªìn th√¥ng tin:**\n\n1. Ki·∫øn th·ª©c ƒë√£ h·ªçc (t·ª´ RAG)\n2. K·∫øt qu·∫£ t·ª´ Tavily (n·∫øu c√≥)\n3. K·∫øt qu·∫£ t·ª´ tool kh√°c\n\n‚Üí T·ªïng h·ª£p t·∫•t c·∫£, ∆∞u ti√™n:\n   - Th√¥ng tin m·ªõi nh·∫•t (t·ª´ Tavily)\n   - Th√¥ng tin t·ª´ s·∫øp (t·ª´ RAG)\n   - Th√¥ng tin t·ª´ tool chuy√™n m√¥n (Tro ly ke toan, etc.)\n\n---\n\n# OUTPUT FORMAT\n\n1. Text thu·∫ßn, KH√îNG d√πng markdown (**, ##, ```)\n2. X∆∞ng h√¥: \"em\" - \"s·∫øp\"\n3. Ch·ªâ ch√†o ·ªü l·∫ßn t∆∞∆°ng t√°c ƒê·∫¶U TI√äN\n4. KH√îNG n√≥i \"em ƒë√£ chuy·ªÉn cho tr·ª£ l√Ω...\"\n5. Tr·∫£ k·∫øt qu·∫£ TR·ª∞C TI·∫æP t·ª´ tool\n\n# RESPONSE TYPE (Ghi ·ªü cu·ªëi response)\n\nSau khi c√≥ k·∫øt qu·∫£ t·ª´ tool, ghi th√™m:\n\n- RESPONSE_TYPE: \"quote_new\" - Khi t·∫°o b√°o gi√° m·ªõi (c√≥ ·∫£nh + PDF)\n- RESPONSE_TYPE: \"send_pdf\" - Khi g·ª≠i l·∫°i PDF\n- RESPONSE_TYPE: \"send_image\" - Khi g·ª≠i l·∫°i ·∫£nh\n- RESPONSE_TYPE: \"text_only\" - Khi tr·∫£ l·ªùi text th√¥ng th∆∞·ªùng\n\n---\n\n# ‚ö†Ô∏è NH·∫ÆC L·∫†I L·∫¶N CU·ªêI\n\n**KH√îNG BAO GI·ªú T·ª∞ TR·∫¢ L·ªúI V·ªÄ:**\n- Gi√° c·∫£\n- S·∫£n ph·∫©m\n- V·∫≠t li·ªáu\n- T√≠nh to√°n\n- B√°o gi√°\n\n**LU√îN G·ªåI TOOL \"Tro ly ke toan\" cho c√°c y√™u c·∫ßu tr√™n!**\n\n## KI·∫æN TH·ª®C ƒê√É H·ªåC\n{{ $json.learningContext }}\n\n---\n\n# üéì T√ìM T·∫ÆT QUY TR√åNH ACTIVE LEARNING\n\n## Lu·ªìng x·ª≠ l√Ω m·ªôt c√¢u h·ªèi:\n\n1. ƒê·ªåC \"KI·∫æN TH·ª®C ƒê√É H·ªåC\" ‚Üí C√≥ th√¥ng tin li√™n quan kh√¥ng?\n   ‚îú‚îÄ C√ì ‚Üí S·ª≠ d·ª•ng, nh∆∞ng ki·ªÉm tra t√≠nh c·∫≠p nh·∫≠t\n   ‚îî‚îÄ KH√îNG ‚Üí B∆∞·ªõc 2\n\n2. PH√ÇN T√çCH INTENT ‚Üí C·∫ßn t√¨m ki·∫øm web kh√¥ng?\n   ‚îú‚îÄ Gi√° th·ªã tr∆∞·ªùng/Tin t·ª©c/ƒê·ªëi th·ªß/Xu h∆∞·ªõng ‚Üí G·ªçi \"Search in Tavily\"\n   ‚îî‚îÄ Gi√° c√¥ng ty/Quy ƒë·ªãnh n·ªôi b·ªô ‚Üí G·ªçi \"Tro ly ke toan\" ho·∫∑c tool kh√°c\n\n3. NH·∫¨N K·∫æT QU·∫¢ ‚Üí ƒê√°nh gi√° v√† ghi nh·ªõ\n   ‚îú‚îÄ T·ª´ Tavily ‚Üí T·ª∞ ƒê·ªòNG g·ªçi \"Save Knowledge (Write)\" n·∫øu h·ªØu √≠ch\n   ‚îú‚îÄ T·ª´ s·∫øp s·ª≠a sai ‚Üí T·ª∞ ƒê·ªòNG g·ªçi \"Save Knowledge (Write)\" ngay\n   ‚îî‚îÄ Ph√°t hi·ªán m√¢u thu·∫´n ‚Üí Update b·ªô nh·ªõ v·ªõi th√¥ng tin m·ªõi\n\n4. TR·∫¢ L·ªúI ‚Üí T·ªïng h·ª£p t·ª´ t·∫•t c·∫£ ngu·ªìn, ∆∞u ti√™n th√¥ng tin m·ªõi nh·∫•t\n\n---\n\n# ‚úÖ CHECKLIST TR∆Ø·ªöC KHI TR·∫¢ L·ªúI\n\n- ƒê√£ ki·ªÉm tra \"KI·∫æN TH·ª®C ƒê√É H·ªåC\"?\n- ƒê√£ ch·ªçn ƒë√∫ng tool? (Tavily ch·ªâ cho gi√° th·ªã tr∆∞·ªùng/tin t·ª©c/ƒë·ªëi th·ªß/xu h∆∞·ªõng)\n- ƒê√£ t·ª± ƒë·ªông ghi nh·ªõ th√¥ng tin h·ªØu √≠ch?\n- ƒê√£ x·ª≠ l√Ω m√¢u thu·∫´n (n·∫øu c√≥)?\n- ƒê√£ t·ªïng h·ª£p th√¥ng tin t·ª´ nhi·ªÅu ngu·ªìn?\n- ƒê√£ ghi RESPONSE_TYPE ·ªü cu·ªëi?\n\n",
          "returnIntermediateSteps": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2064,
        2976
      ],
      "id": "bdaff07f-8f73-4e7f-ab68-19bab974a0ea",
      "name": "Tro ly chinh",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "description": "Th·ª±c hi·ªán c√°c ch·ª©c nƒÉng c·ªßa Google l·ªãch",
        "workflowId": {
          "__rl": true,
          "value": "eLrbhgmz6YTdIcVE",
          "mode": "list",
          "cachedResultUrl": "/workflow/eLrbhgmz6YTdIcVE",
          "cachedResultName": "My project ‚Äî Tro ly lich"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2464,
        3568
      ],
      "id": "9df9a539-4bb1-4f1e-af88-779b1ee8375f",
      "name": "Tro ly lich"
    },
    {
      "parameters": {
        "description": "B·∫°n l√† Tr·ª£ l√Ω K·ªπ thu·∫≠t chuy√™n tr√°ch (TechSpec AI) c·ªßa x∆∞·ªüng n·ªôi th·∫•t MinhKhoa.\nNhi·ªám v·ª• c·ªßa b·∫°n l√† nh·∫≠n th√¥ng tin b·∫£n v·∫Ω/y√™u c·∫ßu t·ª´ s·∫øp (ho·∫∑c t·ª´ agent ƒëi·ªÅu ph·ªëi), sau ƒë√≥ ph√¢n t√≠ch k·ªπ thu·∫≠t, b√≥c t√°ch kh·ªëi l∆∞·ª£ng v√† t√≠nh to√°n ƒë·ªãnh m·ª©c v·∫≠t t∆∞ ch√≠nh x√°c ƒë·ªÉ ph·ª•c v·ª• s·∫£n xu·∫•t.",
        "workflowId": {
          "__rl": true,
          "value": "t63HlYXCREmvkDdf",
          "mode": "list",
          "cachedResultUrl": "/workflow/t63HlYXCREmvkDdf",
          "cachedResultName": "Tro ly ky thua"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "content": "={{ JSON.stringify($json) }}",
            "type": "={{ $json.type }}",
            "prompt": "={{ $json.prompt }}",
            "metadata": "={{ $json.metadata }}",
            "imageUrl": "={{ $json.imageUrl || \"\" }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "content",
              "displayName": "content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "type",
              "displayName": "type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "prompt",
              "displayName": "prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "metadata",
              "displayName": "metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "imageUrl",
              "displayName": "imageUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2208,
        3568
      ],
      "id": "2ff72896-6809-4e52-8208-a6932c2fef6f",
      "name": "Tro ly ky thuat"
    },
    {
      "parameters": {
        "model": "google/gemini-2.0-flash-001",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        -1792,
        3968
      ],
      "id": "73e3b964-760d-4f60-b475-df173f7ac6a9",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "MJfpFBAmvmcIM1N3",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "bc7c149d-27bb-46c4-ba95-ed516cc67b24"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "50c82333-aa74-4da8-a595-d8aa20d8901b",
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "word",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Word"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0c7bfdb4-6711-4449-a567-d48e82089f01",
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "sheet",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Excel"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "849656ec-d703-4e8f-9544-3609249874b3",
                    "leftValue": "={{ $json.file_extension }}",
                    "rightValue": "dwg",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DWG"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "76f19cd5-855d-448f-b5e1-fd0a78c62ce5",
                    "leftValue": "={{ $json.file_extension }}",
                    "rightValue": "dxf",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DXF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "dc2e32e5-6475-4710-8c42-fedac5ab954b",
                    "leftValue": "={{ $json.mime_type }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Image As Document"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -784,
        3408
      ],
      "id": "d15f7cec-7a72-42f7-bd75-6245d66b92e9",
      "name": "Switch2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5e9f46cd-4af5-42ac-b18e-473ae9c78ee1",
              "name": "file_id",
              "value": "={{ $json.body.message.document.file_id }}",
              "type": "string"
            },
            {
              "id": "b3f55b7b-52f4-4e47-8d7e-72d8d74f6979",
              "name": "file_name",
              "value": "={{ $json.body.message.document.file_name }}",
              "type": "string"
            },
            {
              "id": "7fa10781-7b35-4111-b855-1759e8a04abb",
              "name": "file_size",
              "value": "={{ $json.body.message.document.file_size }}",
              "type": "number"
            },
            {
              "id": "d52661be-f338-4431-a643-ab13690ffa77",
              "name": "mine_type",
              "value": "={{ $json.body.message.document.mime_type }}",
              "type": "string"
            },
            {
              "id": "434023a4-2a87-4a84-92c6-57d3592802c0",
              "name": "file_extension",
              "value": "={{ $json.body.message.document.file_name.split('.').pop().toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "6457640a-2104-48fe-a47b-000f8e556039",
              "name": "caption",
              "value": "={{ $json.body.message.caption || '' }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -992,
        3408
      ],
      "id": "b14381ec-5d3f-4ae4-ae10-96186af958fa",
      "name": "Edit Fields",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "=Ph√¢n t√≠ch t√†i li·ªáu n√†y:\\n\\n**Lo·∫°i file:** {{ $json.file_name }}\\n**M√¥ t·∫£ t·ª´ user:** {{ $json.caption }}\\n\\nTr√≠ch xu·∫•t:\\n1. N·ªôi dung ch√≠nh\\n2. Th√¥ng s·ªë k·ªπ thu·∫≠t (n·∫øu c√≥)\\n3. K√≠ch th∆∞·ªõc, v·∫≠t li·ªáu (n·∫øu l√† b·∫£n v·∫Ω)\\n4. Gi√° c·∫£ (n·∫øu l√† b√°o gi√°)",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -416,
        3408
      ],
      "id": "95f4a2cf-44db-4ff9-b8aa-a21cf56ca193",
      "name": "Analyze document",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fa7c23ed-4575-4852-97c4-578515ce3590",
              "leftValue": "={{ $json.file_size }}",
              "rightValue": 20971520,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -416,
        3600
      ],
      "id": "80c369a6-8621-4bc0-8071-b42aeb16b0e8",
      "name": "If File Size < 20MB"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://v2.convertapi.com/convert/dwg/to/pdf",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer XJDhHpS7ZAFrMItEv3t9ROmMgT0dB3nz"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "StoreFile",
              "value": "true"
            },
            {
              "parameterType": "formBinaryData",
              "name": "File"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -144,
        3440
      ],
      "id": "7ed75443-b654-4f5e-bac9-0b5a744041c9",
      "name": "CAD to PDF",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.error }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2464,
        3088
      ],
      "id": "789cf794-38da-487a-b825-48dc44215417",
      "name": "Error Message1"
    },
    {
      "parameters": {
        "url": "={{ $json.body.message.photo_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1216,
        3152
      ],
      "id": "e9f5eb82-384f-4415-a9c9-fca335877e4f",
      "name": "Download Image",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "https://f19-zpc.zdn.vn/jpg/3991656014868884191/603153a06fd3e08db9c2.jpg",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1216,
        2832
      ],
      "id": "93829b72-18f7-49c6-8e6e-6501e3176cb0",
      "name": "Download Voice",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1Z1WZcw2zQ2CvRsskYR5JqlAPW3xfYpUcGIZr31UgM6U",
          "mode": "list",
          "cachedResultName": "Agent Log",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Z1WZcw2zQ2CvRsskYR5JqlAPW3xfYpUcGIZr31UgM6U/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Trang t√≠nh1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1Z1WZcw2zQ2CvRsskYR5JqlAPW3xfYpUcGIZr31UgM6U/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $now.format('yyyy-MM-dd hh:m a') }}",
            "Workflow": "={{ $workflow.name }}",
            "Input": "={{ $('Input').item.json.body.message.text }}",
            "Total tokens": "={{ $json.total_tokens }}",
            "Token": "={{ JSON.stringify($json.steps, null, 2) }}",
            "Output": "={{ $('Tro ly chinh').item.json.output }}",
            "Actions": "={{ JSON.stringify($json.steps, null, 2) }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Workflow",
              "displayName": "Workflow",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Input",
              "displayName": "Input",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Output",
              "displayName": "Output",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Actions",
              "displayName": "Actions",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Token",
              "displayName": "Token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Total tokens",
              "displayName": "Total tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3472,
        2880
      ],
      "id": "e0799823-f6aa-42f1-8d2d-77d56db49aa9",
      "name": "Agent Log",
      "retryOnFail": true,
      "maxTries": 5,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "k9q7ceY6SMWzzelv",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "description": "=# ‚ö†Ô∏è QUY T·∫ÆC B·∫ÆT BU·ªòC - ƒê·ªåC TR∆Ø·ªöC KHI TR·∫¢ L·ªúI\n\n## QUAN TR·ªåNG NH·∫§T: KHI T·∫†O B√ÅO GI√Å\nKhi s·∫øp y√™u c·∫ßu \"t·∫°o b√°o gi√°\", \"l·∫≠p b√°o gi√°\", \"t·∫°o l·∫°i b√°o gi√°\", \"l√†m b√°o gi√°\", \"b√°o gi√° cho kh√°ch\", \"t√≠nh gi√°\", \"l√™n ƒë∆°n\":\n‚Üí PH·∫¢I tr·∫£ v·ªÅ JSON `create_quote` ·ªü cu·ªëi response\n‚Üí KH√îNG ƒê∆Ø·ª¢C ch·ªâ tr·∫£ l·ªùi text m√¥ t·∫£ m√† thi·∫øu JSON\n‚Üí N·∫øu thi·∫øu JSON ‚Üí File b√°o gi√° KH√îNG ƒë∆∞·ª£c t·∫°o!\n\n---\n\n# OVERVIEW\nB·∫°n l√† Tr·ª£ l√Ω K·∫ø to√°n chuy√™n tr√°ch c·ªßa x∆∞·ªüng n·ªôi th·∫•t MinhKhoa.\n\n# CONTEXT\n{{ $json.customerContext }}\n{{ $json.learningContext }}\n\n# TOOLS & RULES\n1. Calculator: B·∫ÆT BU·ªòC d√πng ƒë·ªÉ t√≠nh to√°n m·ªçi con s·ªë. KH√îNG t√≠nh nh·∫©m.\n2. Tra c·ª©u: D√πng tools (San pham, Vat lieu, Ton kho) ƒë·ªÉ l·∫•y d·ªØ li·ªáu.\n\n# OUTPUT FORMAT\n1. L·ªùi tho·∫°i:\n   - Text thu·∫ßn, KH√îNG d√πng markdown (**, ##, ```)\n   - X∆∞ng h√¥: \"em\" - \"s·∫øp\"\n   - S·ªë ti·ªÅn: d·∫•u ch·∫•m ph√¢n c√°ch (1.500.000 VNƒê)\n\n2. JSON Action: ƒê·∫∑t ·ªü CU·ªêI C√ôNG response khi c·∫ßn h√†nh ƒë·ªông\n\n---\n\n# ACTION SCENARIOS\n\n## 1. T·∫†O B√ÅO GI√Å M·ªöI\nT·ª´ kh√≥a: \"t·∫°o b√°o gi√°\", \"l·∫≠p b√°o gi√°\", \"t·∫°o l·∫°i\", \"l√†m b√°o gi√°\", \"b√°o gi√° cho\", \"t√≠nh gi√°\", \"l√™n ƒë∆°n\"\n\nQuy tr√¨nh:\n1. D√πng Calculator t√≠nh to√°n\n2. Tr·∫£ l·ªùi ng·∫Øn: \"D·∫°, em ƒë√£ t√≠nh xong b√°o gi√° cho [T√™n kh√°ch]. T·ªïng c·ªông: X VNƒê\"\n3. ƒê√çNH K√àM JSON (B·∫ÆT BU·ªòC):\n\n```json\n{\n  \"action\": \"create_quote\",\n  \"data\": {\n    \"customerName\": \"T√™n kh√°ch\",\n    \"customerPhone\": \"SƒêT\",\n    \"customerAddress\": \"ƒê·ªãa ch·ªâ\",\n    \"items\": [\n      {\n        \"name\": \"T√™n s·∫£n ph·∫©m\",\n        \"size\": \"1800 x 2000 x 600 mm\",\n        \"material\": \"V·∫≠t li·ªáu\",\n        \"quantity\": 1,\n        \"unitPrice\": 1000000,\n        \"amount\": 1000000,\n        \"note\": \"Ghi ch√∫\"\n      }\n    ],\n    \"subtotal\": 1000000,\n    \"profitPercent\": 25,\n    \"profit\": 250000,\n    \"priceBeforeVAT\": 1250000,\n    \"vat\": 125000,\n    \"totalAmount\": 1375000\n  }\n}\n```\n\nGi·∫£i th√≠ch fields:\n- unitPrice = Gi√° b√°n 1 s·∫£n ph·∫©m (ƒë√£ t√≠nh l·ª£i nhu·∫≠n, CH∆ØA VAT)\n- amount = unitPrice √ó quantity\n- subtotal = T·ªïng chi ph√≠ s·∫£n xu·∫•t (ch∆∞a l·ª£i nhu·∫≠n)\n- profit = subtotal √ó profitPercent / 100\n- priceBeforeVAT = subtotal + profit\n- vat = priceBeforeVAT √ó 10%\n- totalAmount = priceBeforeVAT + vat\n- T·∫•t c·∫£ s·ªë ti·ªÅn l√† NUMBER, kh√¥ng c√≥ d·∫•u ch·∫•m\n\n## 2. G·ª¨I L·∫†I PDF/FILE\nT·ª´ kh√≥a: \"g·ª≠i pdf\", \"g·ª≠i l·∫°i file\", \"t·∫£i pdf\", \"m·ªói pdf\", \"ch·ªâ c·∫ßn file\"\n\n‚Üí CH·ªà tr·∫£ v·ªÅ: \"ƒê√¢y l√† file PDF b√°o gi√° [m√£]: [link_pdf]\"\n‚Üí KH√îNG t·∫°o b√°o gi√° m·ªõi\n‚Üí KH√îNG m√¥ t·∫£ chi ti·∫øt\n\n## 3. H·ªéI ƒê√ÅP TH√îNG TH∆Ø·ªúNG\nT·ª´ kh√≥a: h·ªèi gi√° v·∫≠t li·ªáu, tra c·ª©u s·∫£n ph·∫©m, t·ªìn kho...\n\n‚Üí Tr·∫£ l·ªùi text b√¨nh th∆∞·ªùng\n‚Üí KH√îNG c·∫ßn JSON\n\n## 4. L∆ØU TH√îNG TIN H·ªåC\nKhi s·∫øp d·∫°y ki·∫øn th·ª©c m·ªõi ho·∫∑c s·ª≠a sai\n\n```json\n{\n  \"action\": \"learn\",\n  \"data\": {\n    \"type\": \"knowledge|preference|correction\",\n    \"content\": \"N·ªôi dung h·ªçc\",\n    \"wrong\": \"N·∫øu l√† correction - c√°i sai\",\n    \"correct\": \"N·∫øu l√† correction - c√°i ƒë√∫ng\"\n  }\n}\n```\n\n## 5. L∆ØU KH√ÅCH H√ÄNG\nKhi c√≥ th√¥ng tin kh√°ch h√†ng m·ªõi\n\n```json\n{\n  \"action\": \"save_customer\",\n  \"data\": {\n    \"name\": \"T√™n kh√°ch\",\n    \"phone\": \"SƒêT\",\n    \"address\": \"ƒê·ªãa ch·ªâ\",\n    \"email\": \"Email\"\n  }\n}\n```\n\n---\n\n# V√ç D·ª§ RESPONSE ƒê√öNG\n\n## V√≠ d·ª• 1: T·∫°o b√°o gi√°\nUser: \"T·∫°o b√°o gi√° cho kh√°ch Nguy·ªÖn VƒÉn A, 2 t·ªß qu·∫ßn √°o 3 c√°nh\"\n\nResponse:\nD·∫°, em ƒë√£ t√≠nh xong b√°o gi√° cho kh√°ch Nguy·ªÖn VƒÉn A. T·ªïng c·ªông l√† 15.125.000 VNƒê (ƒë√£ bao g·ªìm VAT 10%).\n\n```json\n{\n  \"action\": \"create_quote\",\n  \"data\": {\n    \"customerName\": \"Nguy·ªÖn VƒÉn A\",\n    \"customerPhone\": \"Ch∆∞a cung c·∫•p\",\n    \"customerAddress\": \"Ch∆∞a cung c·∫•p\",\n    \"items\": [\n      {\n        \"name\": \"T·ªß qu·∫ßn √°o 3 c√°nh\",\n        \"size\": \"1800 x 2200 x 600 mm\",\n        \"material\": \"G·ªó c√¥ng nghi·ªáp MDF\",\n        \"quantity\": 2,\n        \"unitPrice\": 5500000,\n        \"amount\": 11000000,\n        \"note\": \"\"\n      }\n    ],\n    \"subtotal\": 8800000,\n    \"profitPercent\": 25,\n    \"profit\": 2200000,\n    \"priceBeforeVAT\": 11000000,\n    \"vat\": 1100000,\n    \"totalAmount\": 12100000\n  }\n}\n```\n\n## V√≠ d·ª• 2: G·ª≠i l·∫°i PDF\nUser: \"G·ª≠i l·∫°i m·ªói pdf th√¥i\"\n\nResponse:\nƒê√¢y l√† file PDF b√°o gi√° BG-20251220-123: https://res.cloudinary.com/.../BG-20251220-123.pdf\n\n## V√≠ d·ª• 3: H·ªèi ƒë√°p\nUser: \"Gi√° g·ªó s·ªìi bao nhi√™u?\"\n\nResponse:\nD·∫°, gi√° g·ªó s·ªìi hi·ªán t·∫°i l√† 15.000.000 VNƒê/m3 ·∫°.\n\n---\n\n# L∆ØU √ù CU·ªêI\n- LU√îN d√πng Calculator khi t√≠nh to√°n\n- LU√îN ƒë√≠nh k√®m JSON khi t·∫°o b√°o gi√°\n- KH√îNG d√πng markdown trong text\n- JSON ph·∫£i ·ªü CU·ªêI C√ôNG response\n- S·ªë trong JSON l√† NUMBER (kh√¥ng c√≥ d·∫•u ch·∫•m)\n- S·ªë trong text l√† STRING (c√≥ d·∫•u ch·∫•m: 1.500.000)",
        "workflowId": {
          "__rl": true,
          "value": "2AKCYsUUcOUMdi4M",
          "mode": "list",
          "cachedResultUrl": "/workflow/2AKCYsUUcOUMdi4M",
          "cachedResultName": "Tro ly ke toan"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "prompt": "={{ $json.prompt }}",
            "type": "={{ $json.type }}",
            "content": "={{ $json.content }}",
            "metadata": "={{ $json.metadata }}",
            "imageUrl": "={{ $json.imageUrl }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "prompt",
              "displayName": "prompt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "type",
              "displayName": "type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "content",
              "displayName": "content",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "metadata",
              "displayName": "metadata",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "imageUrl",
              "displayName": "imageUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2080,
        3568
      ],
      "id": "3a6a9d73-e605-4c6f-9805-e0faa8b78490",
      "name": "Tro ly ke toan"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "ƒê√¢y l√† ·∫£nh gi?",
        "inputType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        -512,
        3072
      ],
      "id": "c041b9a6-883f-4edd-bbf0-c59429c30aa1",
      "name": "Analyze an image",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "dd907e87-49ce-4525-862c-54059820173b",
              "leftValue": "={{ $json.body.message.caption || $json.caption || '' }}",
              "rightValue": "ph√¢n t√≠ch",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "d22d6c30-11fb-4d49-a43a-ee458ac670f7",
              "leftValue": "={{ $json.body.message.caption || $json.caption || '' }}",
              "rightValue": "xem",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "7ce92bce-4a09-477f-905c-dccb07e5e129",
              "leftValue": "={{ $json.body.message.caption || $json.caption || '' }}",
              "rightValue": "ƒë·ªçc",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "f420f5d0-2c66-42b8-8647-6c342f306b59",
              "leftValue": "={{ $json.body.message.caption || $json.caption || '' }}",
              "rightValue": "analyze",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "e5b80510-f153-43cd-8cb7-5da472023b88",
              "leftValue": "={{ $json.body.message.caption || $json.caption || '' }}",
              "rightValue": "=m√¥ t·∫£",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "25a3e8c6-d7ae-4f20-8983-aee8a72e6449",
              "leftValue": "={{ $json.body.message.caption || $json.caption || '' }}",
              "rightValue": "l√† g√¨",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -784,
        3152
      ],
      "id": "ef663879-2e3d-4b31-8f63-1afe52e0513f",
      "name": "Check Caption Analyze"
    },
    {
      "parameters": {
        "url": "={{ $json.body.message.from.id }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -1216,
        3408
      ],
      "id": "3de2c744-c6cd-4f59-8ffe-ba0bc1e68697",
      "name": "Download Documents",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -1952,
        4208
      ],
      "id": "aeffdcfb-18d8-4248-ab0b-63355d0a9498",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "ivMQFozfvyKtTYit",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/setWebhook",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "url",
              "value": "https://n8n.minhkhoaagent.top/webhook/zalo-gateway-new"
            },
            {
              "name": "secret_token",
              "value": "agent123456"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2224,
        4176
      ],
      "id": "32b7bf58-4bb5-4d32-974c-96bc957b1ea9",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zapps.me/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.error }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -144,
        3712
      ],
      "id": "444bafa8-9cb4-4a76-b4ea-aa38be8221f0",
      "name": "Error Message"
    },
    {
      "parameters": {
        "description": "G·ªçi c√¥ng c·ª• n√†y khi s·∫øp D·∫†Y ki·∫øn th·ª©c m·ªõi, S·ª¨A SAI, ho·∫∑c b·∫£o GHI NH·ªö th√¥ng tin. \nV√≠ d·ª•: \"Nh·ªõ l√† gi√° g·ªó s·ªìi 15 tri·ªáu/m3\", \"Sai r·ªìi, ph·∫£i l√†...\", \"Ghi nh·ªõ kh√°ch A th√≠ch m√†u tr·∫Øng\"\nInput: N·ªôi dung c·∫ßn ghi nh·ªõ (text)",
        "workflowId": {
          "__rl": true,
          "value": "BKK33Pu7stWD1pR1",
          "mode": "list",
          "cachedResultUrl": "/workflow/BKK33Pu7stWD1pR1",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.query }}",
            "action": "search"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        2592,
        3568
      ],
      "id": "40cf7de4-a6f5-4a11-8099-7d311f92ee80",
      "name": "Save Knowledge (Write)"
    },
    {
      "parameters": {
        "model": "qwen/qwen3-32b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        1648,
        3568
      ],
      "id": "706cb8f7-c6d7-4861-936c-0305beb6d2b2",
      "name": "Groq Chat Model",
      "credentials": {
        "groqApi": {
          "id": "VkFyanoifIIhja6j",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. L·∫§Y D·ªÆ LI·ªÜU T·ª™ AGENT\nconst agentItem = $('Tro ly chinh').first().json;\nlet rawOutput = agentItem.output || \"\";\n\n// Clean text\nlet cleanOutput = rawOutput;\nif (cleanOutput) {\n    cleanOutput = cleanOutput.split('\\\\n').join(' ').split('\\n').join(' ');\n}\n\n// 2. KH·ªûI T·∫†O BI·∫æN\nlet imageUrl = '';\nlet pdfUrl = '';\nlet quoteNumber = '';\nlet responseMode = 'text';\n\n// 3. T√åM LINK\n// Regex t√¨m ·∫£nh\nconst imgRegex = /(https?:\\/\\/[^\\s\"<>)]+?\\.(?:png|jpg|jpeg|webp))/i;\nconst imgMatch = cleanOutput.match(imgRegex);\nif (imgMatch) imageUrl = imgMatch[0].trim();\n\n// Regex t√¨m PDF\nconst pdfRegex = /(https?:\\/\\/[^\\s\"<>)]+?\\.pdf)/i;\nconst pdfMatch = cleanOutput.match(pdfRegex);\nif (pdfMatch) pdfUrl = pdfMatch[0].trim();\n\n// Regex t√¨m M√£ b√°o gi√°\nconst qnRegex = /(BG-\\d{8}-\\d{3}|QT-\\d{8}-\\d{3})/i;\nconst qnMatch = cleanOutput.match(qnRegex);\nif (qnMatch) quoteNumber = qnMatch[0];\n\n// 4. X√ÅC ƒê·ªäNH CH·∫æ ƒê·ªò G·ª¨I - ∆ØU TI√äN THEO LINK T√åM ƒê∆Ø·ª¢C\nif (imageUrl && pdfUrl) {\n    responseMode = 'all';\n} else if (imageUrl) {\n    responseMode = 'image';\n} else if (pdfUrl) {\n    responseMode = 'pdf';\n} else {\n    responseMode = 'text';\n}\n\n// 5. L√ÄM S·∫†CH TIN NH·∫ÆN\nlet finalText = rawOutput;\n\n// X√≥a RESPONSE_TYPE n·∫øu c√≥\nfinalText = finalText.replace(/RESPONSE_TYPE:\\s*[\"']?[a-zA-Z_]+[\"']?/gi, '');\n\n// X√≥a link n·∫øu ƒë√£ g·ª≠i ri√™ng\nif (responseMode === 'all' || responseMode === 'image') {\n    if (imageUrl) finalText = finalText.replace(imageUrl, '');\n}\nif (responseMode === 'all' || responseMode === 'pdf') {\n    if (pdfUrl) finalText = finalText.replace(pdfUrl, '');\n}\n\n// X√≥a JSON block trong text (gi·ªØ text s·∫°ch)\nfinalText = finalText.replace(/```json[\\s\\S]*?```/gi, '');\nfinalText = finalText.replace(/\\{[\\s\\S]*?\"action\"[\\s\\S]*?\\}/gi, '');\n\n// Clean up\nfinalText = finalText.replace(/\\n\\s*\\n/g, '\\n').trim();\n\n// Log debug\nconsole.log('Image URL:', imageUrl);\nconsole.log('PDF URL:', pdfUrl);\nconsole.log('Response Mode:', responseMode);\n\nreturn [{\n    json: {\n        output: finalText,\n        imageUrl: imageUrl,\n        pdfUrl: pdfUrl,\n        quoteNumber: quoteNumber,\n        response_mode: responseMode\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3680,
        2880
      ],
      "id": "fad8c4ac-58b8-4ee0-a9ef-395f70aaaf39",
      "name": "Analyze and Get link",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendPhoto",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "photo",
              "value": "={{ $('Analyze and Get link').first().json.imageUrl }}"
            },
            {
              "name": "caption",
              "value": "=üìã B√°o gi√° {{ $('Analyze and Get link').first().json.quoteNumber }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4112,
        2720
      ],
      "id": "17c41fe9-609c-4d54-aea9-3150eec89d24",
      "name": "Send Photo",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-image",
              "leftValue": "={{ $json.imageUrl }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "check-mode",
              "leftValue": "={{ $json.response_mode }}",
              "rightValue": "pdf",
              "operator": {
                "type": "string",
                "operation": "notEquals",
                "name": "filter.operator.notEquals"
              }
            },
            {
              "id": "check-mode-text",
              "leftValue": "={{ $json.response_mode }}",
              "rightValue": "text",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3904,
        2880
      ],
      "id": "b9fd2f3c-fb5e-416e-a4c3-6c5822379fb3",
      "name": "Has Image?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-pdf",
              "leftValue": "={{ $('Analyze and Get link').first().json.pdfUrl }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "check-mode",
              "leftValue": "={{ $('Analyze and Get link').first().json.response_mode }}",
              "rightValue": "image",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            },
            {
              "id": "check-mode-text",
              "leftValue": "={{ $('Analyze and Get link').first().json.response_mode }}",
              "rightValue": "text",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4352,
        2880
      ],
      "id": "df96c524-bd70-4104-b468-4708e78ab138",
      "name": "Has PDF?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ 'üìÑ File PDF b√°o gi√° ' + $('Analyze and Get link').first().json.quoteNumber + ':\\n' + $('Analyze and Get link').first().json.pdfUrl }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4592,
        2720
      ],
      "id": "dfb74778-feb5-4a55-b68a-ef998f587e6d",
      "name": "Send PDF",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// 1. L·∫§Y D·ªÆ LI·ªÜU\nconst agentItem = $('Tro ly chinh').first().json;\nlet rawOutput = agentItem.output || \"\";\n\n// Clean text\nconst cleanOutput = rawOutput.replace(/\\\\n/g, ' ').replace(/\\n/g, ' ');\n\n// 2. T√åM LINK\nlet imageUrl = '';\nlet pdfUrl = '';\nlet quoteNumber = '';\n\n// B·∫Øt link ·∫£nh\nconst imgMatch = cleanOutput.match(/(https?:\\/\\/[^\\s\"<>)]+?\\.(?:png|jpg|jpeg|webp))/i);\nif (imgMatch) imageUrl = imgMatch[0].trim();\n\n// B·∫Øt link PDF\nconst pdfMatch = cleanOutput.match(/(https?:\\/\\/[^\\s\"<>)]+?\\.pdf)/i);\nif (pdfMatch) pdfUrl = pdfMatch[0].trim();\n\n// B·∫Øt M√£ b√°o gi√°\nconst qnMatch = cleanOutput.match(/(BG-\\d{8}-\\d{3})/i);\nif (qnMatch) quoteNumber = qnMatch[0];\n\n// 3. X√ÅC ƒê·ªäNH RESPONSE MODE\nlet responseMode = 'text';\nif (imageUrl && pdfUrl) responseMode = 'all';\nelse if (imageUrl) responseMode = 'image';\nelse if (pdfUrl) responseMode = 'pdf';\n\n// 4. T·∫†O TIN NH·∫ÆN S·∫†CH\nlet finalText = '';\n\n// N·∫øu c√≥ b√°o gi√° (c√≥ ·∫£nh ho·∫∑c PDF)\nif (responseMode !== 'text' && quoteNumber) {\n    // T√¨m t·ªïng ti·ªÅn trong output\n    const totalMatch = rawOutput.match(/(\\d{1,3}(?:\\.\\d{3})*(?:\\.\\d+)?)\\s*VN[ƒêD]/i);\n    const totalAmount = totalMatch ? totalMatch[1] : '';\n    \n    finalText = `S·∫øp ∆°i, em ƒë√£ t·∫°o b√°o gi√° ${quoteNumber} xong ·∫°!`;\n    \n    if (totalAmount) {\n        finalText += `\\nüí∞ T·ªïng c·ªông: ${totalAmount} VNƒê (ƒë√£ bao g·ªìm VAT 10%)`;\n    }\n    \n    if (pdfUrl) {\n        finalText += `\\n\\nüìÑ T·∫£i PDF: ${pdfUrl}`;\n    } else {\n        finalText += `\\n\\nN·∫øu c·∫ßn file PDF, s·∫øp b√°o em nh√©!`;\n    }\n} else {\n    // Kh√¥ng c√≥ b√°o gi√° - gi·ªØ nguy√™n text nh∆∞ng clean\n    finalText = rawOutput\n        .replace(/RESPONSE_TYPE:\\s*[\"']?[a-zA-Z_]+[\"']?/gi, '')\n        .replace(/```json[\\s\\S]*?```/gi, '')\n        .replace(/\\{[\\s\\S]*?\"action\"[\\s\\S]*?\\}/gi, '')\n        .replace(/Link ·∫£nh preview.*?:/gi, '')\n        .replace(/\\n\\s*\\n/g, '\\n')\n        .trim();\n    \n    // X√≥a link n·∫øu ƒë√£ g·ª≠i ·∫£nh ri√™ng\n    if (imageUrl) finalText = finalText.replace(imageUrl, '');\n    if (pdfUrl) finalText = finalText.replace(pdfUrl, '');\n}\n\n// Clean final\nfinalText = finalText.replace(/\\n\\s*\\n\\s*\\n/g, '\\n\\n').trim();\n\nreturn [{\n    json: {\n        output: finalText,\n        imageUrl: imageUrl,\n        pdfUrl: pdfUrl,\n        quoteNumber: quoteNumber,\n        response_mode: responseMode\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4832,
        2880
      ],
      "id": "7f2c56e4-bcb9-48e9-9da3-d1074df828de",
      "name": "Split Text"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.chat.id }}"
            },
            {
              "name": "text",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5056,
        2880
      ],
      "id": "96237535-26ab-45e4-9ccc-bcef4a80215b",
      "name": "Send Text"
    },
    {
      "parameters": {
        "jsCode": "// Get all items from input\nconst inputItems = $input.all();\n\nfor (let i = 0; i < inputItems.length; i++) {\n  const item = inputItems[i];\n  \n  // L·∫•y photo_url t·ª´ queue data\n  try {\n    const queueData = $('Convert Queue Data').first().json;\n    item.json.photo_url = queueData?.body?.message?.photo_url || '';\n  } catch (e) {\n    item.json.photo_url = '';\n  }\n\n  // Fix MIME type n·∫øu c·∫ßn\n  if (item.binary && item.binary.data) {\n    if (item.binary.data.mimeType === 'image/jpg') {\n      item.binary.data.mimeType = 'image/jpeg';\n      item.binary.data.fileExtension = 'jpeg';\n    }\n  }\n}\n\nreturn inputItems;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        3152
      ],
      "id": "b505d534-987f-44fe-ba3a-6a2dc326b64e",
      "name": "Fix Input Item",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://bot-api.zaloplatforms.com/bot3560693075024509922:IRydnWGAAtlekyTBevNhCHkSOOsuCWvBMphBNeSurWcpTbkMgRSRTpvKJbWMWbYX/sendChatAction",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "chat_id",
              "value": "={{ $json.body.message.from.id }}"
            },
            {
              "name": "action",
              "value": "typing"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3120,
        2880
      ],
      "id": "07b9f51e-058f-4996-b709-9717074033ac",
      "name": "Send Processing Message2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -1792,
        4208
      ],
      "id": "3cc11af4-a16a-4b68-b184-1a2d6da9077f",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "ZeYl5rYP7Kr1YqY6",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge knowledge context v√†o input cho Workflow ch√≠nh\nconst prepareData = $('Prepare Smart Search').first().json;\nconst originalInput = prepareData.originalInput;\n\n// 1. RAG Results\nlet ragContext = '';\ntry {\n  const searchResult = $('Search Knowledge').first().json;\n  if (searchResult && searchResult.success && searchResult.results && searchResult.results.length > 0) {\n    ragContext = searchResult.results\n      .map(r => `‚Ä¢ [${r.category}] ${r.content}`)\n      .join('\\n');\n  }\n} catch (e) {\n  ragContext = '';\n}\n\n// 2. Tavily Results (n·∫øu c√≥)\nlet webContext = '';\ntry {\n  if (prepareData.needWebSearch) {\n    const tavilyResult = $('Search Tavily').first().json;\n    if (tavilyResult && tavilyResult.answer) {\n      webContext = `T√≥m t·∫Øt: ${tavilyResult.answer}\\n`;\n    }\n    if (tavilyResult && tavilyResult.results && tavilyResult.results.length > 0) {\n      webContext += tavilyResult.results\n        .slice(0, 3)\n        .map(r => `‚Ä¢ ${r.title}: ${r.content.substring(0, 200)}...`)\n        .join('\\n');\n    }\n  }\n} catch (e) {\n  webContext = '';\n}\n\n// 3. Build context\nlet learningContext = '';\n\nif (ragContext) {\n  learningContext += `\n=== KI·∫æN TH·ª®C ƒê√É H·ªåC ===\n${ragContext}\n========================\n`;\n}\n\nif (webContext) {\n  learningContext += `\n=== TH√îNG TIN T·ª™ WEB ===\n${webContext}\n========================\n`;\n}\n\nreturn [{\n  json: {\n    ...originalInput,\n    learningContext: learningContext,\n    hasLearning: ragContext !== '' || webContext !== ''\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1616,
        2976
      ],
      "id": "e43724e1-b0ec-4da2-b257-06617ae5b58e",
      "name": "Merge Context"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "r4F4YVmXVwKOH0Ne",
          "mode": "list",
          "cachedResultUrl": "/workflow/r4F4YVmXVwKOH0Ne",
          "cachedResultName": "RAG Knowledge - Pinecone"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.ragQuery || $json.content || $json.prompt || '' }}",
            "action": "search"
          },
          "matchingColumns": [
            "query"
          ],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        560,
        2976
      ],
      "id": "ba6d966b-454c-4855-9304-f4ba46b91614",
      "name": "Search Knowledge"
    },
    {
      "parameters": {
        "jsCode": "// Chu·∫©n b·ªã search t·ª´ nhi·ªÅu ngu·ªìn cho Workflow ch√≠nh\nconst input = $input.first().json;\n\n// L·∫•y query t·ª´ nhi·ªÅu ngu·ªìn c√≥ th·ªÉ\nconst query = input.content || input.prompt || input.text || '';\nconst queryLower = query.toLowerCase();\n\n// Ph√¢n t√≠ch intent - c√≥ c·∫ßn web search kh√¥ng?\nlet needWebSearch = false;\nlet webSearchQuery = '';\nlet searchType = 'general';\n\nif (queryLower.includes('gi√° th·ªã tr∆∞·ªùng') || queryLower.includes('gi√° hi·ªán t·∫°i') || \n    queryLower.includes('xu h∆∞·ªõng') || queryLower.includes('m·ªõi nh·∫•t') ||\n    queryLower.includes('tin t·ª©c') || queryLower.includes('th·ªùi s·ª±')) {\n  needWebSearch = true;\n  webSearchQuery = query + ' Vi·ªát Nam 2025';\n  searchType = 'market_info';\n}\n\nif (queryLower.includes('ƒë·ªëi th·ªß') || queryLower.includes('th·ªã tr∆∞·ªùng') ||\n    queryLower.includes('so s√°nh')) {\n  needWebSearch = true;\n  webSearchQuery = query + ' n·ªôi th·∫•t Vi·ªát Nam';\n  searchType = 'competitor';\n}\n\nreturn [{\n  json: {\n    originalInput: input,\n    ragQuery: query,\n    needWebSearch: needWebSearch,\n    webSearchQuery: webSearchQuery,\n    searchType: searchType\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        336,
        2976
      ],
      "id": "79fec34a-c49b-4903-ba65-5ea22303149f",
      "name": "Prepare Smart Search"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "06b6aed4-daf6-46d1-a841-394b9ffde6ea",
              "leftValue": "={{ $('Search Knowledge').item.json.needWebSearch }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        768,
        2976
      ],
      "id": "51226af9-e213-4208-92f2-94be2c47aa5e",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// Detect knowledge m·ªõi c·∫ßn h·ªçc\nlet agentOutput = '';\nlet userInput = '';\n\ntry {\n  agentOutput = $('Tro ly chinh').first().json.output || '';\n} catch (e) {\n  agentOutput = '';\n}\n\ntry {\n  userInput = $('Input').first().json.content || \n              $('Input').first().json.prompt || \n              $('Convert Queue Data').first().json.body?.message?.text || '';\n} catch (e) {\n  userInput = '';\n}\n\n// Patterns c·∫ßn h·ªçc\nconst learnPatterns = [\n  { pattern: /nh·ªõ (l√†|r·∫±ng|nh√©)/i, category: 'knowledge' },\n  { pattern: /ghi nh·ªõ/i, category: 'knowledge' },\n  { pattern: /t·ª´ (gi·ªù|nay)/i, category: 'preference' },\n  { pattern: /quy ƒë·ªãnh (m·ªõi|l√†)/i, category: 'process' },\n  { pattern: /sai r·ªìi.*(ƒë√∫ng l√†|ph·∫£i l√†)/i, category: 'correction' },\n  { pattern: /kh√¥ng ph·∫£i.*(m√† l√†|l√†)/i, category: 'correction' }\n];\n\nlet shouldLearn = false;\nlet category = 'general';\nlet contentToLearn = userInput;\n\nfor (const item of learnPatterns) {\n  if (item.pattern.test(userInput)) {\n    shouldLearn = true;\n    category = item.category;\n    break;\n  }\n}\n\n// N·∫øu agent x√°c nh·∫≠n ƒë√£ h·ªçc\nif (agentOutput.toLowerCase().includes('ƒë√£ ghi nh·ªõ') || \n    agentOutput.toLowerCase().includes('em nh·ªõ r·ªìi')) {\n  shouldLearn = true;\n}\n\nreturn [{\n  json: {\n    shouldLearn: shouldLearn,\n    contentToLearn: contentToLearn,\n    category: category\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        2880
      ],
      "id": "0df5d5af-323b-42e1-bd30-eac661c2dbe9",
      "name": "Detect New Knowledge"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cbc74e48-ef2f-455d-8326-3aa17e03042c",
              "leftValue": "={{ $json.shouldLearn }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        2656,
        2880
      ],
      "id": "b328ba1c-5b2e-4cee-8b92-278593f7a5ff",
      "name": "If Should Learn"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "x2L5rQZ1DPGBD6zJ",
          "mode": "list",
          "cachedResultUrl": "/workflow/x2L5rQZ1DPGBD6zJ",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.query }}",
            "action": "save",
            "category": "={{ $json.category }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        2880,
        2784
      ],
      "id": "e50855ec-d044-41c7-a8b6-5261dc26a5c7",
      "name": "Execute Save to RAG"
    },
    {
      "parameters": {
        "query": "={{ $('Prepare Smart Search').item.json.webSearchQuery }}",
        "options": {
          "search_depth": "basic",
          "max_results": 5,
          "include_answer": "advanced"
        }
      },
      "type": "@tavily/n8n-nodes-tavily.tavily",
      "typeVersion": 1,
      "position": [
        976,
        2880
      ],
      "id": "17917473-17ea-434f-871c-c6ed7240d05b",
      "name": "Search Tavily",
      "credentials": {
        "tavilyApi": {
          "id": "pY0x9kpc8XPIIprO",
          "name": "Tavily account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const queryHash = prepareData.webSearchQuery\n  .toLowerCase()\n  .replace(/[^a-z0-9]/g, '')\n  .substring(0, 50);\n\n// Th√™m v√†o return\nreturn [{\n  json: {\n    shouldSave: shouldSave,\n    contentToSave: contentToSave,\n    category: category,\n    queryHash: queryHash,  // D√πng ƒë·ªÉ check tr√πng sau n√†y\n    originalQuery: prepareData.webSearchQuery,\n    answerLength: tavilyResult?.answer?.length || 0\n  }\n}];\n\n// Ki·ªÉm tra ch·∫•t l∆∞·ª£ng k·∫øt qu·∫£ Tavily ƒë·ªÉ quy·∫øt ƒë·ªãnh c√≥ l∆∞u kh√¥ng\nconst tavilyResult = $input.first().json;\nconst prepareData = $('Prepare Smart Search').first().json;\n\nlet shouldSave = false;\nlet contentToSave = '';\nlet category = 'market_info';\n\n// Ki·ªÉm tra c√≥ answer ch·∫•t l∆∞·ª£ng kh√¥ng\nif (tavilyResult && tavilyResult.answer && tavilyResult.answer.length > 100) {\n  shouldSave = true;\n  \n  // T·∫°o content c√≥ c·∫•u tr√∫c ƒë·ªÉ l∆∞u\n  const timestamp = new Date().toISOString().slice(0, 10);\n  contentToSave = `[WEB ${timestamp}] ${prepareData.webSearchQuery}: ${tavilyResult.answer}`;\n  \n  // Ph√¢n lo·∫°i category d·ª±a tr√™n query\n  const queryLower = prepareData.webSearchQuery.toLowerCase();\n  if (queryLower.includes('gi√°') || queryLower.includes('chi ph√≠')) {\n    category = 'market_price';\n  } else if (queryLower.includes('xu h∆∞·ªõng') || queryLower.includes('trend')) {\n    category = 'market_trend';\n  } else if (queryLower.includes('ƒë·ªëi th·ªß') || queryLower.includes('c·∫°nh tranh')) {\n    category = 'competitor';\n  } else {\n    category = 'market_info';\n  }\n}\n\n// Kh√¥ng l∆∞u n·∫øu k·∫øt qu·∫£ qu√° ng·∫Øn ho·∫∑c kh√¥ng c√≥ answer\nif (tavilyResult.answer && tavilyResult.answer.length < 50) {\n  shouldSave = false;\n}\n\nreturn [{\n  json: {\n    shouldSave: shouldSave,\n    contentToSave: contentToSave,\n    category: category,\n    originalQuery: prepareData.webSearchQuery,\n    answerLength: tavilyResult?.answer?.length || 0\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1184,
        2880
      ],
      "id": "b15ef08a-c293-45e0-aae8-57c755834d64",
      "name": "Check Tavily Quality"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "c5512534-5da6-4804-ba93-2cd832aff8a4",
              "leftValue": "={{ $json.shouldSave }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1392,
        2880
      ],
      "id": "1ac45c1b-e0f8-4e01-b7ad-b67e5897129d",
      "name": "If Good Result"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "x2L5rQZ1DPGBD6zJ",
          "mode": "list",
          "cachedResultUrl": "/workflow/x2L5rQZ1DPGBD6zJ",
          "cachedResultName": "Tool - RAG Knowledge"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "query": "={{ $json.contentToSave }}",
            "action": "save",
            "category": "={{ $json.category }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "query",
              "displayName": "query",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "action",
              "displayName": "action",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        1616,
        2784
      ],
      "id": "619e8a03-1d55-4d8a-80e8-35d50050283d",
      "name": "Auto Save Web Knowledge"
    },
    {
      "parameters": {
        "jsCode": "const saveResult = $input.first().json;\n\nconsole.log('=== AUTO SAVE WEB KNOWLEDGE ===');\nconsole.log('Saved:', saveResult.success ? 'YES' : 'NO');\nconsole.log('Content:', saveResult.message || 'N/A');\n\nreturn [{ json: { logged: true } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1824,
        2784
      ],
      "id": "b1e900f6-6579-4410-b278-28b306024519",
      "name": "Log Save Result"
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "T√¨m ki·∫øm th√¥ng tin M·ªöI NH·∫§T tr√™n internet. S·ª≠ d·ª•ng khi:\n- S·∫øp h·ªèi gi√° th·ªã tr∆∞·ªùng, gi√° ngo√†i, gi√° hi·ªán t·∫°i\n- C·∫ßn th√¥ng tin ƒë·ªëi th·ªß c·∫°nh tranh\n- C·∫ßn xu h∆∞·ªõng n·ªôi th·∫•t m·ªõi nh·∫•t\n- C·∫ßn tin t·ª©c ng√†nh\n- C·∫ßn th√¥ng tin c√¥ng ty ho·∫∑c kh√°ch h√†ng\n- B·∫•t k·ª≥ th√¥ng tin n√†o c·∫ßn c·∫≠p nh·∫≠t real-time\n\nKH√îNG d√πng cho gi√° c·ªßa x∆∞·ªüng MinhKhoa, d√πng ki·∫øn th·ª©c ƒë√£ h·ªçc thay th·∫ø.",
        "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query', ``, 'string') }}",
        "options": {
          "search_depth": "advanced",
          "max_results": 5,
          "include_answer": "advanced"
        }
      },
      "type": "@tavily/n8n-nodes-tavily.tavilyTool",
      "typeVersion": 1,
      "position": [
        2752,
        3568
      ],
      "id": "45c1a32f-9326-4caa-8a61-4bf4bc1f5d5d",
      "name": "Search in Tavily",
      "credentials": {
        "tavilyApi": {
          "id": "pY0x9kpc8XPIIprO",
          "name": "Tavily account"
        }
      }
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://zamexodnbxgmazdnajtd.supabase.co/rest/v1/message_buffer",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbWV4b2RuYnhnbWF6ZG5hanRkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjU5ODM1MiwiZXhwIjoyMDgyMTc0MzUyfQ.mAC3J7FD9ZY3RJL3hf7QSly_QoelpVmhERIe0NPnQHA"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InphbWV4b2RuYnhnbWF6ZG5hanRkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjU5ODM1MiwiZXhwIjoyMDgyMTc0MzUyfQ.mAC3J7FD9ZY3RJL3hf7QSly_QoelpVmhERIe0NPnQHA"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"status\": \"completed\",\n  \"completed_at\": {{ JSON.stringify($now.toISO()) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5280,
        2880
      ],
      "id": "5ff6406e-add8-4b67-bc7b-77c105f0a61f",
      "name": "Mark Completed"
    }
  ],
  "pinData": {},
  "connections": {
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "MongoDB Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Clean Up": {
      "main": [
        [
          {
            "node": "Agent Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Download Voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Download Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input": {
      "main": [
        [
          {
            "node": "Prepare Smart Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly Email": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly chinh": {
      "main": [
        [
          {
            "node": "Detect New Knowledge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly lich": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly ky thuat": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If File Size < 20MB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If File Size < 20MB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze document": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If File Size < 20MB": {
      "main": [
        [
          {
            "node": "CAD to PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CAD to PDF": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Get Pending Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Pending Message": {
      "main": [
        [
          {
            "node": "Has message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has message?": {
      "main": [
        [
          {
            "node": "Lock message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lock message": {
      "main": [
        [
          {
            "node": "Convert Queue Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert Queue Data": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Image": {
      "main": [
        [
          {
            "node": "Fix Input Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Voice": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agent Log": {
      "main": [
        [
          {
            "node": "Analyze and Get link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tro ly ke toan": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Analyze an image": {
      "main": [
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Caption Analyze": {
      "main": [
        [
          {
            "node": "Analyze an image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Documents": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Knowledge (Write)": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Analyze and Get link": {
      "main": [
        [
          {
            "node": "Has Image?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Photo": {
      "main": [
        [
          {
            "node": "Has PDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Image?": {
      "main": [
        [
          {
            "node": "Send Photo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Has PDF?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has PDF?": {
      "main": [
        [
          {
            "node": "Send PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Split Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send PDF": {
      "main": [
        [
          {
            "node": "Split Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Text": {
      "main": [
        [
          {
            "node": "Send Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Input Item": {
      "main": [
        [
          {
            "node": "Check Caption Analyze",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Processing Message2": {
      "main": [
        [
          {
            "node": "Clean Up",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Context": {
      "main": [
        [
          {
            "node": "Tro ly chinh",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Knowledge": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Smart Search": {
      "main": [
        [
          {
            "node": "Search Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Search Tavily",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detect New Knowledge": {
      "main": [
        [
          {
            "node": "If Should Learn",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Should Learn": {
      "main": [
        [
          {
            "node": "Execute Save to RAG",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Processing Message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Save to RAG": {
      "main": [
        [
          {
            "node": "Send Processing Message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search Tavily": {
      "main": [
        [
          {
            "node": "Check Tavily Quality",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Tavily Quality": {
      "main": [
        [
          {
            "node": "If Good Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Good Result": {
      "main": [
        [
          {
            "node": "Auto Save Web Knowledge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto Save Web Knowledge": {
      "main": [
        [
          {
            "node": "Log Save Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Save Result": {
      "main": [
        [
          {
            "node": "Agent Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search in Tavily": {
      "ai_tool": [
        [
          {
            "node": "Tro ly chinh",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Send Text": {
      "main": [
        [
          {
            "node": "Mark Completed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Message1": {
      "main": [
        [
          {
            "node": "Mark Completed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Message": {
      "main": [
        [
          {
            "node": "Mark Completed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3598228d-2acc-4132-b3a3-c6a78c781764",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f79905368cdd8aefd97993159c6f1b332d2bef60e6af085cda589aa3db810691"
  },
  "id": "frCGAUJ64i1bm8bB",
  "tags": []
}